<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta content="Radosław Miernik" name="author"><meta content="Have you heard of fast paths? If not, this post is one to learn more about them." name="description"><meta content="width=device-width,initial-scale=1.0" name="viewport"><link href="https://radekmie.dev/atom.xml" rel="alternate" type="application/atom+xml"><link href="https://radekmie.dev/blog/on-fast-paths/" rel="canonical"><link href="https://radekmie.dev/favicon.ico" rel="icon" type="image/x-icon"><link href="https://github.com/radekmie" rel="me"><link href="https://webmention.io/radekmie.dev/xmlrpc" rel="pingback"><link as="font" crossorigin="" href="https://radekmie.dev/fonts/CascadiaCode.woff2" rel="preload" type="font/woff2"><link as="font" crossorigin="" href="https://radekmie.dev/fonts/Lato-Bold.woff2" rel="preload" type="font/woff2"><link as="font" crossorigin="" href="https://radekmie.dev/fonts/Lato-Italic.woff2" rel="preload" type="font/woff2"><link as="font" crossorigin="" href="https://radekmie.dev/fonts/Lato-Regular.woff2" rel="preload" type="font/woff2"><link href="https://radekmie.dev/sitemap.xml" rel="sitemap" type="application/xml"><link href="https://radekmie.dev/index.css" rel="stylesheet"><link href="https://webmention.io/radekmie.dev/webmention" rel="webmention"><title>On Fast Paths · @radekmie’s take on IT and stuff</title></head><body><header class="flex split"><a href="https://radekmie.dev/"><code>@radekmie</code></a><nav><a href="https://radekmie.dev/about/">About</a> · <a href="https://radekmie.dev/blog/">Blog</a> · <a rel="noopener nofollow" href="https://github.com/radekmie" target="_blank">GitHub</a> · <a href="https://radekmie.dev/atom.xml">RSS</a> · <a href="https://radekmie.dev/timeline/">Timeline</a></nav></header><h1 id="on-fast-paths"><a aria-hidden="true" href="#on-fast-paths"></a>On Fast Paths</h1><p>By <a href="https://radekmie.dev/about/">Radosław Miernik</a> · Published on <time datetime="2024-12-30">30 December 2024</time></p><h2 id="table-of-contents"><a aria-hidden="true" href="#table-of-contents"></a>Table of contents</h2><ul><li><a href="https://radekmie.dev/blog/on-fast-paths/#intro">Intro</a></li><li><a href="https://radekmie.dev/blog/on-fast-paths/#in-the-wild">In the wild</a></li><li><a href="https://radekmie.dev/blog/on-fast-paths/#and-at-home">And at home</a></li><li><a href="https://radekmie.dev/blog/on-fast-paths/#closing-thoughts">Closing thoughts</a></li></ul><h2 id="intro"><a aria-hidden="true" href="#intro"></a>Intro</h2><p>Planning, testing, peer-reviewing, or even formal proofs; in a way, it all boils down to making sure whether the piece of code we just created covers <em>all</em> the cases we need. We often start with a simpler alternative, which covers <em>most</em> of them (or even only <em>some</em>), as it allows us to bring something to our customers earlier. Huh, that’s basically how startups work.</p><p>But then a flood of edge cases come from all directions – these pesky inputs that make our well-designed and efficient solution… The complete opposite. <em>“It’s just one more case, it’ll take a couple of hours, like the previous one, right?”</em> Well, not this time – this one was one too many.</p><p>But let’s pull through this hot mess and assume you covered <em>all</em> of them. This unveils a new kind of issues: in some cases, this entire machinery runs <em>forever</em>. <em>“Why is it taking ten seconds to load this one document? It’s just one document!”</em> In such a case, <em>“Because it can load ten thousand documents at all.”</em> is a reasonable, but not an expected answer – it makes sense for someone technical, but it isn’t the best slogan for boosting sales.</p><p>Did you really think you were the only one who did that?</p><h2 id="in-the-wild"><a aria-hidden="true" href="#in-the-wild"></a>In the wild</h2><p>If we <a href="https://github.com/search?q=repo%3Anodejs%2Fnode+%22fast+path%22&amp;type=code" rel="noopener nofollow" target="_blank">search for <code>"fast path"</code> in the Node.js repo</a>, we’ll get almost 200 code results. One of them is an “almost entirely C++” case for <code>writeFileSync</code> using the UTF-8 encoding, added in <a rel="noopener nofollow" href="https://github.com/nodejs/node/pull/49884" target="_blank">nodejs/node#49884</a>. These 96 lines of code (and 60 lines of tests) make the arguably most common case for <code>writeFileSync</code> up to 2.5x faster! In fact, it was so beneficial it <a rel="noopener nofollow" href="https://github.com/nodejs/node/blob/v21.3.0/doc/changelogs/CHANGELOG_V21.md#fast-fswritefilesync-with-utf-8-strings" target="_blank">made it to the v21.3.0 changelog</a>.</p><p><a href="https://github.com/search?q=repo%3Adotnet%2Fruntime+%22fast+path%22&amp;type=code" rel="noopener nofollow" target="_blank">A similar search in the .NET runtime</a> results in nearly 190 hits. A rather recent change, <a rel="noopener nofollow" href="https://github.com/dotnet/runtime/pull/103733" target="_blank"><code>dotnet/runtime#103733</code></a> <em>(landed in .NET 9.0<sup class="footnote-reference"><a href="#dotnet-performance-improvements">1</a></sup>)</em> was about reworking the <code>JsonNode</code> and <code>JsonValue</code>, so that the most common case is not slowed down by some niche feature. As a result, <code>DeepEquals</code> got over 10x faster and is no longer allocating any memory. However, this time the PR was much larger.</p><p>Of course, fast paths are not limited to language runtimes – <a href="https://github.com/search?q=repo%3Amongodb%2Fmongo%20%22fast%20path%22&amp;type=code" rel="noopener nofollow" target="_blank">MongoDB has nearly 50 of them</a>. The most popular one, <a rel="noopener nofollow" href="https://github.com/mongodb/mongo/blob/r8.0.4/src/mongo/db/exec/idhack.h#L52-L57" target="_blank"><code>IDHACK</code></a>, is a dedicated query plan for <code>_id</code> queries. It’s hard to estimate the performance benefit of it, but looking at the <a rel="noopener nofollow" href="https://github.com/mongodb/mongo/blob/r8.0.4/src/mongo/db/exec/index_scan.cpp#L174-L296" target="_blank">general <code>IXSCAN</code> implementation</a>, <a rel="noopener nofollow" href="https://github.com/mongodb/mongo/blob/r8.0.4/src/mongo/db/exec/idhack.cpp#L87-L141" target="_blank"><code>IDHACK</code></a> has much less work to do.</p><p>One more benefit of some fast paths could be a simpler mental model. <a rel="noopener nofollow" href="https://github.com/facebook/react/blob/97d794958f5b19b66a980f737facd890463f0cb8/packages/react-reconciler/src/ReactChildFiber.js#L1203-L1233" target="_blank">This piece of React’s reconciler</a> <em>(a core part of the virtual DOM implementation)</em> is very similar to its <a rel="noopener nofollow" href="https://github.com/Freak613/domc/blob/ae51949791de6bceb7e35545d759b681c2182f03/vFor.js#L52-L60" target="_blank">much simpler alternative</a>, <a rel="noopener nofollow" href="https://github.com/Freak613/domc/tree/ae51949791de6bceb7e35545d759b681c2182f03" target="_blank"><code>domc</code></a>. I never seen the latter library before, but it feels <em>natural</em> to me to have a dedicated path in such a code. Even <a rel="noopener nofollow" href="https://github.com/sveltejs/svelte/blob/7f8acb8a3705e1c9612f0d56e3a94596f0db1ef3/packages/svelte/src/internal/client/dom/blocks/each.js#L78-L89" target="_blank">Svelte does the same for removal</a>.</p><h2 id="and-at-home"><a aria-hidden="true" href="#and-at-home"></a>And at home</h2><p>I spent some time optimizing rendering for low-end devices, like that cheap Android tablet from your local supermarket<sup class="footnote-reference"><a href="#tablets-and-bread">2</a></sup>. It wasn’t easy, as <em>everything</em> was terribly slow in there, and nothing stood out in particular. Among the smaller things, I found this small function:</p><pre class="z-code"><code><span class="z-source z-ts"><span class="z-meta z-function z-ts"><span class="z-keyword z-control z-export z-ts">export</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">formatTime</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-variable z-parameter z-ts">millis</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">number</span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span> <span class="z-variable z-parameter z-ts">format</span> <span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">'</span>HH:mm<span class="z-punctuation z-definition z-string z-end z-ts">'</span></span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-function z-ts"><span class="z-meta z-block z-ts">  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">hour</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-support z-constant z-math z-ts">Math</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-math z-ts">floor</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">millis</span> <span class="z-keyword z-operator z-arithmetic z-ts">/</span> <span class="z-constant z-numeric z-decimal z-ts">3600000</span><span class="z-meta z-brace z-round z-ts">)</span> <span class="z-keyword z-operator z-arithmetic z-ts">%</span> <span class="z-constant z-numeric z-decimal z-ts">24</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-function z-ts"><span class="z-meta z-block z-ts">  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">minute</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-support z-constant z-math z-ts">Math</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-math z-ts">floor</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">millis</span> <span class="z-keyword z-operator z-arithmetic z-ts">%</span> <span class="z-constant z-numeric z-decimal z-ts">3600000</span><span class="z-meta z-brace z-round z-ts">)</span> <span class="z-keyword z-operator z-arithmetic z-ts">/</span> <span class="z-constant z-numeric z-decimal z-ts">60000</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-function z-ts"><span class="z-meta z-block z-ts">  <span class="z-keyword z-control z-flow z-ts">return</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">moment</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-objectliteral z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-meta z-object z-member z-ts"><span class="z-variable z-other z-readwrite z-ts">hour</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-meta z-object z-member z-ts"><span class="z-variable z-other z-readwrite z-ts">minute</span> </span><span class="z-punctuation z-definition z-block z-ts">}</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-meta z-function-call z-ts"><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">format</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">format</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
</span></span></span><span class="z-source z-ts"><span class="z-meta z-function z-ts"><span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">}</span></span></span>
</span></code></pre><p>It’s perfectly valid, though if you ever worked with <a rel="noopener nofollow" href="https://momentjs.com" target="_blank">Moment.js</a> <em>(yes, I know it’s no longer maintained)</em>, you’re most likely aware of its performance. It <em>is</em> an overkill, but it’s easy to understand and covers all interesting cases – 12/24h with(out) leading zeroes. And don’t worry about timezones, we only call it with <code>millis</code> representing “time since midnight”.</p><p>Now, calling it 10k times with no specified format (so using the default <code>HH:mm</code>) takes 31ms in Safari, and 16ms in Chrome, on my M2 MacBook Air. Is anyone using a different format? From what I checked, it’s less than 0.1% of all users… So let’s add a fast path:</p><pre class="language-diff z-code" data-lang="diff"><code class="language-diff" data-lang="diff"><span class="z-source z-diff"> export function formatTime(millis: number, format = 'HH:mm') {
</span><span class="z-source z-diff">   const hour = Math.floor((millis / 3600000) % 24);
</span><span class="z-source z-diff">   const minute = Math.floor((millis % 3600000) / 60000);
</span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>  // Fast-path for the most common format.
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>  if (format === 'HH:mm') {
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>    return `${hour &lt; 10 ? '0' : ''}${hour}:${minute &lt; 10 ? '0' : ''}${minute}`;
</span></span><span class="z-source z-diff"><span class="z-markup z-inserted z-diff"><span class="z-punctuation z-definition z-inserted z-diff">+</span>  }
</span></span><span class="z-source z-diff">   return moment({ hour, minute }).format(format);
</span><span class="z-source z-diff"> }
</span></code></pre><p>Is it better? 0.23ms in Safari (134x faster) and 0.38ms in Chrome (42x faster). I’d go for it any day – it’s a trivial change that doesn’t make the code far more complex. Of course, you should add tests for that as well!</p><h2 id="closing-thoughts"><a aria-hidden="true" href="#closing-thoughts"></a>Closing thoughts</h2><p>While the performance improvements are at least tempting, are there any downsides? Increased complexity is for sure one. It varies from one <code>if</code> to a whole redesign just to make it possible. In some cases it’s simply not worth it.</p><p>One function done, twenty more to go…</p><div class="footnote-definition" id="dotnet-performance-improvements"><sup class="footnote-definition-label">1</sup><p>If you’re even remotely interested in programming language implementation, <abbr title="Just In Time">JIT</abbr> compilation, or simply enjoy reading about performance optimizations, I highly recommend reading the <a rel="noopener nofollow" href="https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-9/" target="_blank"><em>Performance improvements in .NET 9</em></a> as well as the posts about the previous versions. They’re <em>massive</em> and take forever to go through, but the inspiration they fill you with is worth it.</p></div><div class="footnote-definition" id="tablets-and-bread"><sup class="footnote-definition-label">2</sup><p>Isn’t it crazy that you can buy bread and hardware at the same store? Like, I’m putting a bag of onions to my cart next to someone deciding on their printer.</p></div><footer class="flex split"><a class="prev" href="https://radekmie.dev/blog/on-histograms-in-decision-making/">On Histograms in Decision Making</a></footer><script type="text/javascript" src="https://logs.radekmie.dev/static/recorder.js?v=1.16.3"></script><script type="text/javascript" async="" src="https://logs.radekmie.dev/static/array.js"></script><script>var t,e,o,p,i,n;t=document,(e=window.posthog||[]).__SV||(window.posthog=e,e._i=[],e.init=((a,b,c)=>{let h=0,j=1,l=`posthog`,k=`script`,g=`.`;var d=((a,b)=>{var c=b.split(g);2==c.length&&(a=a[c[h]],b=c[j]),a[b]=function(){a.push([b].concat(Array.prototype.slice.call(arguments,h)))}});(i=t.createElement(k)).type=`text/javascript`,i.async=!h,i.src=b.api_host+ `/static/array.js`,(n=t.getElementsByTagName(k)[h]).parentNode.insertBefore(i,n);var f=e;for(void h!==c?(f=e[c]=[]):(c=l),f.people=f.people||[],f.toString=(a=>{var b=l;return l!==c&&(b+=g+ c),a||(b+=` (stub)`),b}),f.people.toString=(()=>f.toString(j)+ `.people (stub)`),o=`capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags`.split(` `),p=h;p<o.length;p++)d(f,o[p]);e._i.push([a,b,c])}),e.__SV=1),posthog.init(`hl3-CYeQK1NUbDqMKHkgRMw0yG9bdSPDHa7yKfsxAuQ`,{api_host:`https://logs.radekmie.dev`,cross_subdomain_cookie:!1})</script></body></html>