<!DOCTYPE html><html lang="en-us" dir="ltr"><head><script async="" src="https://snap.licdn.com/li.lms-analytics/insight.old.min.js"></script><script type="text/javascript" async="" src="//munchkin.marketo.net/163/munchkin.js"></script><script type="text/javascript" async="" src="https://snap.licdn.com/li.lms-analytics/insight.min.js"></script><script async="" src="https://scout-cdn.salesloft.com/sl.js"></script><script async="" src="https://www.googletagmanager.com/gtm.js?id=GTM-NDGPDFZ"></script><script defer="" referrerpolicy="origin" src="/static/z/s.js?z=JTdCJTIyZXhlY3V0ZWQlMjIlM0ElNUIlNUQlMkMlMjJ0JTIyJTNBJTIyT3BlbiUyMHNvdXJjaW5nJTIwaDNpJTNBJTIwYSUyMGNvbW1hbmQlMjBsaW5lJTIwdG9vbCUyMGFuZCUyMGxpYnJhcnklMjBmb3IlMjBsb3ctbGV2ZWwlMjBIVFRQJTJGMyUyMHRlc3RpbmclMjBhbmQlMjBkZWJ1Z2dpbmclMjIlMkMlMjJ4JTIyJTNBMC44MjE2NDI0MDE0MzYxNzYxJTJDJTIydyUyMiUzQTE5MjAlMkMlMjJoJTIyJTNBMTA4MCUyQyUyMmolMjIlM0ExMDgwJTJDJTIyZSUyMiUzQTE5MjAlMkMlMjJsJTIyJTNBJTIyaHR0cHMlM0ElMkYlMkZibG9nLmNsb3VkZmxhcmUuY29tJTJGaDNpJTJGJTIyJTJDJTIyciUyMiUzQSUyMiUyMiUyQyUyMmslMjIlM0EyNCUyQyUyMm4lMjIlM0ElMjJVVEYtOCUyMiUyQyUyMm8lMjIlM0EwJTJDJTIycSUyMiUzQSU1QiU1RCU3RA=="></script><script async="" src="https://ot.www.cloudflare.com/public/vendor/onetrust/scripttemplates/otSDKStub.js" data-document-language="true" type="text/javascript" data-domain-script="b1e05d49-f072-4bae-9116-bdb78af15448"></script><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="KeThzeyMOr"><meta name="baidu-site-verification" content="code-NIlrS7gNhx"><meta charset="UTF-8"><meta name="description" content="h3i is a command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC. Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes."><title>Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging</title><meta name="title" content="Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging"><meta name="msvalidate.01" content="CF295E1604697F9CAD18B5A232E871F6"><meta class="swiftype" name="language" data-type="string" content="en"><script src="/static/z/i.js" type="text/javascript" referrerpolicy="origin"></script><script>(function(w,d){})(window,document)</script><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-32x32.png"><link rel="mask-icon" href="/images/favicon-32x32.png" color="#f78100"><link rel="stylesheet" href="/themes/ashes.min.css"><link rel="sitemap" href="/sitemap.xml"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><link rel="canonical" href="https://blog.cloudflare.com/h3i/"><link rel="alternate" hreflang="en-us" href="https://blog.cloudflare.com/h3i/"><!-- General Meta Tags --> <meta property="article:published_time" content="2024-12-30T14:00+00:00"> <meta property="article:modified_time" content="2024-12-30T14:00:03.282Z">  <meta property="article:tag" content="QUIC"><meta property="article:tag" content="HTTP3"><meta property="article:tag" content="Testing"><meta property="article:tag" content="Protocols"><meta property="article:tag" content="Rust"> <meta property="article:publisher" content="https://www.facebook.com/cloudflare"> <!-- Facebook Meta Tags --> <meta property="og:site_name" content="The Cloudflare Blog"> <meta property="og:type" content="article"> <meta property="og:title" content="Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging"> <meta property="og:description" content="Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes."> <meta property="og:url" content="https://blog.cloudflare.com/h3i/"> <meta property="og:image:width" content="1200"> <meta property="og:image:height" content="628"> <!-- Twitter/X Meta Tags --> <meta name="twitter:title" content="Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging"> <meta name="twitter:description" content="Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes."> <meta name="twitter:url" content="https://blog.cloudflare.com/h3i/"> <meta name="twitter:card" content="summary_large_image">  <meta name="twitter:label1" content="Written by"> <meta name="twitter:data1" content="Lucas Pardue"> <meta name="twitter:creator" content="@SimmerVigor"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="QUIC,HTTP3,Testing,Protocols,Rust"> <meta name="twitter:site" content="@cloudflare">  <meta property="og:image" content="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/49kGUhFhN2iZIdcgGwDL6l/9f70e5deb1d4148f41be228340633c66/Open_sourcing_h3i-_a_command_line_tool_and_library_for_low-level_HTTP_3_testing_and_debugging-OG.png"> <meta name="twitter:image" content="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/49kGUhFhN2iZIdcgGwDL6l/9f70e5deb1d4148f41be228340633c66/Open_sourcing_h3i-_a_command_line_tool_and_library_for_low-level_HTTP_3_testing_and_debugging-OG.png"> <link rel="stylesheet" href="/_astro/index.5BtHvQ-S.css"><script type="module" src="/_astro/hoisted.Byv_OtGt.js"></script><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();;(()=>{var b=Object.defineProperty;var f=(c,o,i)=>o in c?b(c,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[o]=i;var l=(c,o,i)=>(f(c,typeof o!="symbol"?o+"":o,i),i);var p;{let c={0:t=>m(t),1:t=>i(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(i(t)),5:t=>new Set(i(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},o=t=>{let[e,r]=t;return e in c?c[e](r):void 0},i=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,r])=>[e,o(r)]));customElements.get("astro-island")||customElements.define("astro-island",(p=class extends HTMLElement{constructor(){super(...arguments);l(this,"Component");l(this,"hydrator");l(this,"hydrate",async()=>{var d;if(!this.hydrator||!this.isConnected)return;let e=(d=this.parentElement)==null?void 0:d.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let r=this.querySelectorAll("astro-slot"),a={},h=this.querySelectorAll("template[data-astro-template]");for(let n of h){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("data-astro-template")||"default"]=n.innerHTML,n.remove())}for(let n of r){let s=n.closest(this.tagName);s!=null&&s.isSameNode(this)&&(a[n.getAttribute("name")||"default"]=n.innerHTML)}let u;try{u=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(n){let s=this.getAttribute("component-url")||"<unknown>",y=this.getAttribute("component-export");throw y&&(s+=` (export ${y})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),n),n}await this.hydrator(this)(this.Component,u,a,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});l(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),r.disconnect(),this.childrenConnectedCallback()},r=new MutationObserver(()=>{var a;((a=this.lastChild)==null?void 0:a.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});r.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}start(){let e=JSON.parse(this.getAttribute("opts")),r=this.getAttribute("client");if(Astro[r]===void 0){window.addEventListener(`astro:${r}`,()=>this.start(),{once:!0});return}Astro[r](async()=>{let a=this.getAttribute("renderer-url"),[h,{default:u}]=await Promise.all([import(this.getAttribute("component-url")),a?import(a):()=>()=>{}]),d=this.getAttribute("component-export")||"default";if(!d.includes("."))this.Component=h[d];else{this.Component=h;for(let n of d.split("."))this.Component=this.Component[n]}return this.hydrator=u,this.hydrate},e,this)}attributeChangedCallback(){this.hydrate()}},l(p,"observedAttributes",["props"]),p))}})();</script><script src="https://ot.www.cloudflare.com/public/vendor/onetrust/scripttemplates/202407.2.0/otBannerSdk.js" async="" type="text/javascript"></script><script>(function(w,d){;w.zarazData.executed.push("Pageview");})(window,document)</script><script>(function(w,d){{const d = document.createElement('div');d.innerHTML = ``;document.body.appendChild(d);};{(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NDGPDFZ');};{const d = document.createElement('div');d.innerHTML = ``;document.body.appendChild(d);};{const el = document.createElement('script');Object.entries(JSON.parse(decodeURIComponent(`%7B%22defer%22%3A%22%22%2C%22src%22%3A%22https%3A%2F%2Fperformance.radar.cloudflare.com%2Fbeacon.js%22%2C%22onload%22%3A%22%7Bdocument.dispatchEvent(new%20Event(%5C%22loaded-62e47ceb-db6d-447c-95ef-864273687337%5C%22))%7D%22%2C%22order-id%22%3A%2262e47ceb-db6d-447c-95ef-864273687337%22%7D`))).forEach(([k, v]) => {el.setAttribute(k, v);});document.head.appendChild(el);};{const d = document.createElement('div');d.innerHTML = ``;document.body.appendChild(d);};{
    (function(i,s,o,g,r,a,m){i['SLScoutObject']=r;i[r]=i[r]||function()
{     (i[r].q=i[r].q||[]).push(arguments)}
,i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://scout-cdn.salesloft.com/sl.js','slscout');
    slscout(["init", "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0IjoxMDkyNjh9.dguW7jthV1Y1wgRcAJfVrR_xsANK7zX9ZiD1wf0suvY"]);
};{const d = document.createElement('div');d.innerHTML = `<noscript>
<img height="1" width="1" style="display:none;" alt="" src="https://px.ads.linkedin.com/collect/?pid=28851&fmt=gif" />
</noscript>`;document.body.appendChild(d);};{
_linkedin_partner_id = "28851";
window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
window._linkedin_data_partner_ids.push(_linkedin_partner_id);
};{
(function(l) {
if (!l){window.lintrk = function(a,b)
{window.lintrk.q.push([a,b])}
;
window.lintrk.q=[]}
var s = document.getElementsByTagName("script")[0];
var b = document.createElement("script");
b.type = "text/javascript";b.async = true;
b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
s.parentNode.insertBefore(b, s);})(window.lintrk);
};{const d = document.createElement('div');d.innerHTML = ``;document.body.appendChild(d);};{
	(function() {
		var didInit = false;
		function initMunchkin() {
			if(didInit === false) {
				didInit = true;
				Munchkin.init('713-XSC-918');
			}
		}
		var s = document.createElement('script');
		s.type = 'text/javascript';
		s.async = true;
		s.src = '//munchkin.marketo.net/munchkin.js';
		s.onreadystatechange = function() {
			if (this.readyState == 'complete' || this.readyState == 'loaded') {
				initMunchkin();
			}
		};
		s.onload = initMunchkin;
		document.getElementsByTagName('head')[0].appendChild(s);
		})();
};{x=new XMLHttpRequest,x.withCredentials=!0,x.open("POST","https://stats.g.doubleclick.net/g/collect?t=dc&aip=1&_r=3&v=1&_v=j86&tid=G-PGV1K2BN4M&cid=8b9de980-8f51-42a7-8c0a-2b1dcedebdcf&_u=KGDAAEADQAAAAC%7E&z=399470097",!0),x.onreadystatechange=function(){if (4 == x.readyState) {const domain = x.responseText.trim();if (domain.startsWith("1g") && domain.length > 2) {fetch("https://www.google.com/ads/ga-audiences?t=sr&aip=1&_r=4&v=1&_v=j86&tid=G-PGV1K2BN4M&cid=8b9de980-8f51-42a7-8c0a-2b1dcedebdcf&_u=KGDAAEADQAAAAC%7E&z=399470097&slf_rd=1".replace("www.google.com", "www.google."+domain.slice(2)));}}},x.send();}})(window,document)</script><script defer="" src="https://performance.radar.cloudflare.com/beacon.js" onload="{document.dispatchEvent(new Event(&quot;loaded-62e47ceb-db6d-447c-95ef-864273687337&quot;))}" order-id="62e47ceb-db6d-447c-95ef-864273687337"></script><script type="text/javascript" async="" src="//munchkin.marketo.net/munchkin.js"></script><script>(function(w,d){;w.zarazData.executed.push("AllTracks");})(window,document)</script><script>(function(w,d){{(function(w,d){zaraz._c=cV=>{const{event:cW,...cX}=cV;zaraz.track(cW,{...cX,__zarazClientEvent:!0})};zaraz._syncedAttributes=["altKey","clientX","clientY","pageX","pageY","button"];zaraz.__zcl.track=!0;})(window,document);}})(window,document)</script><script>(function(w,d){;w.zarazData.executed.push("AllTracks");})(window,document)</script><script>(function(w,d){{(function(w,d){zaraz._c=cV=>{const{event:cW,...cX}=cV;zaraz.track(cW,{...cX,__zarazClientEvent:!0})};zaraz._syncedAttributes=["altKey","clientX","clientY","pageX","pageY","button"];zaraz.__zcl.track=!0;})(window,document);}})(window,document)</script><script>(function(w,d){;w.zarazData.executed.push("AllTracks");})(window,document)</script><script>(function(w,d){{(function(w,d){zaraz.__zarazMCListeners={"google-analytics_v4_nzcr":["visibilityChange"]};})(window,document);}})(window,document)</script><script>(function(w,d){;w.zarazData.executed.push("AllTracks");})(window,document)</script><script>(function(w,d){{(function(w,d){zaraz.__zarazMCListeners={"google-analytics_v4_nzcr":["visibilityChange"]};})(window,document);}})(window,document)</script><style id="onetrust-style">#onetrust-banner-sdk .onetrust-vendors-list-handler{cursor:pointer;color:#1f96db;font-size:inherit;font-weight:bold;text-decoration:none;margin-left:5px}#onetrust-banner-sdk .onetrust-vendors-list-handler:hover{color:#1f96db}#onetrust-banner-sdk:focus{outline:2px solid #000;outline-offset:-2px}#onetrust-banner-sdk a:focus{outline:2px solid #000}#onetrust-banner-sdk #onetrust-accept-btn-handler,#onetrust-banner-sdk #onetrust-reject-all-handler,#onetrust-banner-sdk #onetrust-pc-btn-handler{outline-offset:1px}#onetrust-banner-sdk.ot-bnr-w-logo .ot-bnr-logo{height:64px;width:64px}#onetrust-banner-sdk .ot-tcf2-vendor-count.ot-text-bold{font-weight:bold}#onetrust-banner-sdk .ot-close-icon,#onetrust-pc-sdk .ot-close-icon,#ot-sync-ntfy .ot-close-icon{background-size:contain;background-repeat:no-repeat;background-position:center;height:12px;width:12px}#onetrust-banner-sdk .powered-by-logo,#onetrust-banner-sdk .ot-pc-footer-logo a,#onetrust-pc-sdk .powered-by-logo,#onetrust-pc-sdk .ot-pc-footer-logo a,#ot-sync-ntfy .powered-by-logo,#ot-sync-ntfy .ot-pc-footer-logo a{background-size:contain;background-repeat:no-repeat;background-position:center;height:25px;width:152px;display:block;text-decoration:none;font-size:.75em}#onetrust-banner-sdk .powered-by-logo:hover,#onetrust-banner-sdk .ot-pc-footer-logo a:hover,#onetrust-pc-sdk .powered-by-logo:hover,#onetrust-pc-sdk .ot-pc-footer-logo a:hover,#ot-sync-ntfy .powered-by-logo:hover,#ot-sync-ntfy .ot-pc-footer-logo a:hover{color:#565656}#onetrust-banner-sdk h3 *,#onetrust-banner-sdk h4 *,#onetrust-banner-sdk h6 *,#onetrust-banner-sdk button *,#onetrust-banner-sdk a[data-parent-id] *,#onetrust-pc-sdk h3 *,#onetrust-pc-sdk h4 *,#onetrust-pc-sdk h6 *,#onetrust-pc-sdk button *,#onetrust-pc-sdk a[data-parent-id] *,#ot-sync-ntfy h3 *,#ot-sync-ntfy h4 *,#ot-sync-ntfy h6 *,#ot-sync-ntfy button *,#ot-sync-ntfy a[data-parent-id] *{font-size:inherit;font-weight:inherit;color:inherit}#onetrust-banner-sdk .ot-hide,#onetrust-pc-sdk .ot-hide,#ot-sync-ntfy .ot-hide{display:none !important}#onetrust-banner-sdk button.ot-link-btn:hover,#onetrust-pc-sdk button.ot-link-btn:hover,#ot-sync-ntfy button.ot-link-btn:hover{text-decoration:underline;opacity:1}#onetrust-pc-sdk .ot-sdk-row .ot-sdk-column{padding:0}#onetrust-pc-sdk .ot-sdk-container{padding-right:0}#onetrust-pc-sdk .ot-sdk-row{flex-direction:initial;width:100%}#onetrust-pc-sdk [type=checkbox]:checked,#onetrust-pc-sdk [type=checkbox]:not(:checked){pointer-events:initial}#onetrust-pc-sdk [type=checkbox]:disabled+label::before,#onetrust-pc-sdk [type=checkbox]:disabled+label:after,#onetrust-pc-sdk [type=checkbox]:disabled+label{pointer-events:none;opacity:.7}#onetrust-pc-sdk #vendor-list-content{transform:translate3d(0, 0, 0)}#onetrust-pc-sdk li input[type=checkbox]{z-index:1}#onetrust-pc-sdk li .ot-checkbox label{z-index:2}#onetrust-pc-sdk li .ot-checkbox input[type=checkbox]{height:auto;width:auto}#onetrust-pc-sdk li .host-title a,#onetrust-pc-sdk li .ot-host-name a,#onetrust-pc-sdk li .accordion-text,#onetrust-pc-sdk li .ot-acc-txt{z-index:2;position:relative}#onetrust-pc-sdk input{margin:3px .1ex}#onetrust-pc-sdk .pc-logo,#onetrust-pc-sdk .ot-pc-logo{height:60px;width:180px;background-position:center;background-size:contain;background-repeat:no-repeat;display:inline-flex;justify-content:center;align-items:center}#onetrust-pc-sdk .pc-logo img,#onetrust-pc-sdk .ot-pc-logo img{max-height:100%;max-width:100%}#onetrust-pc-sdk .screen-reader-only,#onetrust-pc-sdk .ot-scrn-rdr,.ot-sdk-cookie-policy .screen-reader-only,.ot-sdk-cookie-policy .ot-scrn-rdr{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}#onetrust-pc-sdk.ot-fade-in,.onetrust-pc-dark-filter.ot-fade-in,#onetrust-banner-sdk.ot-fade-in{animation-name:onetrust-fade-in;animation-duration:400ms;animation-timing-function:ease-in-out}#onetrust-pc-sdk.ot-hide{display:none !important}.onetrust-pc-dark-filter.ot-hide{display:none !important}#ot-sdk-btn.ot-sdk-show-settings,#ot-sdk-btn.optanon-show-settings{color:#68b631;border:1px solid #68b631;height:auto;white-space:normal;word-wrap:break-word;padding:.8em 2em;font-size:.8em;line-height:1.2;cursor:pointer;-moz-transition:.1s ease;-o-transition:.1s ease;-webkit-transition:1s ease;transition:.1s ease}#ot-sdk-btn.ot-sdk-show-settings:hover,#ot-sdk-btn.optanon-show-settings:hover{color:#fff;background-color:#68b631}.onetrust-pc-dark-filter{background:rgba(0,0,0,.5);z-index:2147483646;width:100%;height:100%;overflow:hidden;position:fixed;top:0;bottom:0;left:0}@keyframes onetrust-fade-in{0%{opacity:0}100%{opacity:1}}.ot-cookie-label{text-decoration:underline}@media only screen and (min-width: 426px)and (max-width: 896px)and (orientation: landscape){#onetrust-pc-sdk p{font-size:.75em}}#onetrust-banner-sdk .banner-option-input:focus+label{outline:1px solid #000;outline-style:auto}.category-vendors-list-handler+a:focus,.category-vendors-list-handler+a:focus-visible{outline:2px solid #000}#onetrust-pc-sdk .ot-userid-title{margin-top:10px}#onetrust-pc-sdk .ot-userid-title>span,#onetrust-pc-sdk .ot-userid-timestamp>span{font-weight:700}#onetrust-pc-sdk .ot-userid-desc{font-style:italic}#onetrust-pc-sdk .ot-host-desc a{pointer-events:initial}#onetrust-pc-sdk .ot-ven-hdr>p a{position:relative;z-index:2;pointer-events:initial}#onetrust-pc-sdk .ot-vnd-serv .ot-vnd-item .ot-vnd-info a,#onetrust-pc-sdk .ot-vs-list .ot-vnd-item .ot-vnd-info a{margin-right:auto}#onetrust-pc-sdk .ot-pc-footer-logo img{width:136px;height:16px}#onetrust-pc-sdk .ot-pur-vdr-count{font-weight:400;font-size:.7rem;padding-top:3px;display:block}#onetrust-banner-sdk .ot-optout-signal,#onetrust-pc-sdk .ot-optout-signal{border:1px solid #32ae88;border-radius:3px;padding:5px;margin-bottom:10px;background-color:#f9fffa;font-size:.85rem;line-height:2}#onetrust-banner-sdk .ot-optout-signal .ot-optout-icon,#onetrust-pc-sdk .ot-optout-signal .ot-optout-icon{display:inline;margin-right:5px}#onetrust-banner-sdk .ot-optout-signal svg,#onetrust-pc-sdk .ot-optout-signal svg{height:20px;width:30px;transform:scale(0.5)}#onetrust-banner-sdk .ot-optout-signal svg path,#onetrust-pc-sdk .ot-optout-signal svg path{fill:#32ae88}#onetrust-consent-sdk .ot-general-modal{overflow:hidden;position:fixed;margin:0 auto;top:50%;left:50%;width:40%;padding:1.5rem;max-width:575px;min-width:575px;z-index:2147483647;border-radius:2.5px;transform:translate(-50%, -50%)}#onetrust-consent-sdk .ot-signature-health-group{margin-top:1rem;padding-left:1.25rem;padding-right:1.25rem;margin-bottom:.625rem;width:calc(100% - 2.5rem)}#onetrust-consent-sdk .ot-signature-health-group .ot-signature-health-form{gap:.5rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-health-form{width:70%;gap:.35rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-input{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}#onetrust-consent-sdk .ot-signature-health .ot-signature-subtitle{font-size:1.125rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-group-title{font-size:1.25rem;font-weight:bold}#onetrust-consent-sdk .ot-signature-health,#onetrust-consent-sdk .ot-signature-health-group{display:flex;flex-direction:column;gap:1rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-cont,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-cont{display:flex;flex-direction:column;gap:.25rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-paragraph,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-paragraph{margin:0;line-height:20px;font-size:max(14px,.875rem)}#onetrust-consent-sdk .ot-signature-health .ot-health-signature-error,#onetrust-consent-sdk .ot-signature-health-group .ot-health-signature-error{color:#4d4d4d;font-size:min(12px,.75rem)}#onetrust-consent-sdk .ot-signature-health .ot-signature-buttons-cont,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-buttons-cont{margin-top:max(.75rem,2%);gap:1rem;display:flex;justify-content:flex-end}#onetrust-consent-sdk .ot-signature-health .ot-signature-button,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-button{flex:1;height:auto;color:#fff;cursor:pointer;line-height:1.2;min-width:125px;font-weight:600;font-size:.813em;border-radius:2px;padding:12px 10px;white-space:normal;word-wrap:break-word;word-break:break-word;background-color:#68b631;border:2px solid #68b631}#onetrust-consent-sdk .ot-signature-health .ot-signature-button.reject,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-button.reject{background-color:#fff}#onetrust-consent-sdk .ot-input-field-cont{display:flex;flex-direction:column;gap:.5rem}#onetrust-consent-sdk .ot-input-field-cont .ot-signature-input{width:65%}#onetrust-consent-sdk .ot-signature-health-form{display:flex;flex-direction:column}#onetrust-consent-sdk .ot-signature-health-form .ot-signature-label{margin-bottom:0;line-height:20px;font-size:max(14px,.875rem)}@media only screen and (max-width: 600px){#onetrust-consent-sdk .ot-general-modal{min-width:100%}#onetrust-consent-sdk .ot-signature-health .ot-signature-health-form{width:100%}#onetrust-consent-sdk .ot-input-field-cont .ot-signature-input{width:100%}}#onetrust-banner-sdk,#onetrust-pc-sdk,#ot-sdk-cookie-policy,#ot-sync-ntfy{font-size:16px}#onetrust-banner-sdk *,#onetrust-banner-sdk ::after,#onetrust-banner-sdk ::before,#onetrust-pc-sdk *,#onetrust-pc-sdk ::after,#onetrust-pc-sdk ::before,#ot-sdk-cookie-policy *,#ot-sdk-cookie-policy ::after,#ot-sdk-cookie-policy ::before,#ot-sync-ntfy *,#ot-sync-ntfy ::after,#ot-sync-ntfy ::before{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}#onetrust-banner-sdk div,#onetrust-banner-sdk span,#onetrust-banner-sdk h1,#onetrust-banner-sdk h2,#onetrust-banner-sdk h3,#onetrust-banner-sdk h4,#onetrust-banner-sdk h5,#onetrust-banner-sdk h6,#onetrust-banner-sdk p,#onetrust-banner-sdk img,#onetrust-banner-sdk svg,#onetrust-banner-sdk button,#onetrust-banner-sdk section,#onetrust-banner-sdk a,#onetrust-banner-sdk label,#onetrust-banner-sdk input,#onetrust-banner-sdk ul,#onetrust-banner-sdk li,#onetrust-banner-sdk nav,#onetrust-banner-sdk table,#onetrust-banner-sdk thead,#onetrust-banner-sdk tr,#onetrust-banner-sdk td,#onetrust-banner-sdk tbody,#onetrust-banner-sdk .ot-main-content,#onetrust-banner-sdk .ot-toggle,#onetrust-banner-sdk #ot-content,#onetrust-banner-sdk #ot-pc-content,#onetrust-banner-sdk .checkbox,#onetrust-pc-sdk div,#onetrust-pc-sdk span,#onetrust-pc-sdk h1,#onetrust-pc-sdk h2,#onetrust-pc-sdk h3,#onetrust-pc-sdk h4,#onetrust-pc-sdk h5,#onetrust-pc-sdk h6,#onetrust-pc-sdk p,#onetrust-pc-sdk img,#onetrust-pc-sdk svg,#onetrust-pc-sdk button,#onetrust-pc-sdk section,#onetrust-pc-sdk a,#onetrust-pc-sdk label,#onetrust-pc-sdk input,#onetrust-pc-sdk ul,#onetrust-pc-sdk li,#onetrust-pc-sdk nav,#onetrust-pc-sdk table,#onetrust-pc-sdk thead,#onetrust-pc-sdk tr,#onetrust-pc-sdk td,#onetrust-pc-sdk tbody,#onetrust-pc-sdk .ot-main-content,#onetrust-pc-sdk .ot-toggle,#onetrust-pc-sdk #ot-content,#onetrust-pc-sdk #ot-pc-content,#onetrust-pc-sdk .checkbox,#ot-sdk-cookie-policy div,#ot-sdk-cookie-policy span,#ot-sdk-cookie-policy h1,#ot-sdk-cookie-policy h2,#ot-sdk-cookie-policy h3,#ot-sdk-cookie-policy h4,#ot-sdk-cookie-policy h5,#ot-sdk-cookie-policy h6,#ot-sdk-cookie-policy p,#ot-sdk-cookie-policy img,#ot-sdk-cookie-policy svg,#ot-sdk-cookie-policy button,#ot-sdk-cookie-policy section,#ot-sdk-cookie-policy a,#ot-sdk-cookie-policy label,#ot-sdk-cookie-policy input,#ot-sdk-cookie-policy ul,#ot-sdk-cookie-policy li,#ot-sdk-cookie-policy nav,#ot-sdk-cookie-policy table,#ot-sdk-cookie-policy thead,#ot-sdk-cookie-policy tr,#ot-sdk-cookie-policy td,#ot-sdk-cookie-policy tbody,#ot-sdk-cookie-policy .ot-main-content,#ot-sdk-cookie-policy .ot-toggle,#ot-sdk-cookie-policy #ot-content,#ot-sdk-cookie-policy #ot-pc-content,#ot-sdk-cookie-policy .checkbox,#ot-sync-ntfy div,#ot-sync-ntfy span,#ot-sync-ntfy h1,#ot-sync-ntfy h2,#ot-sync-ntfy h3,#ot-sync-ntfy h4,#ot-sync-ntfy h5,#ot-sync-ntfy h6,#ot-sync-ntfy p,#ot-sync-ntfy img,#ot-sync-ntfy svg,#ot-sync-ntfy button,#ot-sync-ntfy section,#ot-sync-ntfy a,#ot-sync-ntfy label,#ot-sync-ntfy input,#ot-sync-ntfy ul,#ot-sync-ntfy li,#ot-sync-ntfy nav,#ot-sync-ntfy table,#ot-sync-ntfy thead,#ot-sync-ntfy tr,#ot-sync-ntfy td,#ot-sync-ntfy tbody,#ot-sync-ntfy .ot-main-content,#ot-sync-ntfy .ot-toggle,#ot-sync-ntfy #ot-content,#ot-sync-ntfy #ot-pc-content,#ot-sync-ntfy .checkbox{font-family:inherit;font-weight:normal;-webkit-font-smoothing:auto;letter-spacing:normal;line-height:normal;padding:0;margin:0;height:auto;min-height:0;max-height:none;width:auto;min-width:0;max-width:none;border-radius:0;border:none;clear:none;float:none;position:static;bottom:auto;left:auto;right:auto;top:auto;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;white-space:normal;background:none;overflow:visible;vertical-align:baseline;visibility:visible;z-index:auto;box-shadow:none}#onetrust-banner-sdk label:before,#onetrust-banner-sdk label:after,#onetrust-banner-sdk .checkbox:after,#onetrust-banner-sdk .checkbox:before,#onetrust-pc-sdk label:before,#onetrust-pc-sdk label:after,#onetrust-pc-sdk .checkbox:after,#onetrust-pc-sdk .checkbox:before,#ot-sdk-cookie-policy label:before,#ot-sdk-cookie-policy label:after,#ot-sdk-cookie-policy .checkbox:after,#ot-sdk-cookie-policy .checkbox:before,#ot-sync-ntfy label:before,#ot-sync-ntfy label:after,#ot-sync-ntfy .checkbox:after,#ot-sync-ntfy .checkbox:before{content:"";content:none}#onetrust-banner-sdk .ot-sdk-container,#onetrust-pc-sdk .ot-sdk-container,#ot-sdk-cookie-policy .ot-sdk-container{position:relative;width:100%;max-width:100%;margin:0 auto;padding:0 20px;box-sizing:border-box}#onetrust-banner-sdk .ot-sdk-column,#onetrust-banner-sdk .ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-column,#onetrust-pc-sdk .ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-column,#ot-sdk-cookie-policy .ot-sdk-columns{width:100%;float:left;box-sizing:border-box;padding:0;display:initial}@media(min-width: 400px){#onetrust-banner-sdk .ot-sdk-container,#onetrust-pc-sdk .ot-sdk-container,#ot-sdk-cookie-policy .ot-sdk-container{width:90%;padding:0}}@media(min-width: 550px){#onetrust-banner-sdk .ot-sdk-container,#onetrust-pc-sdk .ot-sdk-container,#ot-sdk-cookie-policy .ot-sdk-container{width:100%}#onetrust-banner-sdk .ot-sdk-column,#onetrust-banner-sdk .ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-column,#onetrust-pc-sdk .ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-column,#ot-sdk-cookie-policy .ot-sdk-columns{margin-left:4%}#onetrust-banner-sdk .ot-sdk-column:first-child,#onetrust-banner-sdk .ot-sdk-columns:first-child,#onetrust-pc-sdk .ot-sdk-column:first-child,#onetrust-pc-sdk .ot-sdk-columns:first-child,#ot-sdk-cookie-policy .ot-sdk-column:first-child,#ot-sdk-cookie-policy .ot-sdk-columns:first-child{margin-left:0}#onetrust-banner-sdk .ot-sdk-two.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-two.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-two.ot-sdk-columns{width:13.3333333333%}#onetrust-banner-sdk .ot-sdk-three.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-three.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-three.ot-sdk-columns{width:22%}#onetrust-banner-sdk .ot-sdk-four.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-four.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-four.ot-sdk-columns{width:30.6666666667%}#onetrust-banner-sdk .ot-sdk-eight.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-eight.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-eight.ot-sdk-columns{width:65.3333333333%}#onetrust-banner-sdk .ot-sdk-nine.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-nine.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-nine.ot-sdk-columns{width:74%}#onetrust-banner-sdk .ot-sdk-ten.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-ten.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-ten.ot-sdk-columns{width:82.6666666667%}#onetrust-banner-sdk .ot-sdk-eleven.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-eleven.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-eleven.ot-sdk-columns{width:91.3333333333%}#onetrust-banner-sdk .ot-sdk-twelve.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-twelve.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-twelve.ot-sdk-columns{width:100%;margin-left:0}}#onetrust-banner-sdk h1,#onetrust-banner-sdk h2,#onetrust-banner-sdk h3,#onetrust-banner-sdk h4,#onetrust-banner-sdk h5,#onetrust-banner-sdk h6,#onetrust-pc-sdk h1,#onetrust-pc-sdk h2,#onetrust-pc-sdk h3,#onetrust-pc-sdk h4,#onetrust-pc-sdk h5,#onetrust-pc-sdk h6,#ot-sdk-cookie-policy h1,#ot-sdk-cookie-policy h2,#ot-sdk-cookie-policy h3,#ot-sdk-cookie-policy h4,#ot-sdk-cookie-policy h5,#ot-sdk-cookie-policy h6{margin-top:0;font-weight:600;font-family:inherit}#onetrust-banner-sdk h1,#onetrust-pc-sdk h1,#ot-sdk-cookie-policy h1{font-size:1.5rem;line-height:1.2}#onetrust-banner-sdk h2,#onetrust-pc-sdk h2,#ot-sdk-cookie-policy h2{font-size:1.5rem;line-height:1.25}#onetrust-banner-sdk h3,#onetrust-pc-sdk h3,#ot-sdk-cookie-policy h3{font-size:1.5rem;line-height:1.3}#onetrust-banner-sdk h4,#onetrust-pc-sdk h4,#ot-sdk-cookie-policy h4{font-size:1.5rem;line-height:1.35}#onetrust-banner-sdk h5,#onetrust-pc-sdk h5,#ot-sdk-cookie-policy h5{font-size:1.5rem;line-height:1.5}#onetrust-banner-sdk h6,#onetrust-pc-sdk h6,#ot-sdk-cookie-policy h6{font-size:1.5rem;line-height:1.6}@media(min-width: 550px){#onetrust-banner-sdk h1,#onetrust-pc-sdk h1,#ot-sdk-cookie-policy h1{font-size:1.5rem}#onetrust-banner-sdk h2,#onetrust-pc-sdk h2,#ot-sdk-cookie-policy h2{font-size:1.5rem}#onetrust-banner-sdk h3,#onetrust-pc-sdk h3,#ot-sdk-cookie-policy h3{font-size:1.5rem}#onetrust-banner-sdk h4,#onetrust-pc-sdk h4,#ot-sdk-cookie-policy h4{font-size:1.5rem}#onetrust-banner-sdk h5,#onetrust-pc-sdk h5,#ot-sdk-cookie-policy h5{font-size:1.5rem}#onetrust-banner-sdk h6,#onetrust-pc-sdk h6,#ot-sdk-cookie-policy h6{font-size:1.5rem}}#onetrust-banner-sdk p,#onetrust-pc-sdk p,#ot-sdk-cookie-policy p{margin:0 0 1em 0;font-family:inherit;line-height:normal}#onetrust-banner-sdk a,#onetrust-pc-sdk a,#ot-sdk-cookie-policy a{color:#565656;text-decoration:underline}#onetrust-banner-sdk a:hover,#onetrust-pc-sdk a:hover,#ot-sdk-cookie-policy a:hover{color:#565656;text-decoration:none}#onetrust-banner-sdk .ot-sdk-button,#onetrust-banner-sdk button,#onetrust-pc-sdk .ot-sdk-button,#onetrust-pc-sdk button,#ot-sdk-cookie-policy .ot-sdk-button,#ot-sdk-cookie-policy button{margin-bottom:1rem;font-family:inherit}#onetrust-banner-sdk .ot-sdk-button,#onetrust-banner-sdk button,#onetrust-pc-sdk .ot-sdk-button,#onetrust-pc-sdk button,#ot-sdk-cookie-policy .ot-sdk-button,#ot-sdk-cookie-policy button{display:inline-block;height:38px;padding:0 30px;color:#555;text-align:center;font-size:.9em;font-weight:400;line-height:38px;letter-spacing:.01em;text-decoration:none;white-space:nowrap;background-color:rgba(0,0,0,0);border-radius:2px;border:1px solid #bbb;cursor:pointer;box-sizing:border-box}#onetrust-banner-sdk .ot-sdk-button:hover,#onetrust-banner-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):hover,#onetrust-banner-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):focus,#onetrust-pc-sdk .ot-sdk-button:hover,#onetrust-pc-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):hover,#onetrust-pc-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):focus,#ot-sdk-cookie-policy .ot-sdk-button:hover,#ot-sdk-cookie-policy :not(.ot-leg-btn-container)>button:not(.ot-link-btn):hover,#ot-sdk-cookie-policy :not(.ot-leg-btn-container)>button:not(.ot-link-btn):focus{color:#333;border-color:#888;opacity:.7}#onetrust-banner-sdk .ot-sdk-button:focus,#onetrust-banner-sdk :not(.ot-leg-btn-container)>button:focus,#onetrust-pc-sdk .ot-sdk-button:focus,#onetrust-pc-sdk :not(.ot-leg-btn-container)>button:focus,#ot-sdk-cookie-policy .ot-sdk-button:focus,#ot-sdk-cookie-policy :not(.ot-leg-btn-container)>button:focus{outline:2px solid #000}#onetrust-banner-sdk .ot-sdk-button.ot-sdk-button-primary,#onetrust-banner-sdk button.ot-sdk-button-primary,#onetrust-banner-sdk input[type=submit].ot-sdk-button-primary,#onetrust-banner-sdk input[type=reset].ot-sdk-button-primary,#onetrust-banner-sdk input[type=button].ot-sdk-button-primary,#onetrust-pc-sdk .ot-sdk-button.ot-sdk-button-primary,#onetrust-pc-sdk button.ot-sdk-button-primary,#onetrust-pc-sdk input[type=submit].ot-sdk-button-primary,#onetrust-pc-sdk input[type=reset].ot-sdk-button-primary,#onetrust-pc-sdk input[type=button].ot-sdk-button-primary,#ot-sdk-cookie-policy .ot-sdk-button.ot-sdk-button-primary,#ot-sdk-cookie-policy button.ot-sdk-button-primary,#ot-sdk-cookie-policy input[type=submit].ot-sdk-button-primary,#ot-sdk-cookie-policy input[type=reset].ot-sdk-button-primary,#ot-sdk-cookie-policy input[type=button].ot-sdk-button-primary{color:#fff;background-color:#33c3f0;border-color:#33c3f0}#onetrust-banner-sdk .ot-sdk-button.ot-sdk-button-primary:hover,#onetrust-banner-sdk button.ot-sdk-button-primary:hover,#onetrust-banner-sdk input[type=submit].ot-sdk-button-primary:hover,#onetrust-banner-sdk input[type=reset].ot-sdk-button-primary:hover,#onetrust-banner-sdk input[type=button].ot-sdk-button-primary:hover,#onetrust-banner-sdk .ot-sdk-button.ot-sdk-button-primary:focus,#onetrust-banner-sdk button.ot-sdk-button-primary:focus,#onetrust-banner-sdk input[type=submit].ot-sdk-button-primary:focus,#onetrust-banner-sdk input[type=reset].ot-sdk-button-primary:focus,#onetrust-banner-sdk input[type=button].ot-sdk-button-primary:focus,#onetrust-pc-sdk .ot-sdk-button.ot-sdk-button-primary:hover,#onetrust-pc-sdk button.ot-sdk-button-primary:hover,#onetrust-pc-sdk input[type=submit].ot-sdk-button-primary:hover,#onetrust-pc-sdk input[type=reset].ot-sdk-button-primary:hover,#onetrust-pc-sdk input[type=button].ot-sdk-button-primary:hover,#onetrust-pc-sdk .ot-sdk-button.ot-sdk-button-primary:focus,#onetrust-pc-sdk button.ot-sdk-button-primary:focus,#onetrust-pc-sdk input[type=submit].ot-sdk-button-primary:focus,#onetrust-pc-sdk input[type=reset].ot-sdk-button-primary:focus,#onetrust-pc-sdk input[type=button].ot-sdk-button-primary:focus,#ot-sdk-cookie-policy .ot-sdk-button.ot-sdk-button-primary:hover,#ot-sdk-cookie-policy button.ot-sdk-button-primary:hover,#ot-sdk-cookie-policy input[type=submit].ot-sdk-button-primary:hover,#ot-sdk-cookie-policy input[type=reset].ot-sdk-button-primary:hover,#ot-sdk-cookie-policy input[type=button].ot-sdk-button-primary:hover,#ot-sdk-cookie-policy .ot-sdk-button.ot-sdk-button-primary:focus,#ot-sdk-cookie-policy button.ot-sdk-button-primary:focus,#ot-sdk-cookie-policy input[type=submit].ot-sdk-button-primary:focus,#ot-sdk-cookie-policy input[type=reset].ot-sdk-button-primary:focus,#ot-sdk-cookie-policy input[type=button].ot-sdk-button-primary:focus{color:#fff;background-color:#1eaedb;border-color:#1eaedb}#onetrust-banner-sdk input[type=text],#onetrust-pc-sdk input[type=text],#ot-sdk-cookie-policy input[type=text]{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}#onetrust-banner-sdk input[type=text],#onetrust-pc-sdk input[type=text],#ot-sdk-cookie-policy input[type=text]{-webkit-appearance:none;-moz-appearance:none;appearance:none}#onetrust-banner-sdk input[type=text]:focus,#onetrust-pc-sdk input[type=text]:focus,#ot-sdk-cookie-policy input[type=text]:focus{border:1px solid #000;outline:0}#onetrust-banner-sdk label,#onetrust-pc-sdk label,#ot-sdk-cookie-policy label{display:block;margin-bottom:.5rem;font-weight:600}#onetrust-banner-sdk input[type=checkbox],#onetrust-pc-sdk input[type=checkbox],#ot-sdk-cookie-policy input[type=checkbox]{display:inline}#onetrust-banner-sdk ul,#onetrust-pc-sdk ul,#ot-sdk-cookie-policy ul{list-style:circle inside}#onetrust-banner-sdk ul,#onetrust-pc-sdk ul,#ot-sdk-cookie-policy ul{padding-left:0;margin-top:0}#onetrust-banner-sdk ul ul,#onetrust-pc-sdk ul ul,#ot-sdk-cookie-policy ul ul{margin:1.5rem 0 1.5rem 3rem;font-size:90%}#onetrust-banner-sdk li,#onetrust-pc-sdk li,#ot-sdk-cookie-policy li{margin-bottom:1rem}#onetrust-banner-sdk th,#onetrust-banner-sdk td,#onetrust-pc-sdk th,#onetrust-pc-sdk td,#ot-sdk-cookie-policy th,#ot-sdk-cookie-policy td{padding:12px 15px;text-align:left;border-bottom:1px solid #e1e1e1}#onetrust-banner-sdk button,#onetrust-pc-sdk button,#ot-sdk-cookie-policy button{margin-bottom:1rem;font-family:inherit}#onetrust-banner-sdk .ot-sdk-container:after,#onetrust-banner-sdk .ot-sdk-row:after,#onetrust-pc-sdk .ot-sdk-container:after,#onetrust-pc-sdk .ot-sdk-row:after,#ot-sdk-cookie-policy .ot-sdk-container:after,#ot-sdk-cookie-policy .ot-sdk-row:after{content:"";display:table;clear:both}#onetrust-banner-sdk .ot-sdk-row,#onetrust-pc-sdk .ot-sdk-row,#ot-sdk-cookie-policy .ot-sdk-row{margin:0;max-width:none;display:block}.ot-sdk-cookie-policy{font-family:inherit;font-size:16px}.ot-sdk-cookie-policy.otRelFont{font-size:1rem}.ot-sdk-cookie-policy h3,.ot-sdk-cookie-policy h4,.ot-sdk-cookie-policy h6,.ot-sdk-cookie-policy p,.ot-sdk-cookie-policy li,.ot-sdk-cookie-policy a,.ot-sdk-cookie-policy th,.ot-sdk-cookie-policy #cookie-policy-description,.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group,.ot-sdk-cookie-policy #cookie-policy-title{color:dimgray}.ot-sdk-cookie-policy #cookie-policy-description{margin-bottom:1em}.ot-sdk-cookie-policy h4{font-size:1.2em}.ot-sdk-cookie-policy h6{font-size:1em;margin-top:2em}.ot-sdk-cookie-policy th{min-width:75px}.ot-sdk-cookie-policy a,.ot-sdk-cookie-policy a:hover{background:#fff}.ot-sdk-cookie-policy thead{background-color:#f6f6f4;font-weight:bold}.ot-sdk-cookie-policy .ot-mobile-border{display:none}.ot-sdk-cookie-policy section{margin-bottom:2em}.ot-sdk-cookie-policy table{border-collapse:inherit}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy{font-family:inherit;font-size:1rem}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h3,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h4,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h6,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy p,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy li,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-title{color:dimgray}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description{margin-bottom:1em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-subgroup{margin-left:1.5em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group-desc,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-table-header,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy span,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td{font-size:.9em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td span,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td a{font-size:inherit}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group{font-size:1em;margin-bottom:.6em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-title{margin-bottom:1.2em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy>section{margin-bottom:1em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th{min-width:75px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a:hover{background:#fff}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy thead{background-color:#f6f6f4;font-weight:bold}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-mobile-border{display:none}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy section{margin-bottom:2em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-subgroup ul li{list-style:disc;margin-left:1.5em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-subgroup ul li h4{display:inline-block}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table{border-collapse:inherit;margin:auto;border:1px solid #d7d7d7;border-radius:5px;border-spacing:initial;width:100%;overflow:hidden}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table th,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table td{border-bottom:1px solid #d7d7d7;border-right:1px solid #d7d7d7}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr:last-child td{border-bottom:0px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr th:last-child,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr td:last-child{border-right:0px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-host,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-cookies-type{width:25%}.ot-sdk-cookie-policy[dir=rtl]{text-align:left}#ot-sdk-cookie-policy h3{font-size:1.5em}@media only screen and (max-width: 530px){.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) table,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) thead,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tbody,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) th,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr{display:block}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) thead tr{position:absolute;top:-9999px;left:-9999px}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr{margin:0 0 1em 0}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr:nth-child(odd),.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr:nth-child(odd) a{background:#f6f6f4}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td:before{position:absolute;height:100%;left:6px;width:40%;padding-right:10px}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) .ot-mobile-border{display:inline-block;background-color:#e4e4e4;position:absolute;height:100%;top:0;left:45%;width:2px}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td:before{content:attr(data-label);font-weight:bold}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) li{word-break:break-word;word-wrap:break-word}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table{overflow:hidden}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table td{border:none;border-bottom:1px solid #d7d7d7}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy thead,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy tbody,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy tr{display:block}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-host,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-cookies-type{width:auto}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy tr{margin:0 0 1em 0}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td:before{height:100%;width:40%;padding-right:10px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td:before{content:attr(data-label);font-weight:bold}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy li{word-break:break-word;word-wrap:break-word}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy thead tr{position:absolute;top:-9999px;left:-9999px;z-index:-9999}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr:last-child td{border-bottom:1px solid #d7d7d7;border-right:0px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr:last-child td:last-child{border-bottom:0px}}
                
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h5,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h6,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy li,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy p,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy span,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description {
                        color: #404242;
                    }
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th {
                        color: #404242;
                    }
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group {
                        color: #404242;
                    }
                    
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-title {
                            color: #404242;
                        }
                    
            
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table th {
                            background-color: #F8F8F8;
                        }
                    
            .ot-floating-button__front{background-image:url('https://ot.www.cloudflare.com/public/vendor/onetrust/consent/b1e05d49-f072-4bae-9116-bdb78af15448/018debfb-4917-76f1-8862-8a2f83812baa/logos/static/ot_persistent_cookie_icon.png')}</style><script>(function(w,d){;w.zarazData.executed.push("AllTracks");})(window,document)</script><script>(function(w,d){{(function(w,d){zaraz.__zarazMCListeners={"google-analytics_v4_nzcr":["visibilityChange"]};})(window,document);}})(window,document)</script></head><body><astro-island uid="ZNpN1O" component-url="/_astro/GoogleAnalytics.BZlu7bbu.js" component-export="GoogleAnalytics" renderer-url="/_astro/client.BQCS8AJJ.js" props="{&quot;title&quot;:[0,&quot;Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging&quot;],&quot;canonical&quot;:[0,&quot;https://blog.cloudflare.com/h3i&quot;],&quot;info&quot;:[0,{&quot;id&quot;:[0,&quot;2yX9ADcaKBprzyI9BaBoqN&quot;],&quot;title&quot;:[0,&quot;Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging&quot;],&quot;slug&quot;:[0,&quot;h3i&quot;],&quot;excerpt&quot;:[0,&quot;h3i is a command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;<p>Have you ever built a piece of IKEA furniture, or put together a LEGO set, by following the instructions closely and only at the end realized at some point you didn&amp;#39;t <i>quite</i> follow them correctly? The final result might be close to what was intended, but there&amp;#39;s a nagging thought that maybe, just maybe, it&amp;#39;s not as rock steady or functional as it could have been.</p><p>Internet protocol specifications are instructions designed for engineers to build things. Protocol designers take great care to ensure the documents they produce are clear. The standardization process gathers consensus and review from experts in the field, to further ensure document quality. Any reasonably skilled engineer should be able to take a specification and produce a performant, reliable, and secure implementation. The Internet is central to everyone&amp;#39;s lives, and we depend on these implementations. Any deviations from the specification can put us at risk. For example, mishandling of malformed requests can allow attacks such as <a href=\&quot;https://en.wikipedia.org/wiki/HTTP_request_smuggling\&quot;><u>request smuggling</u></a>.</p><p>h3i is a binary command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC. <a href=\&quot;https://crates.io/crates/h3i\&quot;><u>h3i</u></a> is free and open source as part of Cloudflare&amp;#39;s <a href=\&quot;https://github.com/cloudflare/quiche\&quot;><u>quiche</u></a> project. In this post we&amp;#39;ll explain the motivation behind developing h3i, how we use it to help develop robust and safe standards-compliant software and production systems, and how you can similarly use it to test your own software or services. If you just want to jump into how to use h3i, go to the <a href=\&quot;#the-h3i-command-line-tool\&quot;><u>h3i command line tool</u></a> section.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;a-recap-of-quic-and-http-3\&quot;>A recap of QUIC and HTTP/3</h2>\n            <a href=\&quot;#a-recap-of-quic-and-http-3\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p><a href=\&quot;https://blog.cloudflare.com/http3-the-past-present-and-future/\&quot;><u>QUIC</u></a> is a secure-by-default transport protocol that provides performance advantages compared to TCP and TLS via a more efficient handshake, along with stream multiplexing that provides <a href=\&quot;https://en.wikipedia.org/wiki/Head-of-line_blocking\&quot;><u>head-of-line blocking</u></a> avoidance. <a href=\&quot;https://www.cloudflare.com/en-gb/learning/performance/what-is-http3/\&quot;><u>HTTP/3</u></a> is an application protocol that maps HTTP semantics to QUIC, such as defining how HTTP requests and responses are assigned to individual QUIC streams.</p><p>Cloudflare has supported QUIC on our global network in some shape or form <a href=\&quot;https://blog.cloudflare.com/http3-the-past-present-and-future/\&quot;><u>since 2018</u></a>. We started while the <a href=\&quot;https://ietf.org/\&quot;><u>Internet Engineering Task Force (IETF)</u></a> was earnestly standardizing the protocol, working through early iterations and using interoperability testing and experience to help provide feedback for the standards process. We <a href=\&quot;https://blog.cloudflare.com/quic-version-1-is-live-on-cloudflare/\&quot;><u>launched support</u></a> for QUIC version 1 and HTTP/3 as soon as <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000\&quot;><u>RFC 9000</u></a> (and its accompanying specifications) were published in 2021.</p><p>We work on the Protocols team, who own the ingress proxy into the Cloudflare network. This is essentially Cloudflare’s “front door” — HTTP requests that come to Cloudflare from the Internet pass through us first. The majority of requests are passed onwards to things like rulesets, workers, caches, or a customer origin. However, you might be surprised that many requests don&amp;#39;t ever make it that far because they are, in some way, invalid or malformed. Servers listening on the Internet have to be robust to traffic that is not RFC compliant, whether caused by accident or malicious intent.</p><p>The Protocols team actively participates in IETF standardization work and has also helped build and maintain other Cloudflare services that leverage quiche for QUIC and HTTP/3, from the proxies that help <a href=\&quot;https://blog.cloudflare.com/icloud-private-relay/\&quot;><u>iCloud Private Relay</u></a> via <a href=\&quot;https://blog.cloudflare.com/unlocking-quic-proxying-potential/\&quot;><u>MASQUE proxying</u></a>, to replacing <a href=\&quot;https://blog.cloudflare.com/zero-trust-warp-with-a-masque/\&quot;><u>WARP&amp;#39;s use of Wireguard with MASQUE</u></a>, and beyond.</p><p>Throughout all of these different use cases, it is important for us to extensively test all aspects of the protocols. A deep dive into protocol details is a blog post (or three) in its own right. So let&amp;#39;s take a thin slice across HTTP to help illustrate the concepts.</p><p><a href=\&quot;https://www.rfc-editor.org/rfc/rfc9110.html\&quot;><u>HTTP Semantics</u></a> are common to all versions of HTTP — the overall architecture, terminology, and protocol aspects such as request and response messages, methods, status codes, header and trailer fields, message content, and much more. Each individual HTTP version defines how semantics are transformed into a &amp;quot;wire format&amp;quot; for exchange over the Internet. You can read more about HTTP/1.1 and HTTP/2 in some of our previous <a href=\&quot;https://blog.cloudflare.com/a-primer-on-proxies/\&quot;><u>blog</u></a> <a href=\&quot;https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\&quot;><u>posts</u></a>.</p><p>With HTTP/3, HTTP request and response messages are split into a series of binary frames. <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-7.2.2\&quot;><u>HEADERS</u></a> frames carry a representation of HTTP metadata (method, path, status code, field lines). The payload of the frame is the encoded <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9204\&quot;><u>QPACK</u></a> compression output. <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-7.2.1\&quot;><u>DATA</u></a> frames carry <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9110#section-6.4.1\&quot;><u>HTTP content</u></a> (aka &amp;quot;message body&amp;quot;). In order to exchange these frames, HTTP/3 relies on QUIC <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000#section-2\&quot;><u>streams</u></a>. These provide an ordered and reliable byte stream and each have an identifier (ID) that is unique within the scope of a connection. There are <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000#section-2.1\&quot;><u>four different stream types</u></a>, denominated by the two least significant bits of the ID.</p><p>As a simple example, assuming a QUIC connection has already been established, a client can make a GET request and receive a 200 OK response with an HTML body using the follow sequence:</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7vVfQ5CYaaVPVmGloRUnkI/88bd727c3526e540bd493bc15fbe904a/unnamed.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1222\&quot; height=\&quot;1392\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><ol><li><p>Client allocates the first available client-initiated bidirectional QUIC stream. (The IDs start at 0, then 4, 8, 12 and so on)</p></li><li><p>Client sends the request HEADERS frame on the stream and sets the stream&amp;#39;s <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000#section-19.8\&quot;><u>FIN bit</u></a> to mark the end of stream.</p></li><li><p>Server receives the request HEADERS frame and validates it against <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2\&quot;><u>RFC 9114 rules</u></a>. If accepted, it processes the request and prepares the response.</p></li><li><p>Server sends the response HEADERS frame on the same stream.</p></li><li><p>Server sends the response DATA frame on the same stream and sets the FIN bit.</p></li><li><p>Client receives the response frames and validates them. If accepted, the content is presented to the user.</p></li></ol><p>At the QUIC layer, stream data is split into STREAM frames, which are sent in QUIC packets over UDP. QUIC deals with any loss detection and recovery, helping to ensure stream data is reliable. The layer cake diagram below provides a handy comparison of how HTTP/1.1, HTTP/2 and HTTP/3 use TCP, UDP and IP.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4049UpKGn4BJcYcEXSFgWz/32143a5ba3672786639908ad96851225/image2.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1590\&quot; height=\&quot;1130\&quot; loading=\&quot;lazy\&quot;/>\n          </figure>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;background-on-testing-quic-and-http-3-at-cloudflare\&quot;>Background on testing QUIC and HTTP/3 at Cloudflare</h2>\n            <a href=\&quot;#background-on-testing-quic-and-http-3-at-cloudflare\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The Protocols team has a diverse set of automated test tools that exercise our ingress proxy software in order to ensure it can stand up to the deluge that the Internet can throw at it. Just like a bouncer at a nightclub front door, we need to prevent as much bad traffic as possible before it gets inside and potentially causes damage.</p><p>HTTP/2 and HTTP/3 share several concepts. When we started developing early HTTP/3 support, we&amp;#39;d already learned a lot from production experience with HTTP/2. While HTTP/2 addressed many issues with HTTP/1.1 (especially problems like <a href=\&quot;https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf\&quot;><u>request smuggling</u></a>, caused by its ASCII-based message delineation), HTTP/2 also added complexity and new avenues for attack. Security is an ongoing process, and the Protocols team continually hardens our software and systems to threats. For example, mitigating the range of <a href=\&quot;https://blog.cloudflare.com/on-the-recent-http-2-dos-attacks/\&quot;><u>denial-of-service attacks</u></a> identified by Netflix in 2019, or the <a href=\&quot;https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\&quot;><u>HTTP/2 Rapid Reset</u></a> attacks of 2023.</p><p>For testing HTTP/2, we rely on the Python <a href=\&quot;https://pypi.org/project/requests/\&quot;><u>Requests</u></a> library for testing conventional HTTP exchanges. However, that mostly only exercises HEADERS and DATA frames. There are eight other frame types and a plethora of ways that they can interact (hence the new attack vectors mentioned above). In order to get full testing coverage, we have to break down into the lower layer <a href=\&quot;https://pypi.org/project/h2/\&quot;><u>h2</u></a> library, which allows exact frame-by-frame control. However, even that is not always enough. Libraries tend to want to follow the RFC rules and prevent their users from doing &amp;quot;the wrong thing&amp;quot;. This is entirely logical for most purposes. For our needs though, we need to take off the safety guards just like any potential attackers might do. We have a few cases where the best way to exercise certain traffic patterns is to handcraft HTTP/2 frames in a hex editor, store that as binary, and replay it with a tool such as <a href=\&quot;https://docs.openssl.org/1.0.2/man1/s_client/\&quot;><u>OpenSSL s_client</u></a>.</p><p>We knew we&amp;#39;d need similar testing approaches for HTTP/3. However, when we started in 2018, there weren&amp;#39;t many other suitable client implementations. The rate of iteration on the specifications also meant it was hard to always keep in sync. So we built tests on quiche, using a mix of our <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/apps/src/client.rs\&quot;><u>quiche-client</u></a> and <a href=\&quot;https://github.com/cloudflare/quiche/tree/master/tools/http3_test\&quot;><u>http3_test</u></a>. Over time, the python library <a href=\&quot;https://github.com/aiortc/aioquic\&quot;><u>aioquic</u></a> has matured, and we have used it to add a range of lower-layer tests that break or bend HTTP/3 rules, in order to prove our proxies are robust.</p><p>Finally, we would be remiss not to mention that all the tests in our ingress proxy are <b>in addition to </b>the suite of over 500 integration tests that run on the quiche project itself.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;making-http-3-testing-more-accessible-and-maintainable-with-h3i\&quot;>Making HTTP/3 testing more accessible and maintainable with h3i</h2>\n            <a href=\&quot;#making-http-3-testing-more-accessible-and-maintainable-with-h3i\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>While we are happy with the coverage of our current tests, the smorgasbord of test tools makes it hard to know what to reach for when adding new tests. For example, we&amp;#39;ve had cases where aioquic&amp;#39;s safety guards prevent us from doing something, and it has needed a patch or workaround. This sort of thing requires a time investment just to debug/develop the tests.</p><p>We believe it shouldn&amp;#39;t take a protocol or code expert to develop what are often very simple to describe tests. While it is important to provide guide rails for the majority of conventional use cases, it is also important to provide accessible methods for taking them off.</p><p>Let&amp;#39;s consider a simple example. In HTTP/3 there is something called the control stream. It&amp;#39;s used to exchange frames such as SETTINGS, which affect the HTTP/3 connection. RFC 9114 <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-6.2.1\&quot;><u>Section 6.2.1</u></a> states:</p><blockquote><p><i>Each side MUST initiate a single control stream at the beginning of the connection and send its SETTINGS frame as the first frame on this stream. If the first frame of the control stream is any other frame type, this MUST be treated as a connection error of type H3_MISSING_SETTINGS. Only one control stream per peer is permitted; receipt of a second stream claiming to be a control stream MUST be treated as a connection error of type H3_STREAM_CREATION_ERROR. The sender MUST NOT close the control stream, and the receiver MUST NOT request that the sender close the control stream. If either control stream is closed at any point, this MUST be treated as a connection error of type H3_CLOSED_CRITICAL_STREAM. Connection errors are described in Section 8.</i></p></blockquote><p>There are many tests we can conjure up just from that paragraph:</p><ol><li><p>Send a non-SETTINGS frame as the first frame on the control stream.</p></li><li><p>Open two control streams.</p></li><li><p>Open a control stream and then close it with a FIN bit.</p></li><li><p>Open a control stream and then reset it with a RESET_STREAM QUIC frame.</p></li><li><p>Wait for the peer to open a control stream and then ask for it to be reset with a STOP_SENDING QUIC frame.</p></li></ol><p>All of the above actions should cause a remote peer that has implemented the RFC properly to close the connection. Therefore, it is not in the interest of the local client or server applications to ever do these actions.</p><p>Many QUIC and HTTP/3 implementations are developed as libraries that are integrated into client or server applications. There may be an extensive set of unit or integration tests of the library checking RFC rules. However, it is also important to run the same tests on the integrated assembly of library and application, since it&amp;#39;s all too common that an unhandled/mishandled library error can cascade to cause issues in upper layers. For instance, the HTTP/2 Rapid Reset attacks affected Cloudflare due to their <a href=\&quot;https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/#impact-on-customers\&quot;><u>impact on how one service spoke to another</u></a>.</p><p>We&amp;#39;ve developed h3i, a command line tool and library, to make testing more accessible and maintainable for all. We started with a client that can exercise servers, since that&amp;#39;s what our focus has been. Future developments could support the opposite, a server that behaves in unusual ways in order to exercise clients.</p><p><b>Note: </b>h3i is <i>not</i> intended to be a production client! Its flexibility may cause issues that are not observed in other production-oriented clients. It is also not intended to be used for any type of performance testing and measurement.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;the-h3i-command-line-tool\&quot;>The h3i command line tool</h2>\n            <a href=\&quot;#the-h3i-command-line-tool\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The primary purpose of the h3i command line tool is quick low-level debugging and exploratory testing. Rather than worrying about writing code or a test script, users can quickly run an ad-hoc client test against a target, guided by interactive prompts.</p><p>In the simplest case, you can think of h3i a bit like <a href=\&quot;https://curl.se/\&quot;><u>curl</u></a> but with access to some extra HTTP/3 parameters. In the example below, we issue a request to <a href=\&quot;https://cloudflare-quic.com\&quot;><u>https://cloudflare-quic.com</u></a>/ and receive a response.</p><div style=\&quot;position: relative; padding-top: 70.91172214182345%;\&quot;>\n  <iframe\n    src=\&quot;https://customer-eq7kiuol0tk9chox.cloudflarestream.com/b1dadea8189831a6220d318d688d0ef8/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2Fb1dadea8189831a6220d318d688d0ef8%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600\&quot;\n    loading=\&quot;lazy\&quot;\n    style=\&quot;border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;\&quot;\n    allow=\&quot;accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;\&quot;\n    allowfullscreen=\&quot;true\&quot;\n  ></iframe>\n</div><p>Walking through a simple GET with h3i step-by-step:</p><ol><li><p>Grab a copy of the h3i binary either by running <code>cargo install h3i</code> or cloning the quiche source repo at <a href=\&quot;https://github.com/cloudflare/quiche/\&quot;><u>https://github.com/cloudflare/quiche/</u></a>. Both methods assume you have some familiarity with Rust and Cargo. See the cargo <a href=\&quot;https://doc.rust-lang.org/book/ch14-04-installing-binaries.html\&quot;><u>documentation</u></a> for more information.</p><ol><li><p><code>cargo install</code> will place the binary on your path, so you can then just run it by executing <code>h3i</code>.</p></li><li><p>If running from source, navigate to the quiche/h3i directory and then use <code>cargo run</code>.</p></li></ol></li><li><p>Run the binary and provide the name and port of the target server. If the port is omitted, the default value 443 is assumed. E.g, <code>cargo run cloudflare-quic.com</code></p></li><li><p>h3i then enters the action prompting phase. A series of one or more HTTP/3 actions can be queued up, such as sending frames, opening or terminating streams, or waiting on data from the server. The full set of options is documented in the <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/h3i/README.md#command-line-tool\&quot;><u>readme</u></a>.</p><ol><li><p>The prompting interface adapts to keyboard inputs and supports tab completion.</p></li><li><p>In the example above, the <code>headers</code> action is selected, which walks through populating the fields in a HEADERS frame. It includes <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-4.3.1\&quot;><u>mandatory fields</u></a> from RFC 9114 for convenience. If a test requires omitting these, the <code>headers_no_pseudo</code> can be used instead.</p></li></ol></li><li><p>The <code>commit</code> prompt choice finalizes the action list and moves to the connection phase. h3i initiates a QUIC connection to the server identified in step 2. Once connected, actions are executed in order.</p></li><li><p>By default, h3i reports some limited information about the frames the server sent. To get more detailed information, the <code>RUST_LOG</code> environment can be set with either <code>debug</code> or <code>trace</code> levels.</p></li></ol>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;instant-record-and-replay-powered-by-qlog\&quot;>Instant record and replay, powered by qlog</h2>\n            <a href=\&quot;#instant-record-and-replay-powered-by-qlog\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>It can be fun to play around with the h3i command line tool to see how different servers respond to different combinations or sequences of actions. Occasionally, you&amp;#39;ll find a certain set that you want to run over and over again, or share with a friend or colleague. Having to manually enter the prompts repeatedly, or share screenshots of the h3i input can turn tedious. Fortunately, h3i records all the actions in a log file by default — the file path is printed immediately after h3i starts. The format of this file is based on <a href=\&quot;https://datatracker.ietf.org/doc/html/draft-ietf-quic-qlog-main-schema\&quot;><u>qlog</u></a>, an in-progress standard in development at the IETF for network protocol logging. It’s a perfect fit for our low-level needs.</p><p>Here&amp;#39;s an example h3i qlog file:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>{&amp;quot;qlog_version&amp;quot;:&amp;quot;0.3&amp;quot;,&amp;quot;qlog_format&amp;quot;:&amp;quot;JSON-SEQ&amp;quot;,&amp;quot;title&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;trace&amp;quot;:{&amp;quot;vantage_point&amp;quot;:{&amp;quot;type&amp;quot;:&amp;quot;client&amp;quot;},&amp;quot;title&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;configuration&amp;quot;:{&amp;quot;time_offset&amp;quot;:0.0}}}\n{\n  &amp;quot;time&amp;quot;: 0.172783,\n  &amp;quot;name&amp;quot;: &amp;quot;http:frame_created&amp;quot;,\n  &amp;quot;data&amp;quot;: {\n    &amp;quot;stream_id&amp;quot;: 0,\n    &amp;quot;frame&amp;quot;: {\n      &amp;quot;frame_type&amp;quot;: &amp;quot;headers&amp;quot;,\n      &amp;quot;headers&amp;quot;: [\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:method&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;GET&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:authority&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;cloudflare-quic.com&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:path&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;/&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:scheme&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;https&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;user-agent&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;h3i&amp;quot;\n        }\n      ]\n    }\n  },\n  &amp;quot;fin_stream&amp;quot;: true\n}</pre></code>\n            <p>h3i logs can be replayed using the <code>--qlog-input</code> option. You can change the target server host and port, and keep all the same actions. However, most servers will validate the :authority pseudo-header or Host header contained in a HEADERS frame. The --replay-host-override option allows changing these fields without needing to modify the file by hand.</p><p>And yes, qlog files are human-readable text in the JSON-SEQ format. So you can also just write these by hand in the first place if you like! However, if you&amp;#39;re going to start writing things, maybe Rust is your preferred option…</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;using-the-h3i-library-to-send-a-malformed-request-with-rust\&quot;>Using the h3i library to send a malformed request with Rust</h2>\n            <a href=\&quot;#using-the-h3i-library-to-send-a-malformed-request-with-rust\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>In our previous example, we just sent a valid request so there wasn&amp;#39;t anything interesting to observe. Where h3i really shines is in generating traffic that isn&amp;#39;t RFC compliant, such as malformed HTTP messages, invalid frame sequences, or other actions on streams. This helps determine if a server is acting robustly and defensively.</p><p>Let&amp;#39;s explore this more with an example of HTTP content-length mismatch. RFC 9114 <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2\&quot;><u>section 4.1.2</u></a> specifies:</p><blockquote><p><i>A request or response that is defined as having content when it contains a Content-Length header field (Section 8.6 of [HTTP]) is malformed if the value of the Content-Length header field does not equal the sum of the DATA frame lengths received. A response that is defined as never having content, even when a Content-Length is present, can have a non-zero Content-Length header field even though no content is included in DATA frames.</i></p><p><i>Intermediaries that process HTTP requests or responses (i.e., any intermediary not acting as a tunnel) MUST NOT forward a malformed request or response. Malformed requests or responses that are detected MUST be treated as a stream error of type H3_MESSAGE_ERROR.</i></p><p><i>For malformed requests, a server MAY send an HTTP response indicating the error prior to closing or resetting the stream.</i></p></blockquote><p>There are good reasons that the RFC is so strict about handling mismatched content lengths. They can be a vector for <a href=\&quot;https://portswigger.net/research/http2\&quot;><u>desynchronization attacks</u></a> (similar to request smuggling), especially when a proxy is converting inbound HTTP/3 to outbound HTTP/1.1.</p><p>We&amp;#39;ve provided an <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/h3i/examples/content_length_mismatch.rs\&quot;><u>example</u></a> of how to use the h3i Rust library to write a tailor-made test client that sends a mismatched content length request. It sends a Content-Length header of 5, but its body payload is “test”, which is only 4 bytes. It then waits for the server to respond, after which it explicitly closes the connection by sending a QUIC CONNECTION_CLOSE frame.</p><p>When running low-level tests, it can be interesting to also take a packet capture (<a href=\&quot;https://en.wikipedia.org/wiki/Pcap\&quot;><u>pcap</u></a>) and observe what is happening on the wire. Since QUIC is an encrypted transport, we&amp;#39;ll need to use the SSLKEYLOG environment variable to capture the session keys so that tools like Wireshark can <a href=\&quot;https://wiki.wireshark.org/TLS#using-the-pre-master-secret\&quot;><u>decrypt and dissect</u></a>.</p><p>To follow along at home, clone a copy of the quiche repository, start a packet capture on the appropriate network interface and then run:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>cd quiche/h3i\nSSLKEYLOGFILE=&amp;quot;h3i-example.keys&amp;quot; cargo run --example content_length_mismatch</pre></code>\n            <p>In our decrypted capture, we see the expected sequence of handshake, request, response, and then closure.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6Qkdd3h0x826tH95S61u92/5de829e018b9d3ef409a2452362fa81e/image1.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;1096\&quot; loading=\&quot;lazy\&quot;/>\n          </figure>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;surveying-the-example-code\&quot;>Surveying the example code</h2>\n            <a href=\&quot;#surveying-the-example-code\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/h3i/examples/content_length_mismatch.rs\&quot;><u>example</u></a> is a simple binary app with a <code>main()</code> entry point. Let&amp;#39;s survey the key elements.</p><p>First, we set up an h3i configuration to a target server:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>let config = Config::new()\n        .with_host_port(&amp;quot;cloudflare-quic.com&amp;quot;.to_string())\n        .with_idle_timeout(2000)\n        .build()\n        .unwrap();</pre></code>\n            <p>The idle timeout is a QUIC concept which tells each endpoint when it should close the connection if the connection has been idle. This prevents endpoints from spinning idly if the peer hasn’t closed the connection. h3i’s default is 30 seconds, which can be too long for tests, so we set ours to 2 seconds here.</p><p>Next, we define a set of request headers and encode them with QPACK compression, ready to put in a HEADERS frame. Note that h3i does provide a <a href=\&quot;https://docs.rs/h3i/latest/h3i/actions/h3/fn.send_headers_frame.html\&quot;><u>send_headers_frame</u></a> helper method which does this for you, but the example does it manually for clarity:</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>let headers = vec![\n        Header::new(b&amp;quot;:method&amp;quot;, b&amp;quot;POST&amp;quot;),\n        Header::new(b&amp;quot;:scheme&amp;quot;, b&amp;quot;https&amp;quot;),\n        Header::new(b&amp;quot;:authority&amp;quot;, b&amp;quot;cloudflare-quic.com&amp;quot;),\n        Header::new(b&amp;quot;:path&amp;quot;, b&amp;quot;/&amp;quot;),\n        // We say that we&amp;#039;re going to send a body with 5 bytes...\n        Header::new(b&amp;quot;content-length&amp;quot;, b&amp;quot;5&amp;quot;),\n    ];\n\n    let header_block = encode_header_block(&amp;amp;headers).unwrap();</pre></code>\n            <p>Then, we define the set of h3i actions that we want to execute in order: send HEADERS, send a too-short DATA frame, wait for the server&amp;#39;s HEADERS, then close the connection.</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>let actions = vec![\n        Action::SendHeadersFrame {\n            stream_id: STREAM_ID,\n            fin_stream: false,\n            headers,\n            frame: Frame::Headers { header_block },\n        },\n        Action::SendFrame {\n            stream_id: STREAM_ID,\n            fin_stream: true,\n            frame: Frame::Data {\n                // ...but, in actuality, we only send 4 bytes. This should yield a\n                // 400 Bad Request response from an RFC-compliant\n                // server: https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2-3\n                payload: b&amp;quot;test&amp;quot;.to_vec(),\n            },\n        },\n        Action::Wait {\n            wait_type: WaitType::StreamEvent(StreamEvent {\n                stream_id: STREAM_ID,\n                event_type: StreamEventType::Headers,\n            }),\n        },\n        Action::ConnectionClose {\n            error: quiche::ConnectionError {\n                is_app: true,\n                error_code: quiche::h3::WireErrorCode::NoError as u64,\n                reason: vec![],\n            },\n        },\n    ];</pre></code>\n            <p>Finally, we&amp;#39;ll set things in motion with <code>connect()</code>, which sets up the QUIC connection, executes the actions list and collects the summary.</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>let summary =\n        sync_client::connect(config, &amp;amp;actions).expect(&amp;quot;connection failed&amp;quot;);\n\n    println!(\n        &amp;quot;=== received connection summary! ===\\n\\n{}&amp;quot;,\n        serde_json::to_string_pretty(&amp;amp;summary).unwrap_or_else(|e| e.to_string())\n    );</pre></code>\n            <p><a href=\&quot;https://docs.rs/h3i/latest/h3i/client/connection_summary/struct.ConnectionSummary.html\&quot;><u>ConnectionSummary</u></a>&nbsp; provides data about the connection, including the frames h3i received, details about why the connection closed, and connection statistics. The example prints the summary out. However, you can programmatically check it. We do this to write our own internal automation tests.</p><p>If you&amp;#39;re running the example, it should print something like the following:</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>=== received connection summary! ===\n\n{\n  &amp;quot;stream_map&amp;quot;: {\n    &amp;quot;0&amp;quot;: [\n      {\n        &amp;quot;UNKNOWN&amp;quot;: {\n          &amp;quot;raw_type&amp;quot;: 2471591231244749708,\n          &amp;quot;payload&amp;quot;: &amp;quot;&amp;quot;\n        }\n      },\n      {\n        &amp;quot;UNKNOWN&amp;quot;: {\n          &amp;quot;raw_type&amp;quot;: 2031803309763646295,\n          &amp;quot;payload&amp;quot;: &amp;quot;4752454153452069732074686520776f7264&amp;quot;\n        }\n      },\n      {\n        &amp;quot;enriched_headers&amp;quot;: {\n          &amp;quot;header_block_len&amp;quot;: 75,\n          &amp;quot;headers&amp;quot;: [\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;:status&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;400&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;server&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;cloudflare&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;date&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;Sat, 07 Dec 2024 00:34:12 GMT&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;content-type&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;text/html&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;content-length&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;155&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;cf-ray&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;8ee06dbe2923fa17-ORD&amp;quot;\n            }\n          ]\n        }\n      },\n      {\n        &amp;quot;DATA&amp;quot;: {\n          &amp;quot;payload_len&amp;quot;: 104\n        }\n      },\n      {\n        &amp;quot;DATA&amp;quot;: {\n          &amp;quot;payload_len&amp;quot;: 51\n        }\n      }\n    ]\n  },\n  &amp;quot;stats&amp;quot;: {\n    &amp;quot;recv&amp;quot;: 10,\n    &amp;quot;sent&amp;quot;: 5,\n    &amp;quot;lost&amp;quot;: 0,\n    &amp;quot;retrans&amp;quot;: 0,\n    &amp;quot;sent_bytes&amp;quot;: 1712,\n    &amp;quot;recv_bytes&amp;quot;: 4178,\n    &amp;quot;lost_bytes&amp;quot;: 0,\n    &amp;quot;stream_retrans_bytes&amp;quot;: 0,\n    &amp;quot;paths_count&amp;quot;: 1,\n    &amp;quot;reset_stream_count_local&amp;quot;: 0,\n    &amp;quot;stopped_stream_count_local&amp;quot;: 0,\n    &amp;quot;reset_stream_count_remote&amp;quot;: 0,\n    &amp;quot;stopped_stream_count_remote&amp;quot;: 0,\n    &amp;quot;path_challenge_rx_count&amp;quot;: 0\n  },\n  &amp;quot;path_stats&amp;quot;: [\n    {\n      &amp;quot;local_addr&amp;quot;: &amp;quot;0.0.0.0:64418&amp;quot;,\n      &amp;quot;peer_addr&amp;quot;: &amp;quot;104.18.29.7:443&amp;quot;,\n      &amp;quot;active&amp;quot;: true,\n      &amp;quot;recv&amp;quot;: 10,\n      &amp;quot;sent&amp;quot;: 5,\n      &amp;quot;lost&amp;quot;: 0,\n      &amp;quot;retrans&amp;quot;: 0,\n      &amp;quot;rtt&amp;quot;: 0.008140072,\n      &amp;quot;min_rtt&amp;quot;: 0.004645536,\n      &amp;quot;rttvar&amp;quot;: 0.004238173,\n      &amp;quot;cwnd&amp;quot;: 13500,\n      &amp;quot;sent_bytes&amp;quot;: 1712,\n      &amp;quot;recv_bytes&amp;quot;: 4178,\n      &amp;quot;lost_bytes&amp;quot;: 0,\n      &amp;quot;stream_retrans_bytes&amp;quot;: 0,\n      &amp;quot;pmtu&amp;quot;: 1350,\n      &amp;quot;delivery_rate&amp;quot;: 247720\n    }\n  ],\n  &amp;quot;error&amp;quot;: {\n    &amp;quot;local_error&amp;quot;: {\n      &amp;quot;is_app&amp;quot;: true,\n      &amp;quot;error_code&amp;quot;: 256,\n      &amp;quot;reason&amp;quot;: &amp;quot;&amp;quot;\n    },\n    &amp;quot;timed_out&amp;quot;: false\n  }\n}\n</pre></code>\n            <p>Let’s walk through the output. Up first is the <a href=\&quot;https://docs.rs/h3i/latest/h3i/client/connection_summary/struct.StreamMap.html\&quot;><u>StreamMap</u></a>, which is a record of all frames received on each stream. We can see that we received 5 frames on stream 0: 2 UNKNOWNs, one <a href=\&quot;https://docs.rs/h3i/latest/h3i/frame/struct.EnrichedHeaders.html\&quot;><u>EnrichedHeaders</u></a> frame, and two DATA frames.</p><p>The UNKNOWN frames are extension frames that are unknown to h3i; the server under test is sending what are known as <a href=\&quot;https://datatracker.ietf.org/doc/draft-edm-protocol-greasing/\&quot;><u>GREASE</u></a> frames to help exercise the protocol and ensure clients are not erroring when they receive something unexpected per <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#extensions\&quot;><u>RFC 9114 requirements</u></a>.</p><p>The EnrichedHeaders frame is essentially an HTTP/3 HEADERS frame, but with some small helpers, like one to get the response status code. The server under test sent a 400 as expected.</p><p>The DATA frames carry response body bytes. In this case, the body is the HTML required to render the Cloudflare Bad Request page (you can peek at the HTML yourself in Wireshark). We chose to omit the raw bytes from the ConnectionSummary since they may not be representable safely as text. A future improvement could be to encode the bytes in base64 or hex, in order to support tests that need to check response content.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;h3i-for-test-automation\&quot;>h3i for test automation</h2>\n            <a href=\&quot;#h3i-for-test-automation\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>We believe h3i is a great library for building automated tests on. You can take the above example and modify it to fit within various types of (continuous) integration tests.</p><p>We outlined earlier how the Protocols team HTTP/3 testing has organically grown to use three different frameworks. Even within those, we still didn&amp;#39;t have much flexibility and ease of use. Over the last year we&amp;#39;ve been building h3i itself and reimplementing our suite of ingress proxy test cases using the Rust library. This has helped us improve test coverage with a range of new tests not previously possible. It also surprisingly identified some problems with the old tests, particularly for some edge cases where it wasn&amp;#39;t clear how the old test code implementation was running under the hood.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;bake-offs-interop-and-wider-testing-of-http\&quot;>Bake offs, interop, and wider testing of HTTP</h2>\n            <a href=\&quot;#bake-offs-interop-and-wider-testing-of-http\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p><a href=\&quot;https://datatracker.ietf.org/doc/html/rfc1025\&quot;><u>RFC 1025</u></a> was published in 1987. Authored by <a href=\&quot;https://icannwiki.org/Jon_Postel\&quot;><u>Jon Postel</u></a>, it discusses bake offs:</p><blockquote><p><i>In the early days of the development of TCP and IP, when there were very few implementations and the specifications were still evolving, the only way to determine if an implementation was &amp;quot;correct&amp;quot; was to test it against other implementations and argue that the results showed your own implementation to have done the right thing.&nbsp; These tests and discussions could, in those early days, as likely change the specification as change the implementation.</i></p><p><i>There were a few times when this testing was focused, bringing together all known implementations and running through a set of tests in hopes of demonstrating the N squared connectivity and correct implementation of the various tricky cases.&nbsp; These events were called &amp;quot;Bake Offs&amp;quot;.</i></p></blockquote><p>While nearly 4 decades old, the concept of exercising Internet protocol implementations and seeing how they compare to the specification still holds true. The QUIC WG made heavy use of interoperability testing through its standardization process. We started off sitting in a room and running tests manually by hand (or with some help from scripts). Then <a href=\&quot;https://seemann.io/\&quot;><u>Marten Seemann</u></a> developed the <a href=\&quot;https://interop.seemann.io/\&quot;><u>QUIC Interop Runner</u></a>, which runs regular automated testing and collects and renders all the results. This has proven to be incredibly useful.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2OGnVUbatoX8Ya2IO5RdCl/754316e004a8e658ac089e10e70b72ca/image6.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1797\&quot; height=\&quot;780\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p>The state of HTTP/3 interoperability testing is not quite as mature. Although there are tools such as <a href=\&quot;https://kazu-yamamoto.hatenablog.jp/\&quot;><u>Kazu Yamamoto&amp;#39;s</u></a> excellent <a href=\&quot;https://github.com/kazu-yamamoto/h3spec\&quot;><u>h3spec</u></a> (in Haskell) for testing conformance, there isn&amp;#39;t a similar continuous integration process of collection and rendering of results. While h3i shares similarities with h3spec, we felt it important to focus on the framework capabilities rather than creating a corpus of tests and assertions. Cloudflare is a big fan of Rust and as several teams move to Rust-based proxies, having a consistent ecosystem provides advantages (such as developer velocity).</p><p>We certainly feel there is a great opportunity for continued collaboration and cross-pollination between projects in the QUIC and HTTP space. For example, h3i might provide a suitable basis to build another tool (or set of scripts) to run bake offs or interop tests. Perhaps it even makes sense to have a common collection of test cases owned by the community, that can be specialized to the most appropriate or preferred tooling. This topic was recently presented at the <a href=\&quot;https://github.com/HTTPWorkshop/workshop2024/blob/main/talks/5.%20Testing/testing.pdf\&quot;><u>HTTP Workshop 2024</u></a> by Mohammed Al-Sahaf, and it excites us to see <a href=\&quot;https://www.caffeinatedwonders.com/2024/12/18/towards-validated-http-implementation/\&quot;><u>new potential directions</u></a> of testing improvements.</p><p>When using any tools or methods for protocol testing, we encourage responsible handling of security-related matters. If you believe you may have identified a vulnerability in an IETF Internet protocol itself, please follow the IETF&amp;#39;s <a href=\&quot;https://www.ietf.org/standards/rfcs/vulnerabilities/\&quot;><u>reporting guidance</u></a>. If you believe you may have discovered an implementation vulnerability in a product, open source project, or service using QUIC or HTTP, then you should report these directly to the responsible party. Implementers or operators often provide their own publicly-available guidance and contact details to send reports. For example, the Cloudflare quiche <a href=\&quot;https://github.com/cloudflare/quiche/security/policy\&quot;><u>security policy</u></a> is available in the Security tab of the GitHub repository.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;summary-and-outlook\&quot;>Summary and outlook</h2>\n            <a href=\&quot;#summary-and-outlook\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Cloudflare takes testing very seriously. While h3i has a limited feature set as a test HTTP/3 client, we believe it provides a strong framework that can be extended to a wider range of different cases and different protocols. For example, we&amp;#39;d like to add support for low-level HTTP/2.</p><p>We&amp;#39;ve designed h3i to integrate into a wide range of testing methodologies, from manual ad-hoc testing, to native Rust tests, to conformance testbenches built with scripting languages. We&amp;#39;ve had great success migrating our existing zoo of test tools to a single one that is more accessible and easier to maintain.</p><p>Now that you&amp;#39;ve read about h3i&amp;#39;s capabilities, it&amp;#39;s left as an exercise to the reader to go back to the example of HTTP/3 control streams and consider how you could write tests to exercise a server.</p><p>We encourage the community to experiment with h3i and provide feedback, and propose ideas or contributions to the <a href=\&quot;https://github.com/cloudflare/quiche\&quot;><u>GitHub repository</u></a> as issues or Pull Requests.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5rp4YDTbXm37OxK7dtjiKF/816c0eed08926b7d34842f4769808277/image4.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1200\&quot; height=\&quot;304\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p>&quot;],&quot;published_at&quot;:[0,&quot;2024-12-30T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-12-30T14:00:03.282Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/260wIGiNfe3xebQgH4ihCO/974a2495b393d6f632479c394e5a938d/image5.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;76HSdQ6sNz56VVQXRUhhSw&quot;],&quot;name&quot;:[0,&quot;QUIC&quot;],&quot;slug&quot;:[0,&quot;quic&quot;]}],[0,{&quot;id&quot;:[0,&quot;4mFivBDCciYNedwQVKLKAg&quot;],&quot;name&quot;:[0,&quot;HTTP3&quot;],&quot;slug&quot;:[0,&quot;http3&quot;]}],[0,{&quot;id&quot;:[0,&quot;2IqedHUSRwmUemBf4R5nUa&quot;],&quot;name&quot;:[0,&quot;Testing&quot;],&quot;slug&quot;:[0,&quot;testing&quot;]}],[0,{&quot;id&quot;:[0,&quot;7ihMshJdu4QleFdxzaQA87&quot;],&quot;name&quot;:[0,&quot;Protocols&quot;],&quot;slug&quot;:[0,&quot;protocols&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Lucas Pardue&quot;],&quot;slug&quot;:[0,&quot;lucas&quot;],&quot;bio&quot;:[0,&quot;HTTP/2, HTTP/3 and QUIC @Cloudflare. IETF QUIC WG Co-Chair. I write some words, some code and occasionally speak.&quot;],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1k0fbniT2p2wjRfMognV4V/dca8d2e3a3e7fa4e24d7ddd9832eff1d/lucas.jpg&quot;],&quot;location&quot;:[0,&quot;London&quot;],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,&quot;@SimmerVigor&quot;],&quot;facebook&quot;:[0,null]}],[0,{&quot;name&quot;:[0,&quot;Evan Rittenhouse&quot;],&quot;slug&quot;:[0,&quot;evan-rittenhouse&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6TRFlHnVIfXX2cQhjt7wuc/86f2173516450dfa1e035b04cd4671c6/Screenshot_2024-12-21_at_17.56.35.png&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;h3i is a command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC. Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/h3i&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging&quot;],&quot;description&quot;:[0,&quot;Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/49kGUhFhN2iZIdcgGwDL6l/9f70e5deb1d4148f41be228340633c66/Open_sourcing_h3i-_a_command_line_tool_and_library_for_low-level_HTTP_3_testing_and_debugging-OG.png&quot;]}]}],&quot;tagInfo&quot;:[0],&quot;authorInfo&quot;:[0],&quot;translatedPosts&quot;:[1,[]]}" client="only" opts="{&quot;name&quot;:&quot;GoogleAnalytics&quot;,&quot;value&quot;:&quot;react&quot;}"></astro-island><script>(()=>{var i=t=>{let e=async()=>{await(await t())()};"requestIdleCallback"in window?window.requestIdleCallback(e):setTimeout(e,200)};(self.Astro||(self.Astro={})).idle=i;window.dispatchEvent(new Event("astro:idle"));})();</script><astro-island uid="1bQatl" prefix="r3" component-url="/_astro/Navigation.WgR_RIZt.js" component-export="Navigation" renderer-url="/_astro/client.BQCS8AJJ.js" props="{&quot;title&quot;:[0,&quot;The Cloudflare Blog&quot;],&quot;logo&quot;:[0,&quot;//images.ctfassets.net/zkvhlag99gkb/69RwBidpiEHCDZ9rFVVk7T/092507edbed698420b89658e5a6d5105/CF_logo_stacked_blktype.png&quot;],&quot;pagesStore&quot;:[0,{&quot;page&quot;:[0,&quot;Post&quot;],&quot;slug&quot;:[0,&quot;h3i&quot;],&quot;translationsAvailable&quot;:[1,[]],&quot;navData&quot;:[1,[[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;6QktrXeEFcl4e2dZUTZVGl&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:20.198Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:36:40.437Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,11],&quot;revision&quot;:[0,5],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Product News&quot;],&quot;name&quot;:[0,&quot;Product News&quot;],&quot;slug&quot;:[0,&quot;product-news&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;5kZtWqjqa7aOUoZr8NFGwI&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:26.040Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:30:22.751Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,5],&quot;revision&quot;:[0,3],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Cloudflare Radar&quot;],&quot;name&quot;:[0,&quot;Radar&quot;],&quot;slug&quot;:[0,&quot;cloudflare-radar&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;J61Eszqn98amrYHq4IhTx&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:46.068Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:27:04.797Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,15],&quot;revision&quot;:[0,8],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Zero Trust&quot;],&quot;name&quot;:[0,&quot;Zero Trust&quot;],&quot;slug&quot;:[0,&quot;zero-trust&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;48r7QV00gLMWOIcM1CSDRy&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:54:22.790Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:25:45.018Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,13],&quot;revision&quot;:[0,7],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Speed &amp; Reliability&quot;],&quot;name&quot;:[0,&quot;Speed &amp; Reliability&quot;],&quot;slug&quot;:[0,&quot;speed-and-reliability&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;6Mp7ouACN2rT3YjL1xaXJx&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:42:46.231Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:24:54.845Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,11],&quot;revision&quot;:[0,6],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Security&quot;],&quot;name&quot;:[0,&quot;Security&quot;],&quot;slug&quot;:[0,&quot;security&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;4HIPcb68qM0e26fIxyfzwQ&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:21.536Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:23:10.574Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,13],&quot;revision&quot;:[0,7],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Developers&quot;],&quot;name&quot;:[0,&quot;Developers&quot;],&quot;slug&quot;:[0,&quot;developers&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;6Foe3R8of95cWVnQwe5Toi&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T22:44:28.803Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:21:42.459Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,17],&quot;revision&quot;:[0,9],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;AI&quot;],&quot;name&quot;:[0,&quot;AI&quot;],&quot;slug&quot;:[0,&quot;ai&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;16yk8DVbNNifxov5cWvAov&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:56:23.848Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:19:20.134Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,8],&quot;revision&quot;:[0,4],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Policy &amp; Legal&quot;],&quot;name&quot;:[0,&quot;Policy &amp; Legal&quot;],&quot;slug&quot;:[0,&quot;policy&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;V86khSc459Yi1AhTlvtY7&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:46:53.657Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-12-12T01:18:59.839Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,18],&quot;revision&quot;:[0,9],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Partners&quot;],&quot;name&quot;:[0,&quot;Partners&quot;],&quot;slug&quot;:[0,&quot;partners&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;4g8tPriKOAUwdUT4jNPebe&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:46:40.927Z&quot;],&quot;updatedAt&quot;:[0,&quot;2024-10-10T07:05:21.343Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,9],&quot;revision&quot;:[0,5],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Life at Cloudflare&quot;],&quot;name&quot;:[0,&quot;Life at Cloudflare&quot;],&quot;slug&quot;:[0,&quot;life-at-cloudflare&quot;],&quot;featured&quot;:[0,true]}]}]]]}],&quot;locale&quot;:[0,&quot;en-us&quot;],&quot;translations&quot;:[0,{&quot;posts.by&quot;:[0,&quot;By&quot;],&quot;footer.gdpr&quot;:[0,&quot;GDPR&quot;],&quot;lang_blurb1&quot;:[0,&quot;This post is also available in {lang1}.&quot;],&quot;lang_blurb2&quot;:[0,&quot;This post is also available in {lang1} and {lang2}.&quot;],&quot;lang_blurb3&quot;:[0,&quot;This post is also available in {lang1}, {lang2} and {lang3}.&quot;],&quot;footer.press&quot;:[0,&quot;Press&quot;],&quot;header.title&quot;:[0,&quot;The Cloudflare Blog&quot;],&quot;search.clear&quot;:[0,&quot;Clear&quot;],&quot;search.filter&quot;:[0,&quot;Filter&quot;],&quot;search.source&quot;:[0,&quot;Source&quot;],&quot;footer.careers&quot;:[0,&quot;Careers&quot;],&quot;footer.company&quot;:[0,&quot;Company&quot;],&quot;footer.support&quot;:[0,&quot;Support&quot;],&quot;footer.the_net&quot;:[0,&quot;theNet&quot;],&quot;search.filters&quot;:[0,&quot;Filters&quot;],&quot;footer.our_team&quot;:[0,&quot;Our team&quot;],&quot;footer.webinars&quot;:[0,&quot;Webinars&quot;],&quot;page.more_posts&quot;:[0,&quot;More posts&quot;],&quot;posts.time_read&quot;:[0,&quot;{time} min read&quot;],&quot;search.language&quot;:[0,&quot;Language&quot;],&quot;footer.community&quot;:[0,&quot;Community&quot;],&quot;footer.resources&quot;:[0,&quot;Resources&quot;],&quot;footer.solutions&quot;:[0,&quot;Solutions&quot;],&quot;footer.trademark&quot;:[0,&quot;Trademark&quot;],&quot;header.subscribe&quot;:[0,&quot;Subscribe&quot;],&quot;footer.compliance&quot;:[0,&quot;Compliance&quot;],&quot;footer.free_plans&quot;:[0,&quot;Free plans&quot;],&quot;footer.impact_ESG&quot;:[0,&quot;Impact/ESG&quot;],&quot;posts.follow_on_X&quot;:[0,&quot;Follow on X&quot;],&quot;footer.help_center&quot;:[0,&quot;Help center&quot;],&quot;footer.network_map&quot;:[0,&quot;Network Map&quot;],&quot;header.please_wait&quot;:[0,&quot;Please Wait&quot;],&quot;page.related_posts&quot;:[0,&quot;Related posts&quot;],&quot;search.result_stat&quot;:[0,&quot;Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>&quot;],&quot;footer.case_studies&quot;:[0,&quot;Case Studies&quot;],&quot;footer.connect_2024&quot;:[0,&quot;Connect 2024&quot;],&quot;footer.terms_of_use&quot;:[0,&quot;Terms of Use&quot;],&quot;footer.white_papers&quot;:[0,&quot;White Papers&quot;],&quot;footer.cloudflare_tv&quot;:[0,&quot;Cloudflare TV&quot;],&quot;footer.community_hub&quot;:[0,&quot;Community Hub&quot;],&quot;footer.compare_plans&quot;:[0,&quot;Compare plans&quot;],&quot;footer.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.email_address&quot;:[0,&quot;Email Address&quot;],&quot;page.error.not_found&quot;:[0,&quot;Page not found&quot;],&quot;footer.developer_docs&quot;:[0,&quot;Developer docs&quot;],&quot;footer.privacy_policy&quot;:[0,&quot;Privacy Policy&quot;],&quot;footer.request_a_demo&quot;:[0,&quot;Request a demo&quot;],&quot;page.continue_reading&quot;:[0,&quot;Continue reading&quot;],&quot;footer.analysts_report&quot;:[0,&quot;Analyst reports&quot;],&quot;footer.for_enterprises&quot;:[0,&quot;For enterprises&quot;],&quot;footer.getting_started&quot;:[0,&quot;Getting Started&quot;],&quot;footer.learning_center&quot;:[0,&quot;Learning Center&quot;],&quot;footer.project_galileo&quot;:[0,&quot;Project Galileo&quot;],&quot;pagination.newer_posts&quot;:[0,&quot;Newer Posts&quot;],&quot;pagination.older_posts&quot;:[0,&quot;Older Posts&quot;],&quot;posts.social_buttons.x&quot;:[0,&quot;Discuss on X&quot;],&quot;search.source_location&quot;:[0,&quot;Source/Location&quot;],&quot;footer.about_cloudflare&quot;:[0,&quot;About Cloudflare&quot;],&quot;footer.athenian_project&quot;:[0,&quot;Athenian Project&quot;],&quot;footer.become_a_partner&quot;:[0,&quot;Become a partner&quot;],&quot;footer.cloudflare_radar&quot;:[0,&quot;Cloudflare Radar&quot;],&quot;footer.network_services&quot;:[0,&quot;Network services&quot;],&quot;footer.trust_and_safety&quot;:[0,&quot;Trust &amp; Safety&quot;],&quot;header.get_started_free&quot;:[0,&quot;Get Started Free&quot;],&quot;page.search.placeholder&quot;:[0,&quot;Search Cloudflare&quot;],&quot;footer.cloudflare_status&quot;:[0,&quot;Cloudflare Status&quot;],&quot;footer.cookie_preference&quot;:[0,&quot;Cookie Preferences&quot;],&quot;header.valid_email_error&quot;:[0,&quot;Must be valid email.&quot;],&quot;footer.connectivity_cloud&quot;:[0,&quot;Connectivity cloud&quot;],&quot;footer.developer_services&quot;:[0,&quot;Developer services&quot;],&quot;footer.investor_relations&quot;:[0,&quot;Investor relations&quot;],&quot;page.not_found.error_code&quot;:[0,&quot;Error Code: 404&quot;],&quot;footer.logos_and_press_kit&quot;:[0,&quot;Logos &amp; press kit&quot;],&quot;footer.application_services&quot;:[0,&quot;Application services&quot;],&quot;footer.get_a_recommendation&quot;:[0,&quot;Get a recommendation&quot;],&quot;posts.social_buttons.reddit&quot;:[0,&quot;Discuss on Reddit&quot;],&quot;footer.sse_and_sase_services&quot;:[0,&quot;SSE and SASE services&quot;],&quot;page.not_found.outdated_link&quot;:[0,&quot;You may have used an outdated link, or you may have typed the address incorrectly.&quot;],&quot;footer.report_security_issues&quot;:[0,&quot;Report Security Issues&quot;],&quot;page.error.error_message_page&quot;:[0,&quot;Sorry, we can't find the page you are looking for.&quot;],&quot;header.subscribe_notifications&quot;:[0,&quot;Subscribe to receive notifications of new posts:&quot;],&quot;footer.cloudflare_for_campaigns&quot;:[0,&quot;Cloudflare for Campaigns&quot;],&quot;header.subscription_confimation&quot;:[0,&quot;Subscription confirmed. Thank you for subscribing!&quot;],&quot;posts.social_buttons.hackernews&quot;:[0,&quot;Discuss on Hacker News&quot;],&quot;footer.diversity_equity_inclusion&quot;:[0,&quot;Diversity, equity &amp; inclusion&quot;],&quot;footer.critical_infrastructure_defense_project&quot;:[0,&quot;Critical Infrastructure Defense Project&quot;]}]}" client="idle" opts="{&quot;name&quot;:&quot;NavigationComponent&quot;,&quot;value&quot;:true}" await-children=""><header class="flex flex-row flex-wrap justify-between items-flex-end mw8 center mv3 pl3 pr1"><div class="w-100 flex items-flex-end justify-between justify-start-l"><div class="w-100 tr flex justify-end"><div class="flex justify-between items-center"><span class="dn di-l pr1"><a href="https://dash.cloudflare.com/sign-up" class="f1 blue1 dn di-l b no-underline underline-hover" target="_blank" rel="noreferrer">Get Started Free</a></span><span class="f1 gray4 dn di-l pr1">|</span><span class="dn di-l"><a target="_blank" href="https://www.cloudflare.com/plans/enterprise/contact/" class="f1 gray4 no-underline underline-hover pr1" rel="noreferrer">Contact Sales</a></span></div></div></div><div class="w-100 w-50-l flex items-end nb5 nb1-l"><a href="/" class="header-logo mr4 dn db-l"><img class="header-logo" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/69RwBidpiEHCDZ9rFVVk7T/092507edbed698420b89658e5a6d5105/CF_logo_stacked_blktype.png" alt="The Cloudflare Blog" width="170" height="57"></a><h2 class="mt0 mb1 dn di-l"><a href="/" class="fw5 f5 gray3 no-underline"><span class="dn di-l">The Cloudflare Blog</span></a></h2></div><div class="w-100 w-50-l dn db-l"><div class="w-100 tr mkto-sub-message"><p class="f2">Subscribe to receive notifications of new posts:</p></div><div class="w-100 tr"><div class="marketo-form-container"><form id="mktoForm_1653"><div class="top-subscribe-form-container"><div class="top-subscribe-form-field"><input placeholder="Email Address" class="top-subscribe-form-input" name="email" type="email" title="Must be valid email."></div><button class="top-subscribe-form-button" type="button">Subscribe</button></div></form></div></div></div></header><nav dir="ltr" class="bb b--black-10 db dn-l w-100 ph3 "><div class=" flex justify-between items-center" style="height:44px"><a href="/search/"><img class="h-6 w-6" src="/images/magnifier.svg" alt="magnifier icon"></a><button type="button" style="background:transparent;border:none"><img src="/images/hamburger.svg" alt="hamburger menu"></button></div><div class="js-mobile-nav-container dn"><div class="flex flex-column flex-wrap bg-gray9 o-95 absolute w-90 ph3 z-1"><div class="pv3 ph2 tl"><a href="/tag/product-news/" class="no-underline gray1 f4 fw7">Product News</a></div><div class="pv3 ph2 tl"><a href="/tag/cloudflare-radar/" class="no-underline gray1 f4 fw7">Radar</a></div><div class="pv3 ph2 tl"><a href="/tag/zero-trust/" class="no-underline gray1 f4 fw7">Zero Trust</a></div><div class="pv3 ph2 tl"><a href="/tag/speed-and-reliability/" class="no-underline gray1 f4 fw7">Speed &amp; Reliability</a></div><div class="pv3 ph2 tl"><a href="/tag/security/" class="no-underline gray1 f4 fw7">Security</a></div><div class="pv3 ph2 tl"><a href="/tag/developers/" class="no-underline gray1 f4 fw7">Developers</a></div><div class="pv3 ph2 tl"><a href="/tag/ai/" class="no-underline gray1 f4 fw7">AI</a></div><div class="pv3 ph2 tl"><a href="/tag/policy/" class="no-underline gray1 f4 fw7">Policy &amp; Legal</a></div><div class="pv3 ph2 tl"><a href="/tag/partners/" class="no-underline gray1 f4 fw7">Partners</a></div><div class="pv3 ph2 tl"><a href="/tag/life-at-cloudflare/" class="no-underline gray1 f4 fw7">Life at Cloudflare</a></div></div></div></nav><nav id="nav" class="w-100 bb-0 bb-l b--black-10 z-1"><div id="desktop-nav-items-container" class="flex flex-wrap justify-between items-center mw8 center mv3 mv0-l"><div data-tag="product-news" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/product-news/" class="no-underline gray1 f2 fw5 pv3">Product News</a></div><div data-tag="cloudflare-radar" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/cloudflare-radar/" class="no-underline gray1 f2 fw5 pv3">Radar</a></div><div data-tag="zero-trust" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/zero-trust/" class="no-underline gray1 f2 fw5 pv3">Zero Trust</a></div><div data-tag="speed-and-reliability" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/speed-and-reliability/" class="no-underline gray1 f2 fw5 pv3">Speed &amp; Reliability</a></div><div data-tag="security" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/security/" class="no-underline gray1 f2 fw5 pv3">Security</a></div><div data-tag="developers" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/developers/" class="no-underline gray1 f2 fw5 pv3">Developers</a></div><div data-tag="ai" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/ai/" class="no-underline gray1 f2 fw5 pv3">AI</a></div><div data-tag="policy" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/policy/" class="no-underline gray1 f2 fw5 pv3">Policy &amp; Legal</a></div><div data-tag="partners" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/partners/" class="no-underline gray1 f2 fw5 pv3">Partners</a></div><div data-tag="life-at-cloudflare" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="/tag/life-at-cloudflare/" class="no-underline gray1 f2 fw5 pv3">Life at Cloudflare</a></div><div class="nav-item ml2 mr3 dn db-l pv3" data-tag="search icon"><a href="/search/"><img id="search-icon" class="h-6 w-6" src="/images/magnifier.svg" alt="magnifier icon"></a></div></div></nav></astro-island><progress class="reading-progress" value="0" max="100" aria-label="Reading progress"></progress><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="Vay9F" prefix="r1" component-url="/_astro/Post.DnH_Wpc8.js" component-export="Post" renderer-url="/_astro/client.BQCS8AJJ.js" props="{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;2yX9ADcaKBprzyI9BaBoqN&quot;],&quot;title&quot;:[0,&quot;Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging&quot;],&quot;slug&quot;:[0,&quot;h3i&quot;],&quot;excerpt&quot;:[0,&quot;h3i is a command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;<p>Have you ever built a piece of IKEA furniture, or put together a LEGO set, by following the instructions closely and only at the end realized at some point you didn&amp;#39;t <i>quite</i> follow them correctly? The final result might be close to what was intended, but there&amp;#39;s a nagging thought that maybe, just maybe, it&amp;#39;s not as rock steady or functional as it could have been.</p><p>Internet protocol specifications are instructions designed for engineers to build things. Protocol designers take great care to ensure the documents they produce are clear. The standardization process gathers consensus and review from experts in the field, to further ensure document quality. Any reasonably skilled engineer should be able to take a specification and produce a performant, reliable, and secure implementation. The Internet is central to everyone&amp;#39;s lives, and we depend on these implementations. Any deviations from the specification can put us at risk. For example, mishandling of malformed requests can allow attacks such as <a href=\&quot;https://en.wikipedia.org/wiki/HTTP_request_smuggling\&quot;><u>request smuggling</u></a>.</p><p>h3i is a binary command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC. <a href=\&quot;https://crates.io/crates/h3i\&quot;><u>h3i</u></a> is free and open source as part of Cloudflare&amp;#39;s <a href=\&quot;https://github.com/cloudflare/quiche\&quot;><u>quiche</u></a> project. In this post we&amp;#39;ll explain the motivation behind developing h3i, how we use it to help develop robust and safe standards-compliant software and production systems, and how you can similarly use it to test your own software or services. If you just want to jump into how to use h3i, go to the <a href=\&quot;#the-h3i-command-line-tool\&quot;><u>h3i command line tool</u></a> section.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;a-recap-of-quic-and-http-3\&quot;>A recap of QUIC and HTTP/3</h2>\n            <a href=\&quot;#a-recap-of-quic-and-http-3\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p><a href=\&quot;https://blog.cloudflare.com/http3-the-past-present-and-future/\&quot;><u>QUIC</u></a> is a secure-by-default transport protocol that provides performance advantages compared to TCP and TLS via a more efficient handshake, along with stream multiplexing that provides <a href=\&quot;https://en.wikipedia.org/wiki/Head-of-line_blocking\&quot;><u>head-of-line blocking</u></a> avoidance. <a href=\&quot;https://www.cloudflare.com/en-gb/learning/performance/what-is-http3/\&quot;><u>HTTP/3</u></a> is an application protocol that maps HTTP semantics to QUIC, such as defining how HTTP requests and responses are assigned to individual QUIC streams.</p><p>Cloudflare has supported QUIC on our global network in some shape or form <a href=\&quot;https://blog.cloudflare.com/http3-the-past-present-and-future/\&quot;><u>since 2018</u></a>. We started while the <a href=\&quot;https://ietf.org/\&quot;><u>Internet Engineering Task Force (IETF)</u></a> was earnestly standardizing the protocol, working through early iterations and using interoperability testing and experience to help provide feedback for the standards process. We <a href=\&quot;https://blog.cloudflare.com/quic-version-1-is-live-on-cloudflare/\&quot;><u>launched support</u></a> for QUIC version 1 and HTTP/3 as soon as <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000\&quot;><u>RFC 9000</u></a> (and its accompanying specifications) were published in 2021.</p><p>We work on the Protocols team, who own the ingress proxy into the Cloudflare network. This is essentially Cloudflare’s “front door” — HTTP requests that come to Cloudflare from the Internet pass through us first. The majority of requests are passed onwards to things like rulesets, workers, caches, or a customer origin. However, you might be surprised that many requests don&amp;#39;t ever make it that far because they are, in some way, invalid or malformed. Servers listening on the Internet have to be robust to traffic that is not RFC compliant, whether caused by accident or malicious intent.</p><p>The Protocols team actively participates in IETF standardization work and has also helped build and maintain other Cloudflare services that leverage quiche for QUIC and HTTP/3, from the proxies that help <a href=\&quot;https://blog.cloudflare.com/icloud-private-relay/\&quot;><u>iCloud Private Relay</u></a> via <a href=\&quot;https://blog.cloudflare.com/unlocking-quic-proxying-potential/\&quot;><u>MASQUE proxying</u></a>, to replacing <a href=\&quot;https://blog.cloudflare.com/zero-trust-warp-with-a-masque/\&quot;><u>WARP&amp;#39;s use of Wireguard with MASQUE</u></a>, and beyond.</p><p>Throughout all of these different use cases, it is important for us to extensively test all aspects of the protocols. A deep dive into protocol details is a blog post (or three) in its own right. So let&amp;#39;s take a thin slice across HTTP to help illustrate the concepts.</p><p><a href=\&quot;https://www.rfc-editor.org/rfc/rfc9110.html\&quot;><u>HTTP Semantics</u></a> are common to all versions of HTTP — the overall architecture, terminology, and protocol aspects such as request and response messages, methods, status codes, header and trailer fields, message content, and much more. Each individual HTTP version defines how semantics are transformed into a &amp;quot;wire format&amp;quot; for exchange over the Internet. You can read more about HTTP/1.1 and HTTP/2 in some of our previous <a href=\&quot;https://blog.cloudflare.com/a-primer-on-proxies/\&quot;><u>blog</u></a> <a href=\&quot;https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\&quot;><u>posts</u></a>.</p><p>With HTTP/3, HTTP request and response messages are split into a series of binary frames. <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-7.2.2\&quot;><u>HEADERS</u></a> frames carry a representation of HTTP metadata (method, path, status code, field lines). The payload of the frame is the encoded <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9204\&quot;><u>QPACK</u></a> compression output. <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-7.2.1\&quot;><u>DATA</u></a> frames carry <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9110#section-6.4.1\&quot;><u>HTTP content</u></a> (aka &amp;quot;message body&amp;quot;). In order to exchange these frames, HTTP/3 relies on QUIC <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000#section-2\&quot;><u>streams</u></a>. These provide an ordered and reliable byte stream and each have an identifier (ID) that is unique within the scope of a connection. There are <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000#section-2.1\&quot;><u>four different stream types</u></a>, denominated by the two least significant bits of the ID.</p><p>As a simple example, assuming a QUIC connection has already been established, a client can make a GET request and receive a 200 OK response with an HTML body using the follow sequence:</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7vVfQ5CYaaVPVmGloRUnkI/88bd727c3526e540bd493bc15fbe904a/unnamed.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1222\&quot; height=\&quot;1392\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><ol><li><p>Client allocates the first available client-initiated bidirectional QUIC stream. (The IDs start at 0, then 4, 8, 12 and so on)</p></li><li><p>Client sends the request HEADERS frame on the stream and sets the stream&amp;#39;s <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9000#section-19.8\&quot;><u>FIN bit</u></a> to mark the end of stream.</p></li><li><p>Server receives the request HEADERS frame and validates it against <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2\&quot;><u>RFC 9114 rules</u></a>. If accepted, it processes the request and prepares the response.</p></li><li><p>Server sends the response HEADERS frame on the same stream.</p></li><li><p>Server sends the response DATA frame on the same stream and sets the FIN bit.</p></li><li><p>Client receives the response frames and validates them. If accepted, the content is presented to the user.</p></li></ol><p>At the QUIC layer, stream data is split into STREAM frames, which are sent in QUIC packets over UDP. QUIC deals with any loss detection and recovery, helping to ensure stream data is reliable. The layer cake diagram below provides a handy comparison of how HTTP/1.1, HTTP/2 and HTTP/3 use TCP, UDP and IP.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4049UpKGn4BJcYcEXSFgWz/32143a5ba3672786639908ad96851225/image2.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1590\&quot; height=\&quot;1130\&quot; loading=\&quot;lazy\&quot;/>\n          </figure>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;background-on-testing-quic-and-http-3-at-cloudflare\&quot;>Background on testing QUIC and HTTP/3 at Cloudflare</h2>\n            <a href=\&quot;#background-on-testing-quic-and-http-3-at-cloudflare\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The Protocols team has a diverse set of automated test tools that exercise our ingress proxy software in order to ensure it can stand up to the deluge that the Internet can throw at it. Just like a bouncer at a nightclub front door, we need to prevent as much bad traffic as possible before it gets inside and potentially causes damage.</p><p>HTTP/2 and HTTP/3 share several concepts. When we started developing early HTTP/3 support, we&amp;#39;d already learned a lot from production experience with HTTP/2. While HTTP/2 addressed many issues with HTTP/1.1 (especially problems like <a href=\&quot;https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf\&quot;><u>request smuggling</u></a>, caused by its ASCII-based message delineation), HTTP/2 also added complexity and new avenues for attack. Security is an ongoing process, and the Protocols team continually hardens our software and systems to threats. For example, mitigating the range of <a href=\&quot;https://blog.cloudflare.com/on-the-recent-http-2-dos-attacks/\&quot;><u>denial-of-service attacks</u></a> identified by Netflix in 2019, or the <a href=\&quot;https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/\&quot;><u>HTTP/2 Rapid Reset</u></a> attacks of 2023.</p><p>For testing HTTP/2, we rely on the Python <a href=\&quot;https://pypi.org/project/requests/\&quot;><u>Requests</u></a> library for testing conventional HTTP exchanges. However, that mostly only exercises HEADERS and DATA frames. There are eight other frame types and a plethora of ways that they can interact (hence the new attack vectors mentioned above). In order to get full testing coverage, we have to break down into the lower layer <a href=\&quot;https://pypi.org/project/h2/\&quot;><u>h2</u></a> library, which allows exact frame-by-frame control. However, even that is not always enough. Libraries tend to want to follow the RFC rules and prevent their users from doing &amp;quot;the wrong thing&amp;quot;. This is entirely logical for most purposes. For our needs though, we need to take off the safety guards just like any potential attackers might do. We have a few cases where the best way to exercise certain traffic patterns is to handcraft HTTP/2 frames in a hex editor, store that as binary, and replay it with a tool such as <a href=\&quot;https://docs.openssl.org/1.0.2/man1/s_client/\&quot;><u>OpenSSL s_client</u></a>.</p><p>We knew we&amp;#39;d need similar testing approaches for HTTP/3. However, when we started in 2018, there weren&amp;#39;t many other suitable client implementations. The rate of iteration on the specifications also meant it was hard to always keep in sync. So we built tests on quiche, using a mix of our <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/apps/src/client.rs\&quot;><u>quiche-client</u></a> and <a href=\&quot;https://github.com/cloudflare/quiche/tree/master/tools/http3_test\&quot;><u>http3_test</u></a>. Over time, the python library <a href=\&quot;https://github.com/aiortc/aioquic\&quot;><u>aioquic</u></a> has matured, and we have used it to add a range of lower-layer tests that break or bend HTTP/3 rules, in order to prove our proxies are robust.</p><p>Finally, we would be remiss not to mention that all the tests in our ingress proxy are <b>in addition to </b>the suite of over 500 integration tests that run on the quiche project itself.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;making-http-3-testing-more-accessible-and-maintainable-with-h3i\&quot;>Making HTTP/3 testing more accessible and maintainable with h3i</h2>\n            <a href=\&quot;#making-http-3-testing-more-accessible-and-maintainable-with-h3i\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>While we are happy with the coverage of our current tests, the smorgasbord of test tools makes it hard to know what to reach for when adding new tests. For example, we&amp;#39;ve had cases where aioquic&amp;#39;s safety guards prevent us from doing something, and it has needed a patch or workaround. This sort of thing requires a time investment just to debug/develop the tests.</p><p>We believe it shouldn&amp;#39;t take a protocol or code expert to develop what are often very simple to describe tests. While it is important to provide guide rails for the majority of conventional use cases, it is also important to provide accessible methods for taking them off.</p><p>Let&amp;#39;s consider a simple example. In HTTP/3 there is something called the control stream. It&amp;#39;s used to exchange frames such as SETTINGS, which affect the HTTP/3 connection. RFC 9114 <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-6.2.1\&quot;><u>Section 6.2.1</u></a> states:</p><blockquote><p><i>Each side MUST initiate a single control stream at the beginning of the connection and send its SETTINGS frame as the first frame on this stream. If the first frame of the control stream is any other frame type, this MUST be treated as a connection error of type H3_MISSING_SETTINGS. Only one control stream per peer is permitted; receipt of a second stream claiming to be a control stream MUST be treated as a connection error of type H3_STREAM_CREATION_ERROR. The sender MUST NOT close the control stream, and the receiver MUST NOT request that the sender close the control stream. If either control stream is closed at any point, this MUST be treated as a connection error of type H3_CLOSED_CRITICAL_STREAM. Connection errors are described in Section 8.</i></p></blockquote><p>There are many tests we can conjure up just from that paragraph:</p><ol><li><p>Send a non-SETTINGS frame as the first frame on the control stream.</p></li><li><p>Open two control streams.</p></li><li><p>Open a control stream and then close it with a FIN bit.</p></li><li><p>Open a control stream and then reset it with a RESET_STREAM QUIC frame.</p></li><li><p>Wait for the peer to open a control stream and then ask for it to be reset with a STOP_SENDING QUIC frame.</p></li></ol><p>All of the above actions should cause a remote peer that has implemented the RFC properly to close the connection. Therefore, it is not in the interest of the local client or server applications to ever do these actions.</p><p>Many QUIC and HTTP/3 implementations are developed as libraries that are integrated into client or server applications. There may be an extensive set of unit or integration tests of the library checking RFC rules. However, it is also important to run the same tests on the integrated assembly of library and application, since it&amp;#39;s all too common that an unhandled/mishandled library error can cascade to cause issues in upper layers. For instance, the HTTP/2 Rapid Reset attacks affected Cloudflare due to their <a href=\&quot;https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/#impact-on-customers\&quot;><u>impact on how one service spoke to another</u></a>.</p><p>We&amp;#39;ve developed h3i, a command line tool and library, to make testing more accessible and maintainable for all. We started with a client that can exercise servers, since that&amp;#39;s what our focus has been. Future developments could support the opposite, a server that behaves in unusual ways in order to exercise clients.</p><p><b>Note: </b>h3i is <i>not</i> intended to be a production client! Its flexibility may cause issues that are not observed in other production-oriented clients. It is also not intended to be used for any type of performance testing and measurement.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;the-h3i-command-line-tool\&quot;>The h3i command line tool</h2>\n            <a href=\&quot;#the-h3i-command-line-tool\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The primary purpose of the h3i command line tool is quick low-level debugging and exploratory testing. Rather than worrying about writing code or a test script, users can quickly run an ad-hoc client test against a target, guided by interactive prompts.</p><p>In the simplest case, you can think of h3i a bit like <a href=\&quot;https://curl.se/\&quot;><u>curl</u></a> but with access to some extra HTTP/3 parameters. In the example below, we issue a request to <a href=\&quot;https://cloudflare-quic.com\&quot;><u>https://cloudflare-quic.com</u></a>/ and receive a response.</p><div style=\&quot;position: relative; padding-top: 70.91172214182345%;\&quot;>\n  <iframe\n    src=\&quot;https://customer-eq7kiuol0tk9chox.cloudflarestream.com/b1dadea8189831a6220d318d688d0ef8/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2Fb1dadea8189831a6220d318d688d0ef8%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600\&quot;\n    loading=\&quot;lazy\&quot;\n    style=\&quot;border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;\&quot;\n    allow=\&quot;accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;\&quot;\n    allowfullscreen=\&quot;true\&quot;\n  ></iframe>\n</div><p>Walking through a simple GET with h3i step-by-step:</p><ol><li><p>Grab a copy of the h3i binary either by running <code>cargo install h3i</code> or cloning the quiche source repo at <a href=\&quot;https://github.com/cloudflare/quiche/\&quot;><u>https://github.com/cloudflare/quiche/</u></a>. Both methods assume you have some familiarity with Rust and Cargo. See the cargo <a href=\&quot;https://doc.rust-lang.org/book/ch14-04-installing-binaries.html\&quot;><u>documentation</u></a> for more information.</p><ol><li><p><code>cargo install</code> will place the binary on your path, so you can then just run it by executing <code>h3i</code>.</p></li><li><p>If running from source, navigate to the quiche/h3i directory and then use <code>cargo run</code>.</p></li></ol></li><li><p>Run the binary and provide the name and port of the target server. If the port is omitted, the default value 443 is assumed. E.g, <code>cargo run cloudflare-quic.com</code></p></li><li><p>h3i then enters the action prompting phase. A series of one or more HTTP/3 actions can be queued up, such as sending frames, opening or terminating streams, or waiting on data from the server. The full set of options is documented in the <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/h3i/README.md#command-line-tool\&quot;><u>readme</u></a>.</p><ol><li><p>The prompting interface adapts to keyboard inputs and supports tab completion.</p></li><li><p>In the example above, the <code>headers</code> action is selected, which walks through populating the fields in a HEADERS frame. It includes <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-4.3.1\&quot;><u>mandatory fields</u></a> from RFC 9114 for convenience. If a test requires omitting these, the <code>headers_no_pseudo</code> can be used instead.</p></li></ol></li><li><p>The <code>commit</code> prompt choice finalizes the action list and moves to the connection phase. h3i initiates a QUIC connection to the server identified in step 2. Once connected, actions are executed in order.</p></li><li><p>By default, h3i reports some limited information about the frames the server sent. To get more detailed information, the <code>RUST_LOG</code> environment can be set with either <code>debug</code> or <code>trace</code> levels.</p></li></ol>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;instant-record-and-replay-powered-by-qlog\&quot;>Instant record and replay, powered by qlog</h2>\n            <a href=\&quot;#instant-record-and-replay-powered-by-qlog\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>It can be fun to play around with the h3i command line tool to see how different servers respond to different combinations or sequences of actions. Occasionally, you&amp;#39;ll find a certain set that you want to run over and over again, or share with a friend or colleague. Having to manually enter the prompts repeatedly, or share screenshots of the h3i input can turn tedious. Fortunately, h3i records all the actions in a log file by default — the file path is printed immediately after h3i starts. The format of this file is based on <a href=\&quot;https://datatracker.ietf.org/doc/html/draft-ietf-quic-qlog-main-schema\&quot;><u>qlog</u></a>, an in-progress standard in development at the IETF for network protocol logging. It’s a perfect fit for our low-level needs.</p><p>Here&amp;#39;s an example h3i qlog file:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>{&amp;quot;qlog_version&amp;quot;:&amp;quot;0.3&amp;quot;,&amp;quot;qlog_format&amp;quot;:&amp;quot;JSON-SEQ&amp;quot;,&amp;quot;title&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;trace&amp;quot;:{&amp;quot;vantage_point&amp;quot;:{&amp;quot;type&amp;quot;:&amp;quot;client&amp;quot;},&amp;quot;title&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;description&amp;quot;:&amp;quot;h3i&amp;quot;,&amp;quot;configuration&amp;quot;:{&amp;quot;time_offset&amp;quot;:0.0}}}\n{\n  &amp;quot;time&amp;quot;: 0.172783,\n  &amp;quot;name&amp;quot;: &amp;quot;http:frame_created&amp;quot;,\n  &amp;quot;data&amp;quot;: {\n    &amp;quot;stream_id&amp;quot;: 0,\n    &amp;quot;frame&amp;quot;: {\n      &amp;quot;frame_type&amp;quot;: &amp;quot;headers&amp;quot;,\n      &amp;quot;headers&amp;quot;: [\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:method&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;GET&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:authority&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;cloudflare-quic.com&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:path&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;/&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;:scheme&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;https&amp;quot;\n        },\n        {\n          &amp;quot;name&amp;quot;: &amp;quot;user-agent&amp;quot;,\n          &amp;quot;value&amp;quot;: &amp;quot;h3i&amp;quot;\n        }\n      ]\n    }\n  },\n  &amp;quot;fin_stream&amp;quot;: true\n}</pre></code>\n            <p>h3i logs can be replayed using the <code>--qlog-input</code> option. You can change the target server host and port, and keep all the same actions. However, most servers will validate the :authority pseudo-header or Host header contained in a HEADERS frame. The --replay-host-override option allows changing these fields without needing to modify the file by hand.</p><p>And yes, qlog files are human-readable text in the JSON-SEQ format. So you can also just write these by hand in the first place if you like! However, if you&amp;#39;re going to start writing things, maybe Rust is your preferred option…</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;using-the-h3i-library-to-send-a-malformed-request-with-rust\&quot;>Using the h3i library to send a malformed request with Rust</h2>\n            <a href=\&quot;#using-the-h3i-library-to-send-a-malformed-request-with-rust\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>In our previous example, we just sent a valid request so there wasn&amp;#39;t anything interesting to observe. Where h3i really shines is in generating traffic that isn&amp;#39;t RFC compliant, such as malformed HTTP messages, invalid frame sequences, or other actions on streams. This helps determine if a server is acting robustly and defensively.</p><p>Let&amp;#39;s explore this more with an example of HTTP content-length mismatch. RFC 9114 <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2\&quot;><u>section 4.1.2</u></a> specifies:</p><blockquote><p><i>A request or response that is defined as having content when it contains a Content-Length header field (Section 8.6 of [HTTP]) is malformed if the value of the Content-Length header field does not equal the sum of the DATA frame lengths received. A response that is defined as never having content, even when a Content-Length is present, can have a non-zero Content-Length header field even though no content is included in DATA frames.</i></p><p><i>Intermediaries that process HTTP requests or responses (i.e., any intermediary not acting as a tunnel) MUST NOT forward a malformed request or response. Malformed requests or responses that are detected MUST be treated as a stream error of type H3_MESSAGE_ERROR.</i></p><p><i>For malformed requests, a server MAY send an HTTP response indicating the error prior to closing or resetting the stream.</i></p></blockquote><p>There are good reasons that the RFC is so strict about handling mismatched content lengths. They can be a vector for <a href=\&quot;https://portswigger.net/research/http2\&quot;><u>desynchronization attacks</u></a> (similar to request smuggling), especially when a proxy is converting inbound HTTP/3 to outbound HTTP/1.1.</p><p>We&amp;#39;ve provided an <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/h3i/examples/content_length_mismatch.rs\&quot;><u>example</u></a> of how to use the h3i Rust library to write a tailor-made test client that sends a mismatched content length request. It sends a Content-Length header of 5, but its body payload is “test”, which is only 4 bytes. It then waits for the server to respond, after which it explicitly closes the connection by sending a QUIC CONNECTION_CLOSE frame.</p><p>When running low-level tests, it can be interesting to also take a packet capture (<a href=\&quot;https://en.wikipedia.org/wiki/Pcap\&quot;><u>pcap</u></a>) and observe what is happening on the wire. Since QUIC is an encrypted transport, we&amp;#39;ll need to use the SSLKEYLOG environment variable to capture the session keys so that tools like Wireshark can <a href=\&quot;https://wiki.wireshark.org/TLS#using-the-pre-master-secret\&quot;><u>decrypt and dissect</u></a>.</p><p>To follow along at home, clone a copy of the quiche repository, start a packet capture on the appropriate network interface and then run:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>cd quiche/h3i\nSSLKEYLOGFILE=&amp;quot;h3i-example.keys&amp;quot; cargo run --example content_length_mismatch</pre></code>\n            <p>In our decrypted capture, we see the expected sequence of handshake, request, response, and then closure.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6Qkdd3h0x826tH95S61u92/5de829e018b9d3ef409a2452362fa81e/image1.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;1096\&quot; loading=\&quot;lazy\&quot;/>\n          </figure>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;surveying-the-example-code\&quot;>Surveying the example code</h2>\n            <a href=\&quot;#surveying-the-example-code\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The <a href=\&quot;https://github.com/cloudflare/quiche/blob/master/h3i/examples/content_length_mismatch.rs\&quot;><u>example</u></a> is a simple binary app with a <code>main()</code> entry point. Let&amp;#39;s survey the key elements.</p><p>First, we set up an h3i configuration to a target server:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>let config = Config::new()\n        .with_host_port(&amp;quot;cloudflare-quic.com&amp;quot;.to_string())\n        .with_idle_timeout(2000)\n        .build()\n        .unwrap();</pre></code>\n            <p>The idle timeout is a QUIC concept which tells each endpoint when it should close the connection if the connection has been idle. This prevents endpoints from spinning idly if the peer hasn’t closed the connection. h3i’s default is 30 seconds, which can be too long for tests, so we set ours to 2 seconds here.</p><p>Next, we define a set of request headers and encode them with QPACK compression, ready to put in a HEADERS frame. Note that h3i does provide a <a href=\&quot;https://docs.rs/h3i/latest/h3i/actions/h3/fn.send_headers_frame.html\&quot;><u>send_headers_frame</u></a> helper method which does this for you, but the example does it manually for clarity:</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>let headers = vec![\n        Header::new(b&amp;quot;:method&amp;quot;, b&amp;quot;POST&amp;quot;),\n        Header::new(b&amp;quot;:scheme&amp;quot;, b&amp;quot;https&amp;quot;),\n        Header::new(b&amp;quot;:authority&amp;quot;, b&amp;quot;cloudflare-quic.com&amp;quot;),\n        Header::new(b&amp;quot;:path&amp;quot;, b&amp;quot;/&amp;quot;),\n        // We say that we&amp;#039;re going to send a body with 5 bytes...\n        Header::new(b&amp;quot;content-length&amp;quot;, b&amp;quot;5&amp;quot;),\n    ];\n\n    let header_block = encode_header_block(&amp;amp;headers).unwrap();</pre></code>\n            <p>Then, we define the set of h3i actions that we want to execute in order: send HEADERS, send a too-short DATA frame, wait for the server&amp;#39;s HEADERS, then close the connection.</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>let actions = vec![\n        Action::SendHeadersFrame {\n            stream_id: STREAM_ID,\n            fin_stream: false,\n            headers,\n            frame: Frame::Headers { header_block },\n        },\n        Action::SendFrame {\n            stream_id: STREAM_ID,\n            fin_stream: true,\n            frame: Frame::Data {\n                // ...but, in actuality, we only send 4 bytes. This should yield a\n                // 400 Bad Request response from an RFC-compliant\n                // server: https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2-3\n                payload: b&amp;quot;test&amp;quot;.to_vec(),\n            },\n        },\n        Action::Wait {\n            wait_type: WaitType::StreamEvent(StreamEvent {\n                stream_id: STREAM_ID,\n                event_type: StreamEventType::Headers,\n            }),\n        },\n        Action::ConnectionClose {\n            error: quiche::ConnectionError {\n                is_app: true,\n                error_code: quiche::h3::WireErrorCode::NoError as u64,\n                reason: vec![],\n            },\n        },\n    ];</pre></code>\n            <p>Finally, we&amp;#39;ll set things in motion with <code>connect()</code>, which sets up the QUIC connection, executes the actions list and collects the summary.</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>let summary =\n        sync_client::connect(config, &amp;amp;actions).expect(&amp;quot;connection failed&amp;quot;);\n\n    println!(\n        &amp;quot;=== received connection summary! ===\\n\\n{}&amp;quot;,\n        serde_json::to_string_pretty(&amp;amp;summary).unwrap_or_else(|e| e.to_string())\n    );</pre></code>\n            <p><a href=\&quot;https://docs.rs/h3i/latest/h3i/client/connection_summary/struct.ConnectionSummary.html\&quot;><u>ConnectionSummary</u></a>&nbsp; provides data about the connection, including the frames h3i received, details about why the connection closed, and connection statistics. The example prints the summary out. However, you can programmatically check it. We do this to write our own internal automation tests.</p><p>If you&amp;#39;re running the example, it should print something like the following:</p>\n            <pre class=\&quot;language-Rust\&quot;><code class=\&quot;language-Rust\&quot;>=== received connection summary! ===\n\n{\n  &amp;quot;stream_map&amp;quot;: {\n    &amp;quot;0&amp;quot;: [\n      {\n        &amp;quot;UNKNOWN&amp;quot;: {\n          &amp;quot;raw_type&amp;quot;: 2471591231244749708,\n          &amp;quot;payload&amp;quot;: &amp;quot;&amp;quot;\n        }\n      },\n      {\n        &amp;quot;UNKNOWN&amp;quot;: {\n          &amp;quot;raw_type&amp;quot;: 2031803309763646295,\n          &amp;quot;payload&amp;quot;: &amp;quot;4752454153452069732074686520776f7264&amp;quot;\n        }\n      },\n      {\n        &amp;quot;enriched_headers&amp;quot;: {\n          &amp;quot;header_block_len&amp;quot;: 75,\n          &amp;quot;headers&amp;quot;: [\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;:status&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;400&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;server&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;cloudflare&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;date&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;Sat, 07 Dec 2024 00:34:12 GMT&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;content-type&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;text/html&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;content-length&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;155&amp;quot;\n            },\n            {\n              &amp;quot;name&amp;quot;: &amp;quot;cf-ray&amp;quot;,\n              &amp;quot;value&amp;quot;: &amp;quot;8ee06dbe2923fa17-ORD&amp;quot;\n            }\n          ]\n        }\n      },\n      {\n        &amp;quot;DATA&amp;quot;: {\n          &amp;quot;payload_len&amp;quot;: 104\n        }\n      },\n      {\n        &amp;quot;DATA&amp;quot;: {\n          &amp;quot;payload_len&amp;quot;: 51\n        }\n      }\n    ]\n  },\n  &amp;quot;stats&amp;quot;: {\n    &amp;quot;recv&amp;quot;: 10,\n    &amp;quot;sent&amp;quot;: 5,\n    &amp;quot;lost&amp;quot;: 0,\n    &amp;quot;retrans&amp;quot;: 0,\n    &amp;quot;sent_bytes&amp;quot;: 1712,\n    &amp;quot;recv_bytes&amp;quot;: 4178,\n    &amp;quot;lost_bytes&amp;quot;: 0,\n    &amp;quot;stream_retrans_bytes&amp;quot;: 0,\n    &amp;quot;paths_count&amp;quot;: 1,\n    &amp;quot;reset_stream_count_local&amp;quot;: 0,\n    &amp;quot;stopped_stream_count_local&amp;quot;: 0,\n    &amp;quot;reset_stream_count_remote&amp;quot;: 0,\n    &amp;quot;stopped_stream_count_remote&amp;quot;: 0,\n    &amp;quot;path_challenge_rx_count&amp;quot;: 0\n  },\n  &amp;quot;path_stats&amp;quot;: [\n    {\n      &amp;quot;local_addr&amp;quot;: &amp;quot;0.0.0.0:64418&amp;quot;,\n      &amp;quot;peer_addr&amp;quot;: &amp;quot;104.18.29.7:443&amp;quot;,\n      &amp;quot;active&amp;quot;: true,\n      &amp;quot;recv&amp;quot;: 10,\n      &amp;quot;sent&amp;quot;: 5,\n      &amp;quot;lost&amp;quot;: 0,\n      &amp;quot;retrans&amp;quot;: 0,\n      &amp;quot;rtt&amp;quot;: 0.008140072,\n      &amp;quot;min_rtt&amp;quot;: 0.004645536,\n      &amp;quot;rttvar&amp;quot;: 0.004238173,\n      &amp;quot;cwnd&amp;quot;: 13500,\n      &amp;quot;sent_bytes&amp;quot;: 1712,\n      &amp;quot;recv_bytes&amp;quot;: 4178,\n      &amp;quot;lost_bytes&amp;quot;: 0,\n      &amp;quot;stream_retrans_bytes&amp;quot;: 0,\n      &amp;quot;pmtu&amp;quot;: 1350,\n      &amp;quot;delivery_rate&amp;quot;: 247720\n    }\n  ],\n  &amp;quot;error&amp;quot;: {\n    &amp;quot;local_error&amp;quot;: {\n      &amp;quot;is_app&amp;quot;: true,\n      &amp;quot;error_code&amp;quot;: 256,\n      &amp;quot;reason&amp;quot;: &amp;quot;&amp;quot;\n    },\n    &amp;quot;timed_out&amp;quot;: false\n  }\n}\n</pre></code>\n            <p>Let’s walk through the output. Up first is the <a href=\&quot;https://docs.rs/h3i/latest/h3i/client/connection_summary/struct.StreamMap.html\&quot;><u>StreamMap</u></a>, which is a record of all frames received on each stream. We can see that we received 5 frames on stream 0: 2 UNKNOWNs, one <a href=\&quot;https://docs.rs/h3i/latest/h3i/frame/struct.EnrichedHeaders.html\&quot;><u>EnrichedHeaders</u></a> frame, and two DATA frames.</p><p>The UNKNOWN frames are extension frames that are unknown to h3i; the server under test is sending what are known as <a href=\&quot;https://datatracker.ietf.org/doc/draft-edm-protocol-greasing/\&quot;><u>GREASE</u></a> frames to help exercise the protocol and ensure clients are not erroring when they receive something unexpected per <a href=\&quot;https://datatracker.ietf.org/doc/html/rfc9114#extensions\&quot;><u>RFC 9114 requirements</u></a>.</p><p>The EnrichedHeaders frame is essentially an HTTP/3 HEADERS frame, but with some small helpers, like one to get the response status code. The server under test sent a 400 as expected.</p><p>The DATA frames carry response body bytes. In this case, the body is the HTML required to render the Cloudflare Bad Request page (you can peek at the HTML yourself in Wireshark). We chose to omit the raw bytes from the ConnectionSummary since they may not be representable safely as text. A future improvement could be to encode the bytes in base64 or hex, in order to support tests that need to check response content.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;h3i-for-test-automation\&quot;>h3i for test automation</h2>\n            <a href=\&quot;#h3i-for-test-automation\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>We believe h3i is a great library for building automated tests on. You can take the above example and modify it to fit within various types of (continuous) integration tests.</p><p>We outlined earlier how the Protocols team HTTP/3 testing has organically grown to use three different frameworks. Even within those, we still didn&amp;#39;t have much flexibility and ease of use. Over the last year we&amp;#39;ve been building h3i itself and reimplementing our suite of ingress proxy test cases using the Rust library. This has helped us improve test coverage with a range of new tests not previously possible. It also surprisingly identified some problems with the old tests, particularly for some edge cases where it wasn&amp;#39;t clear how the old test code implementation was running under the hood.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;bake-offs-interop-and-wider-testing-of-http\&quot;>Bake offs, interop, and wider testing of HTTP</h2>\n            <a href=\&quot;#bake-offs-interop-and-wider-testing-of-http\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p><a href=\&quot;https://datatracker.ietf.org/doc/html/rfc1025\&quot;><u>RFC 1025</u></a> was published in 1987. Authored by <a href=\&quot;https://icannwiki.org/Jon_Postel\&quot;><u>Jon Postel</u></a>, it discusses bake offs:</p><blockquote><p><i>In the early days of the development of TCP and IP, when there were very few implementations and the specifications were still evolving, the only way to determine if an implementation was &amp;quot;correct&amp;quot; was to test it against other implementations and argue that the results showed your own implementation to have done the right thing.&nbsp; These tests and discussions could, in those early days, as likely change the specification as change the implementation.</i></p><p><i>There were a few times when this testing was focused, bringing together all known implementations and running through a set of tests in hopes of demonstrating the N squared connectivity and correct implementation of the various tricky cases.&nbsp; These events were called &amp;quot;Bake Offs&amp;quot;.</i></p></blockquote><p>While nearly 4 decades old, the concept of exercising Internet protocol implementations and seeing how they compare to the specification still holds true. The QUIC WG made heavy use of interoperability testing through its standardization process. We started off sitting in a room and running tests manually by hand (or with some help from scripts). Then <a href=\&quot;https://seemann.io/\&quot;><u>Marten Seemann</u></a> developed the <a href=\&quot;https://interop.seemann.io/\&quot;><u>QUIC Interop Runner</u></a>, which runs regular automated testing and collects and renders all the results. This has proven to be incredibly useful.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2OGnVUbatoX8Ya2IO5RdCl/754316e004a8e658ac089e10e70b72ca/image6.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1797\&quot; height=\&quot;780\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p>The state of HTTP/3 interoperability testing is not quite as mature. Although there are tools such as <a href=\&quot;https://kazu-yamamoto.hatenablog.jp/\&quot;><u>Kazu Yamamoto&amp;#39;s</u></a> excellent <a href=\&quot;https://github.com/kazu-yamamoto/h3spec\&quot;><u>h3spec</u></a> (in Haskell) for testing conformance, there isn&amp;#39;t a similar continuous integration process of collection and rendering of results. While h3i shares similarities with h3spec, we felt it important to focus on the framework capabilities rather than creating a corpus of tests and assertions. Cloudflare is a big fan of Rust and as several teams move to Rust-based proxies, having a consistent ecosystem provides advantages (such as developer velocity).</p><p>We certainly feel there is a great opportunity for continued collaboration and cross-pollination between projects in the QUIC and HTTP space. For example, h3i might provide a suitable basis to build another tool (or set of scripts) to run bake offs or interop tests. Perhaps it even makes sense to have a common collection of test cases owned by the community, that can be specialized to the most appropriate or preferred tooling. This topic was recently presented at the <a href=\&quot;https://github.com/HTTPWorkshop/workshop2024/blob/main/talks/5.%20Testing/testing.pdf\&quot;><u>HTTP Workshop 2024</u></a> by Mohammed Al-Sahaf, and it excites us to see <a href=\&quot;https://www.caffeinatedwonders.com/2024/12/18/towards-validated-http-implementation/\&quot;><u>new potential directions</u></a> of testing improvements.</p><p>When using any tools or methods for protocol testing, we encourage responsible handling of security-related matters. If you believe you may have identified a vulnerability in an IETF Internet protocol itself, please follow the IETF&amp;#39;s <a href=\&quot;https://www.ietf.org/standards/rfcs/vulnerabilities/\&quot;><u>reporting guidance</u></a>. If you believe you may have discovered an implementation vulnerability in a product, open source project, or service using QUIC or HTTP, then you should report these directly to the responsible party. Implementers or operators often provide their own publicly-available guidance and contact details to send reports. For example, the Cloudflare quiche <a href=\&quot;https://github.com/cloudflare/quiche/security/policy\&quot;><u>security policy</u></a> is available in the Security tab of the GitHub repository.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;summary-and-outlook\&quot;>Summary and outlook</h2>\n            <a href=\&quot;#summary-and-outlook\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Cloudflare takes testing very seriously. While h3i has a limited feature set as a test HTTP/3 client, we believe it provides a strong framework that can be extended to a wider range of different cases and different protocols. For example, we&amp;#39;d like to add support for low-level HTTP/2.</p><p>We&amp;#39;ve designed h3i to integrate into a wide range of testing methodologies, from manual ad-hoc testing, to native Rust tests, to conformance testbenches built with scripting languages. We&amp;#39;ve had great success migrating our existing zoo of test tools to a single one that is more accessible and easier to maintain.</p><p>Now that you&amp;#39;ve read about h3i&amp;#39;s capabilities, it&amp;#39;s left as an exercise to the reader to go back to the example of HTTP/3 control streams and consider how you could write tests to exercise a server.</p><p>We encourage the community to experiment with h3i and provide feedback, and propose ideas or contributions to the <a href=\&quot;https://github.com/cloudflare/quiche\&quot;><u>GitHub repository</u></a> as issues or Pull Requests.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5rp4YDTbXm37OxK7dtjiKF/816c0eed08926b7d34842f4769808277/image4.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1200\&quot; height=\&quot;304\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p>&quot;],&quot;published_at&quot;:[0,&quot;2024-12-30T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-12-30T14:00:03.282Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/260wIGiNfe3xebQgH4ihCO/974a2495b393d6f632479c394e5a938d/image5.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;76HSdQ6sNz56VVQXRUhhSw&quot;],&quot;name&quot;:[0,&quot;QUIC&quot;],&quot;slug&quot;:[0,&quot;quic&quot;]}],[0,{&quot;id&quot;:[0,&quot;4mFivBDCciYNedwQVKLKAg&quot;],&quot;name&quot;:[0,&quot;HTTP3&quot;],&quot;slug&quot;:[0,&quot;http3&quot;]}],[0,{&quot;id&quot;:[0,&quot;2IqedHUSRwmUemBf4R5nUa&quot;],&quot;name&quot;:[0,&quot;Testing&quot;],&quot;slug&quot;:[0,&quot;testing&quot;]}],[0,{&quot;id&quot;:[0,&quot;7ihMshJdu4QleFdxzaQA87&quot;],&quot;name&quot;:[0,&quot;Protocols&quot;],&quot;slug&quot;:[0,&quot;protocols&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Lucas Pardue&quot;],&quot;slug&quot;:[0,&quot;lucas&quot;],&quot;bio&quot;:[0,&quot;HTTP/2, HTTP/3 and QUIC @Cloudflare. IETF QUIC WG Co-Chair. I write some words, some code and occasionally speak.&quot;],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1k0fbniT2p2wjRfMognV4V/dca8d2e3a3e7fa4e24d7ddd9832eff1d/lucas.jpg&quot;],&quot;location&quot;:[0,&quot;London&quot;],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,&quot;@SimmerVigor&quot;],&quot;facebook&quot;:[0,null]}],[0,{&quot;name&quot;:[0,&quot;Evan Rittenhouse&quot;],&quot;slug&quot;:[0,&quot;evan-rittenhouse&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6TRFlHnVIfXX2cQhjt7wuc/86f2173516450dfa1e035b04cd4671c6/Screenshot_2024-12-21_at_17.56.35.png&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;h3i is a command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC. Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/h3i&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging&quot;],&quot;description&quot;:[0,&quot;Read about the motivation and background for h3i, along with practical examples that you can build upon for your own purposes.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/49kGUhFhN2iZIdcgGwDL6l/9f70e5deb1d4148f41be228340633c66/Open_sourcing_h3i-_a_command_line_tool_and_library_for_low-level_HTTP_3_testing_and_debugging-OG.png&quot;]}]}],&quot;initialReadingTime&quot;:[0,&quot;16&quot;],&quot;relatedPosts&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;5GK429XQHhFzVyKSXGZ2R6&quot;],&quot;title&quot;:[0,&quot;Elephants in tunnels: how Hyperdrive connects to databases inside your VPC networks&quot;],&quot;slug&quot;:[0,&quot;elephants-in-tunnels-how-hyperdrive-connects-to-databases-inside-your-vpc-networks&quot;],&quot;excerpt&quot;:[0,&quot;Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;<p></p><p>With September’s <a href=\&quot;https://blog.cloudflare.com/builder-day-2024-announcements/#connect-to-private-databases-from-workers\&quot;><u>announcement</u></a> of Hyperdrive’s ability to send database traffic from <a href=\&quot;https://workers.cloudflare.com/\&quot;><u>Workers</u></a> over <a href=\&quot;https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/\&quot;><u>Cloudflare Tunnels</u></a>, we wanted to dive into the details of what it took to make this happen.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;hyper-who\&quot;>Hyper-who?</h2>\n            <a href=\&quot;#hyper-who\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Accessing your data from anywhere in Region Earth can be hard. Traditional databases are powerful, familiar, and feature-rich, but your users can be thousands of miles away from your database. This can cause slower connection startup times, slower queries, and connection exhaustion as everything takes longer to accomplish.</p><p><a href=\&quot;https://developers.cloudflare.com/workers/\&quot;><u>Cloudflare Workers</u></a> is an incredibly lightweight runtime, which enables our customers to deploy their applications globally by default and renders the <a href=\&quot;https://en.wikipedia.org/wiki/Cold_start_(computing)\&quot;><u>cold start</u></a> problem almost irrelevant. The trade-off for these light, ephemeral execution contexts is the lack of persistence for things like database connections. Database connections are also notoriously expensive to spin up, with many round trips required between client and server before any query or result bytes can be exchanged.</p><p><a href=\&quot;https://blog.cloudflare.com/hyperdrive-making-regional-databases-feel-distributed\&quot;><u>Hyperdrive</u></a> is designed to make the centralized databases you already have feel like they’re global while keeping connections to those databases hot. We use our <a href=\&quot;https://www.cloudflare.com/network/\&quot;><u>global network</u></a> to get faster routes to your database, keep connection pools primed, and cache your most frequently run queries as close to users as possible.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;why-a-tunnel\&quot;>Why a Tunnel?</h2>\n            <a href=\&quot;#why-a-tunnel\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>For something as sensitive as your database, exposing access to the public Internet can be uncomfortable. It is common to instead host your database on a private network, and allowlist known-safe IP addresses or configure <a href=\&quot;https://www.cloudflare.com/learning/network-layer/what-is-gre-tunneling/\&quot;><u>GRE tunnels</u></a> to permit traffic to it. This is complex, toilsome, and error-prone.&nbsp;</p><p>On Cloudflare’s <a href=\&quot;https://www.cloudflare.com/en-gb/developer-platform/\&quot;><u>Developer Platform</u></a>, we strive for simplicity and ease-of-use. We cannot expect all of our customers to be experts in configuring networking solutions, and so we went in search of a simpler solution. <a href=\&quot;https://www.cloudflare.com/the-net/top-of-mind-security/customer-zero/\&quot;><u>Being your own customer</u></a> is rarely a bad choice, and it so happens that Cloudflare offers an excellent option for this scenario: Tunnels.</p><p><a href=\&quot;https://www.cloudflare.com/products/tunnel/\&quot;><u>Cloudflare Tunnel</u></a> is a Zero Trust product that creates a secure connection between your private network and Cloudflare. Exposing services within your private network can be as simple as <a href=\&quot;https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/\&quot;><u>running a </u><code><u>cloudflared</u></code><u> binary</u></a>, or deploying a Docker container running the <a href=\&quot;https://hub.docker.com/r/cloudflare/cloudflared\&quot;><code><u>cloudflared</u></code><u> image we distribute</u></a>. </p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3182f43rbwdH9krF1xhdlC/d22430cdb1efa134031f94fea691c36e/image1.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1000\&quot; height=\&quot;180\&quot; loading=\&quot;lazy\&quot;/>\n          </figure>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;a-custom-handler-and-generic-streams\&quot;>A custom handler and generic streams</h2>\n            <a href=\&quot;#a-custom-handler-and-generic-streams\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Integrating with Tunnels to support sending Postgres directly through them was a bit of a new challenge for us. Most of the time, when we use Tunnels internally (more on that later!), we rely on the excellent job <code>cloudflared</code> does of handling all of the mechanics, and we just treat them as pipes. That wouldn’t work for Hyperdrive, though, so we had to dig into how Tunnels actually ingress traffic to build a solution.</p><p>Hyperdrive handles Postgres traffic using an entirely custom implementation of the <a href=\&quot;https://www.postgresql.org/docs/current/protocol.html\&quot;><u>Postgres message protocol</u></a>. This is necessary, because we sometimes have to <a href=\&quot;https://blog.cloudflare.com/postgres-named-prepared-statements-supported-hyperdrive\&quot;><u>alter the specific type or content</u></a> of messages sent from client to server, or vice versa. Handling individual bytes gives us the flexibility to implement whatever logic any new feature might need.</p><p>An additional, perhaps less obvious, benefit of handling Postgres message traffic as just bytes is that we are not bound to the transport layer choices of some <a href=\&quot;https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping\&quot;><u>ORM</u></a> or library. One of the nuances of running services in Cloudflare is that we may want to egress traffic over different services or protocols, for a variety of different reasons. In this case, being able to egress traffic via a Tunnel would be pretty challenging if we were stuck with whatever raw TCP socket a library had established for us.</p><p>The way we accomplish this relies on a mainstay of Rust: <a href=\&quot;https://doc.rust-lang.org/book/ch10-02-traits.html\&quot;><u>traits</u></a> (which are how Rust lets developers apply logic across generic functions and types). In the Rust ecosystem, there are two traits that define the behavior Hyperdrive wants out of its transport layers: <a href=\&quot;https://docs.rs/tokio/latest/tokio/io/trait.AsyncRead.html\&quot;><code><u>AsyncRead</u></code></a> and <a href=\&quot;https://docs.rs/tokio/latest/tokio/io/trait.AsyncWrite.html\&quot;><code><u>AsyncWrite</u></code></a>. There are a couple of others we also need, but we’re going to focus on just these two. These traits enable us to code our entire custom handler against a generic stream of data, without the handler needing to know anything about the underlying protocol used to implement the stream. So, we can pass around a WebSocket connection as a generic I/O stream, wherever it might be needed.</p><p>As an example, the code to create a generic TCP stream and send a Postgres startup message across it might look like this:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>/// Send a startup message to a Postgres server, in the role of a PG client.\n/// https://www.postgresql.org/docs/current/protocol-message-formats.html#PROTOCOL-MESSAGE-FORMATS-STARTUPMESSAGE\npub async fn send_startup&amp;lt;S&amp;gt;(stream: &amp;amp;mut S, user_name: &amp;amp;str, db_name: &amp;amp;str, app_name: &amp;amp;str) -&amp;gt; Result&amp;lt;(), ConnectionError&amp;gt;\nwhere\n    S: AsyncWrite + Unpin,\n{\n    let protocol_number = 196608 as i32;\n    let user_str = &amp;amp;b&amp;quot;user\\0&amp;quot;[..];\n    let user_bytes = user_name.as_bytes();\n    let db_str = &amp;amp;b&amp;quot;database\\0&amp;quot;[..];\n    let db_bytes = db_name.as_bytes();\n    let app_str = &amp;amp;b&amp;quot;application_name\\0&amp;quot;[..];\n    let app_bytes = app_name.as_bytes();\n    let len = 4 + 4\n        + user_str.len() + user_bytes.len() + 1\n        + db_str.len() + db_bytes.len() + 1\n        + app_str.len() + app_bytes.len() + 1 + 1;\n\n    // Construct a BytesMut of our startup message, then send it\n    let mut startup_message = BytesMut::with_capacity(len as usize);\n    startup_message.put_i32(len as i32);\n    startup_message.put_i32(protocol_number);\n    startup_message.put(user_str);\n    startup_message.put_slice(user_bytes);\n    startup_message.put_u8(0);\n    startup_message.put(db_str);\n    startup_message.put_slice(db_bytes);\n    startup_message.put_u8(0);\n    startup_message.put(app_str);\n    startup_message.put_slice(app_bytes);\n    startup_message.put_u8(0);\n    startup_message.put_u8(0);\n\n    match stream.write_all(&amp;amp;startup_message).await {\n        Ok(_) =&amp;gt; Ok(()),\n        Err(err) =&amp;gt; {\n            error!(&amp;quot;Error writing startup to server: {}&amp;quot;, err.to_string());\n            ConnectionError::InternalError\n        }\n    }\n}\n\n/// Connect to a TCP socket\nlet stream = match TcpStream::connect((&amp;quot;localhost&amp;quot;, 5432)).await {\n    Ok(s) =&amp;gt; s,\n    Err(err) =&amp;gt; {\n        error!(&amp;quot;Error connecting to address: {}&amp;quot;, err.to_string());\n        return ConnectionError::InternalError;\n    }\n};\nlet _ = send_startup(&amp;amp;mut stream, &amp;quot;db_user&amp;quot;, &amp;quot;my_db&amp;quot;).await;</pre></code>\n            <p>With this approach, if we wanted to encrypt the stream using <a href=\&quot;https://www.cloudflare.com/learning/ssl/transport-layer-security-tls/#:~:text=Transport%20Layer%20Security%2C%20or%20TLS,web%20browsers%20loading%20a%20website.\&quot;><u>TLS</u></a> before we write to it (upgrading our existing <code>TcpStream</code> connection in-place, to an <code>SslStream</code>), we would only have to change the code we use to create the stream, while generating and sending the traffic would remain unchanged. This is because <code>SslStream</code> also implements <code>AsyncWrite</code>!</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>/// We&amp;#039;re handwaving the SSL setup here. You&amp;#039;re welcome.\nlet conn_config = new_tls_client_config()?;\n\n/// Encrypt the TcpStream, returning an SslStream\nlet ssl_stream = match tokio_boring::connect(conn_config, domain, stream).await {\n    Ok(s) =&amp;gt; s,\n    Err(err) =&amp;gt; {\n        error!(&amp;quot;Error during websocket TLS handshake: {}&amp;quot;, err.to_string());\n        return ConnectionError::InternalError;\n    }\n};\nlet _ = send_startup(&amp;amp;mut ssl_stream, &amp;quot;db_user&amp;quot;, &amp;quot;my_db&amp;quot;).await;</pre></code>\n            \n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;whence-websocket\&quot;>Whence WebSocket</h2>\n            <a href=\&quot;#whence-websocket\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p><a href=\&quot;https://datatracker.ietf.org/doc/html/rfc6455\&quot;><u>WebSocket</u></a> is an application layer protocol that enables bidirectional communication between a client and server. Typically, to establish a WebSocket connection, a client initiates an HTTP request and indicates they wish to upgrade the connection to WebSocket via the “Upgrade” header. Then, once the client and server complete the handshake, both parties can send messages over the connection until one of them terminates it.</p><p>Now, it turns out that the way Cloudflare Tunnels work under the hood is that both ends of the tunnel want to speak WebSocket, and rely on a translation layer to convert all traffic to or from WebSocket. The <code>cloudflared</code> daemon you spin up within your private network handles this for us! For Hyperdrive, however, we did not have a suitable translation layer to send Postgres messages across WebSocket, and had to write one.</p><p>One of the (many) fantastic things about Rust traits is that the contract they present is very clear. To be <code>AsyncRead</code>, you just need to implement <code>poll_read</code>. To be <code>AsyncWrite</code>, you need to implement only three functions (<code>poll_write</code>, <code>poll_flush</code>, and <code>poll_shutdown</code>). Further, there is excellent support for WebSocket in Rust built on top of the <a href=\&quot;https://github.com/snapview/tungstenite-rs\&quot;><u>tungstenite-rs library</u></a>.</p><p>Thus, building our custom WebSocket stream such that it can share the same machinery as all our other generic streams just means translating the existing WebSocket support into these poll functions. There are some existing OSS projects that do this, but for multiple reasons we could not use the existing options. The primary reason is that Hyperdrive operates across multiple threads (thanks to the <a href=\&quot;https://docs.rs/tokio/latest/tokio/runtime/index.html\&quot;><u>tokio runtime</u></a>), and so we rely on our connections to also handle <a href=\&quot;https://doc.rust-lang.org/std/marker/trait.Send.html\&quot;><code><u>Send</u></code></a>, <a href=\&quot;https://doc.rust-lang.org/std/marker/trait.Sync.html\&quot;><code><u>Sync</u></code></a>, and <a href=\&quot;https://doc.rust-lang.org/std/marker/trait.Unpin.html\&quot;><code><u>Unpin</u></code></a>. None of the available solutions had all five traits handled. It turns out that most of them went with the paradigm of <a href=\&quot;https://docs.rs/futures/latest/futures/sink/trait.Sink.html\&quot;><code><u>Sink</u></code></a> and <a href=\&quot;https://docs.rs/futures/latest/futures/stream/trait.Stream.html\&quot;><code><u>Stream</u></code></a>, which provide a solid base from which to translate to <code>AsyncRead</code> and <code>AsyncWrite</code>. In fact some of the functions overlap, and can be passed through almost unchanged. For example, <code>poll_flush</code> and <code>poll_shutdown</code> have 1-to-1 analogs, and require almost no engineering effort to convert from <code>Sink</code> to <code>AsyncWrite</code>.</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>/// We use this struct to implement the traits we need on top of a WebSocketStream\npub struct HyperSocket&amp;lt;S&amp;gt;\nwhere\n    S: AsyncRead + AsyncWrite + Send + Sync + Unpin,\n{\n    inner: WebSocketStream&amp;lt;S&amp;gt;,\n    read_state: Option&amp;lt;ReadState&amp;gt;,\n    write_err: Option&amp;lt;Error&amp;gt;,\n}\n\nimpl&amp;lt;S&amp;gt; AsyncWrite for HyperSocket&amp;lt;S&amp;gt;\nwhere\n    S: AsyncRead + AsyncWrite + Send + Sync + Unpin,\n{\n    fn poll_flush(mut self: Pin&amp;lt;&amp;amp;mut Self&amp;gt;, cx: &amp;amp;mut Context&amp;lt;&amp;#039;_&amp;gt;) -&amp;gt; Poll&amp;lt;io::Result&amp;lt;()&amp;gt;&amp;gt; {\n        match ready!(Pin::new(&amp;amp;mut self.inner).poll_flush(cx)) {\n            Ok(_) =&amp;gt; Poll::Ready(Ok(())),\n            Err(err) =&amp;gt; Poll::Ready(Err(Error::new(ErrorKind::Other, err))),\n        }\n    }\n\n    fn poll_shutdown(mut self: Pin&amp;lt;&amp;amp;mut Self&amp;gt;, cx: &amp;amp;mut Context&amp;lt;&amp;#039;_&amp;gt;) -&amp;gt; Poll&amp;lt;io::Result&amp;lt;()&amp;gt;&amp;gt; {\n        match ready!(Pin::new(&amp;amp;mut self.inner).poll_close(cx)) {\n            Ok(_) =&amp;gt; Poll::Ready(Ok(())),\n            Err(err) =&amp;gt; Poll::Ready(Err(Error::new(ErrorKind::Other, err))),\n        }\n    }\n}\n</pre></code>\n            <p>With that translation done, we can use an existing WebSocket library to upgrade our <code>SslStream</code> connection to a Cloudflare Tunnel, and wrap the result in our <code>AsyncRead/AsyncWrite</code> implementation. The result can then be used anywhere that our other transport streams would work, without any changes needed to the rest of our codebase!&nbsp;</p><p>That would look something like this:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>let websocket = match tokio_tungstenite::client_async(request, ssl_stream).await {\n    Ok(ws) =&amp;gt; Ok(ws),\n    Err(err) =&amp;gt; {\n        error!(&amp;quot;Error during websocket conn setup: {}&amp;quot;, err.to_string());\n        return ConnectionError::InternalError;\n    }\n};\nlet websocket_stream = HyperSocket::new(websocket));\nlet _ = send_startup(&amp;amp;mut websocket_stream, &amp;quot;db_user&amp;quot;, &amp;quot;my_db&amp;quot;).await;</pre></code>\n            \n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;access-granted\&quot;>Access granted</h2>\n            <a href=\&quot;#access-granted\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>An observant reader might have noticed that in the code example above we snuck in a variable named request that we passed in when upgrading from an <code>SslStream to a WebSocketStream</code>. This is for multiple reasons. The first reason is that Tunnels are assigned a hostname and use this hostname for routing. The second and more interesting reason is that (as mentioned above) when negotiating an upgrade from HTTP to WebSocket, a request must be sent to the server hosting the ingress side of the Tunnel to <a href=\&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism\&quot;><u>perform the upgrade</u></a>. This is pretty universal, but we also add in an extra piece here.</p><p>At Cloudflare, we believe that <a href=\&quot;https://blog.cloudflare.com/secure-by-default-understanding-new-cisa-guide/\&quot;><u>secure defaults</u></a> and <a href=\&quot;https://www.cloudflare.com/learning/security/glossary/what-is-defense-in-depth/\&quot;><u>defense in depth</u></a> are the correct ways to build a better Internet. This is why traffic across Tunnels is encrypted, for example. However, that does not necessarily prevent unwanted traffic from being sent into your Tunnel, and therefore egressing out to your database. While Postgres offers a robust set of <a href=\&quot;https://www.postgresql.org/docs/current/user-manag.html\&quot;><u>access control</u></a> options for protecting your database, wouldn’t it be best if unwanted traffic never got into your private network in the first place?&nbsp;</p><p>To that end, all <a href=\&quot;https://developers.cloudflare.com/hyperdrive/configuration/connect-to-private-database/\&quot;><u>Tunnels set up for use with Hyperdrive</u></a> should have a <a href=\&quot;https://developers.cloudflare.com/cloudflare-one/applications/\&quot;><u>Zero Trust Access Application</u></a> configured to protect them. These applications should use a <a href=\&quot;https://developers.cloudflare.com/cloudflare-one/identity/service-tokens/\&quot;><u>Service Token</u></a> to authorize connections. When setting up a new Hyperdrive, you have the option to provide the token’s ID and Secret, which will be encrypted and stored alongside the rest of your configuration. These will be presented as part of the WebSocket upgrade request to authorize the connection, allowing your database traffic through while preventing unwanted access.</p><p>This can be done within the request’s headers, and might look something like this:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>let ws_url = format!(&amp;quot;wss://{}&amp;quot;, host);\nlet mut request = match ws_url.into_client_request() {\n    Ok(req) =&amp;gt; req,\n    Err(err) =&amp;gt; {\n        error!(\n            &amp;quot;Hostname {} could not be parsed into a valid request URL: {}&amp;quot;, \n            host,\n            err.to_string()\n        );\n        return ConnectionError::InternalError;\n    }\n};\nrequest.headers_mut().insert(\n    &amp;quot;CF-Access-Client-Id&amp;quot;,\n    http::header::HeaderValue::from_str(&amp;amp;client_id).unwrap(),\n);\nrequest.headers_mut().insert(\n    &amp;quot;CF-Access-Client-Secret&amp;quot;,\n    http::header::HeaderValue::from_str(&amp;amp;client_secret).unwrap(),\n);\n</pre></code>\n            \n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;building-for-customer-zero\&quot;>Building for customer zero</h2>\n            <a href=\&quot;#building-for-customer-zero\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>If you’ve been reading the blog for a long time, some of this might sound a bit familiar.&nbsp; This isn’t the first time that we’ve <a href=\&quot;https://blog.cloudflare.com/cloudflare-tunnel-for-postgres/\&quot;><u>sent Postgres traffic across a tunnel</u></a>, it’s something most of us do from our laptops regularly.&nbsp; This works very well for interactive use cases with low traffic volume and a high tolerance for latency, but historically most of our products have not been able to employ the same approach.</p><p>Cloudflare operates <a href=\&quot;https://www.cloudflare.com/network/\&quot;><u>many data centers</u></a> around the world, and most services run in every one of those data centers. There are some tasks, however, that make the most sense to run in a more centralized fashion. These include tasks such as managing control plane operations, or storing configuration state.&nbsp; Nearly every Cloudflare product houses its control plane information in <a href=\&quot;https://blog.cloudflare.com/performance-isolation-in-a-multi-tenant-database-environment/\&quot;><u>Postgres clusters</u></a> run centrally in a handful of our data centers, and we use a variety of approaches for accessing that centralized data from elsewhere in our network. For example, many services currently use a push-based model to publish updates to <a href=\&quot;https://blog.cloudflare.com/moving-quicksilver-into-production/\&quot;><u>Quicksilver</u></a>, and work through the complexities implied by such a model. This has been a recurring challenge for any team looking to build a new product.</p><p>Hyperdrive’s entire reason for being is to make it easy to access such central databases from our global network. When we began exploring Tunnel integrations as a feature, many internal teams spoke up immediately and strongly suggested they’d be interested in using it themselves. This was an excellent opportunity for Cloudflare to scratch its own itch, while also getting a lot of traffic on a new feature before releasing it directly to the public. As always, being “customer zero” means that we get fast feedback, more reliability over time, stronger connections between teams, and an overall better suite of products. We jumped at the chance.</p><p>As we rolled out early versions of Tunnel integration, we worked closely with internal teams to get them access to it, and fixed any rough spots they encountered. We’re pleased to share that this first batch of teams have found great success building new or refactored products on Hyperdrive over Tunnels. For example: if you’ve already tried out <a href=\&quot;https://blog.cloudflare.com/builder-day-2024-announcements/#continuous-integration-and-delivery\&quot;><u>Workers Builds</u></a>, or recently <a href=\&quot;https://www.cloudflare.com/trust-hub/reporting-abuse/\&quot;><u>submitted an abuse report</u></a>, you’re among our first users!&nbsp; At the time of this writing, we have several more internal teams working to onboard, and we on the Hyperdrive team are very excited to see all the different ways in which fast and simple connections from Workers to a centralized database can help Cloudflare just as much as they’ve been helping our external customers.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;outro\&quot;>Outro</h2>\n            <a href=\&quot;#outro\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Cloudflare is on a mission to make the Internet faster, safer, and more reliable. Hyperdrive was built to make connecting to centralized databases from the Workers runtime as quick and consistent as possible, and this latest development is designed to help all those who want to use Hyperdrive without directly exposing resources within their virtual private clouds (VPCs) on the public web.</p><p>To this end, we chose to build a solution around our suite of industry-leading <a href=\&quot;https://developers.cloudflare.com/cloudflare-one/\&quot;><u>Zero Trust</u></a> tools, and were delighted to find how simple it was to implement in our runtime given the power and extensibility of the Rust <code>trait</code> system.&nbsp;</p><p>Without waiting for the ink to dry, multiple teams within Cloudflare have adopted this new feature to quickly and easily solve what have historically been complex challenges, and are happily operating it in production today.</p><p>And now, if you haven&amp;#39;t already, try <a href=\&quot;https://developers.cloudflare.com/hyperdrive/configuration/connect-to-private-database/\&quot;><u>setting up Hyperdrive across a Tunnel</u></a>, and let us know what you think in the <a href=\&quot;https://discord.com/channels/595317990191398933/1150557986239021106\&quot;><u>Hyperdrive Discord channel</u></a>!</p>&quot;],&quot;published_at&quot;:[0,&quot;2024-10-25T14:00+01:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-29T13:01:27.233Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/24ic7s5StC7EDyqYne4WN6/02f061b0aef358ecc2d5da4150e5b0fc/image2.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;3JAY3z7p7An94s6ScuSQPf&quot;],&quot;name&quot;:[0,&quot;Developer Platform&quot;],&quot;slug&quot;:[0,&quot;developer-platform&quot;]}],[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}],[0,{&quot;id&quot;:[0,&quot;6hbkItfupogJP3aRDAq6v8&quot;],&quot;name&quot;:[0,&quot;Cloudflare Workers&quot;],&quot;slug&quot;:[0,&quot;workers&quot;]}],[0,{&quot;id&quot;:[0,&quot;5EP9xxxSTGvFx3RIxjqIgP&quot;],&quot;name&quot;:[0,&quot;Hyperdrive&quot;],&quot;slug&quot;:[0,&quot;hyperdrive&quot;]}],[0,{&quot;id&quot;:[0,&quot;5f5l99WZnbCCF9O6Emw56A&quot;],&quot;name&quot;:[0,&quot;Postgres&quot;],&quot;slug&quot;:[0,&quot;postgres&quot;]}],[0,{&quot;id&quot;:[0,&quot;1pPf2NNj9SXrC0A0ERKp9v&quot;],&quot;name&quot;:[0,&quot;SQL&quot;],&quot;slug&quot;:[0,&quot;sql&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}],[0,{&quot;id&quot;:[0,&quot;1aoMsyWESTqiSKzdHZXOKW&quot;],&quot;name&quot;:[0,&quot;WebSockets&quot;],&quot;slug&quot;:[0,&quot;websockets&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Andrew Repp&quot;],&quot;slug&quot;:[0,&quot;andrew-repp&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1moTBd0N5e74Bn9NWn2ksO/9642b164dcf16e501a79e56520548aa2/andrew-repp.jpg&quot;],&quot;location&quot;:[0,&quot;Chicago, IL, USA&quot;],&quot;website&quot;:[0,&quot;http://andrewrepp.com&quot;],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}],[0,{&quot;name&quot;:[0,&quot;Emilio Assunção&quot;],&quot;slug&quot;:[0,&quot;emilio-assuncao&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3tOkImW4PKNYEyP4o7Pkhe/ee40249c46e72656a8e2352485ec7d5e/_tmp_mini_magick20221018-42-16be3qy.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}],[0,{&quot;name&quot;:[0,&quot;Abhishek Chanda&quot;],&quot;slug&quot;:[0,&quot;abhishek-chanda&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3P0qYqbNeI32RV8dDNiWyr/851507446803b9f182229b98e512eb5f/_tmp_mini_magick20221012-43-o7wrnr.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0,&quot;@rony358&quot;],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/elephants-in-tunnels-how-hyperdrive-connects-to-databases-inside-your-vpc-networks&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Elephants in tunnels: how Hyperdrive connects to databases inside your VPC networks&quot;],&quot;description&quot;:[0,&quot;Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3ut6WBHomsRN0iP92D1hpp/ecdc9573ebc09c140c865494d029f54e/image2.png&quot;]}]}],[0,{&quot;id&quot;:[0,&quot;2CqKLNS1jaf5H2j99sDONe&quot;],&quot;title&quot;:[0,&quot;A good day to trie-hard: saving compute 1% at a time&quot;],&quot;slug&quot;:[0,&quot;pingora-saving-compute-1-percent-at-a-time&quot;],&quot;excerpt&quot;:[0,&quot;Pingora handles 35M+ requests per second, so saving a few microseconds per request can translate to thousands of dollars saved on computing costs. In this post, we share how we freed up over 500 CPU cores by optimizing one function and announce trie-hard, the open source crate that we created to do it.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5uwVNobeSBws457ad5SoNY/080de413142fc98caffc3c0108912fe4/2442-1-hero.png\&quot; alt=\&quot;2442-1-hero\&quot; class=\&quot;kg-image\&quot; width=\&quot;1800\&quot; height=\&quot;1013\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p>Cloudflare’s global network handles <i>a lot</i> of HTTP requests – over 60 million per second on average. That in and of itself is not news, but it is the starting point to an adventure that started a few months ago and ends with the announcement of a new <a href=\&quot;https://github.com/cloudflare/trie-hard\&quot;><u>open-source Rust crate</u></a> that we are using to reduce our CPU utilization, enabling our CDN to handle even more of the world’s ever-increasing Web traffic.&nbsp;</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;motivation\&quot;>Motivation</h2>\n            <a href=\&quot;#motivation\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Let’s start at the beginning. You may recall a few months ago we released <a href=\&quot;https://blog.cloudflare.com/pingora-open-source/\&quot;><u>Pingora</u></a> (the heart of our Rust-based proxy services) as an <a href=\&quot;https://github.com/cloudflare/pingora\&quot;><u>open-source project on GitHub</u></a>. I work on the team that maintains the Pingora framework, as well as Cloudflare’s production services built upon it. One of those services is responsible for the final step in transmitting users’ (non-cached) requests to their true destination. Internally, we call the request’s destination server its “origin”, so our service has the (unimaginative) name of “pingora-origin”.</p><p>One of the many responsibilities of pingora-origin is to ensure that when a request leaves our infrastructure, it has been cleaned to remove the internal information we use to route, measure, and optimize traffic for our customers. This has to be done for every request that leaves Cloudflare, and as I mentioned above, it’s <i>a lot</i> of requests. At the time of writing, the rate of requests leaving pingora-origin (globally) is 35 million requests per second. Any code that has to be run per-request is in the hottest of hot paths, and it’s in this path that we find this code and comment:</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>// PERF: heavy function: 1.7% CPU time\npub fn clear_internal_headers(request_header: &amp;amp;mut RequestHeader) {\n    INTERNAL_HEADERS.iter().for_each(|h| {\n        request_header.remove_header(h);\n    });\n}</pre></code>\n            <p></p><p>This small and pleasantly-readable function consumes more than 1.7% of pingora-origin’s total cpu time. To put that in perspective, the total cpu time consumed by pingora-origin is 40,000 compute-seconds per second. You can think of this as 40,000 saturated CPU cores fully dedicated to running pingora-origin. Of those 40,000, 1.7% (680) are only dedicated to evaluating <code>clear_internal_headers</code>. The function’s heavy usage and simplicity make it seem like a great place to start optimizing.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;benchmarking\&quot;>Benchmarking</h2>\n            <a href=\&quot;#benchmarking\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Benchmarking the function shown above is straightforward because we can use the wonderful <a href=\&quot;https://crates.io/crates/criterion\&quot;><u>criterion</u></a> Rust crate. Criterion provides an api for timing rust code down to the nanosecond by aggregating multiple isolated executions. It also provides feedback on how the performance improves or regresses over time. The input for the benchmark is a large set of synthesized requests with a random number of headers with a uniform distribution of internal vs. non-internal headers. With our tooling and test data we find that our original <code>clear_internal_headers</code> function runs in an average of <b>3.65µs</b>. Now for each new method of clearing headers, we can measure against the same set of requests and get a relative performance difference.&nbsp;</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;reducing-reads\&quot;>Reducing Reads</h2>\n            <a href=\&quot;#reducing-reads\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>One potentially quick win is to invert how we find the headers that need to be removed from requests. If you look at the original code, you can see that we are evaluating <code>request_header.remove_header(h)</code> for each header in our list of internal headers, so 100+ times. Diagrammatically, it looks like this:</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7y2qHbNfBQeoGRc8PqjBcp/9e8fccb6951a475a26def66695e47635/2442-2.png\&quot; alt=\&quot;2442-2\&quot; class=\&quot;kg-image\&quot; width=\&quot;568\&quot; height=\&quot;244\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p><p>Since an average request has significantly fewer than 100 headers (10-30), flipping the lookup direction should reduce the number of reads while yielding the same intersection. Because we are working in Rust (and because <code>retain</code> does not exist for <code>http::HeaderMap</code> <a href=\&quot;https://github.com/hyperium/http/issues/541\&quot;><u>yet</u></a>), we have to collect the identified internal headers in a separate step before removing them from the request. Conceptually, it looks like this:</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6hgLavu1hZbwkw91Tee8e1/4d43b538274ae2c680236ca66791d73b/2442-3.png\&quot; alt=\&quot;2442-3\&quot; class=\&quot;kg-image\&quot; width=\&quot;599\&quot; height=\&quot;351\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p><p>Using our benchmarking tool, we can measure the impact of this small change, and surprisingly this is already a substantial improvement. The runtime improves from <b>3.65µs</b> to <b>1.53µs</b>. That’s a 2.39x speed improvement for our function. We can calculate the theoretical CPU percentage by multiplying the starting utilization by the ratio of the new and old times: 1.71% * 1.53 / 3.65 = 0.717%. Unfortunately, if we subtract that from the original 1.71% that only equates to saving 1.71% - 0.717% = <i>0.993%</i> of the total CPU time. We should be able to do better.&nbsp;</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;searching-data-structures\&quot;>Searching Data Structures</h2>\n            <a href=\&quot;#searching-data-structures\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Now that we have reorganized our function to search a static set of internal headers instead of the actual request, we have the freedom to choose what data structure we store our header name in simply by changing the type of <code>INTERNAL_HEADER_SET</code>.</p>\n            <pre class=\&quot;language-RUST\&quot;><code class=\&quot;language-RUST\&quot;>pub fn clear_internal_headers(request_header: &amp;amp;mut RequestHeader) {\n   let to_remove = request_header\n       .headers\n       .keys()\n       .filter_map(|name| INTERNAL_HEADER_SET.get(name))\n       .collect::&amp;lt;Vec&amp;lt;_&amp;gt;&amp;gt;();\n\n\n   to_remove.into_iter().for_each(|k| {\n       request_header.remove_header(k);\n   });</pre></code>\n            <p></p><p>Our first attempt used <code>std::HashMap</code>, but there may be other data structures that better suit our needs. All computer science students were taught at some point that hash tables are great because they have constant-time asymptotic behavior, or O(1), for reading. (If you are not familiar with <a href=\&quot;https://www.khanacademy.org/computing/computer-science/algorithms/asymptotic-notation/a/big-o-notation\&quot;><u>big O notation</u></a>, it is a way to express how an algorithm consumes a resource, in this case time, as the input size changes.) This means no matter how large the map gets, reads always take the same amount of time. Too bad this is only partially true. In order to read from a hash table, you have to compute the hash. Computing a hash for strings requires reading every byte, so while read time for a hashmap is constant over the table’s size, it’s linear over key length. So, our goal is to find a data structure that is better than O(L) where L is the length of the key.</p><p>There are a few common data structures that provide for reads that have read behavior that meets our criteria. Sorted sets like <code>BTreeSet</code> use comparisons for searching, and that makes them logarithmic over key length <b>O(log(L))</b>, but they are also logarithmic in size too. The net effect is that even very fast sorted sets like <a href=\&quot;https://crates.io/crates/fst\&quot;><u>FST</u></a> work out to be a little (50 ns) slower in our benchmarks than the standard hashmap.</p><p>State machines like parsers and regex are another common tool for searching for strings, though it’s hard to consider them data structures. These systems work by accepting input one unit at a time and determining on each step whether or not to keep evaluating. Being able to make these determinations at every step means state machines are very fast to identify negative cases (i.e. when a string is not valid or not a match). This is perfect for us because only one or two headers per request on average will be internal. In fact, benchmarking an implementation of <code>clear_internal_headers</code> using regular expressions clocks in as taking about twice as long as the hashmap-based solution. This is impressively fast given that regexes, while powerful, aren&amp;#39;t known for their raw speed. This approach feels promising – we just need something in between a data structure and a state machine. </p><p>That’s where the trie comes in.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;dont-just-trie\&quot;>Don’t Just Trie</h2>\n            <a href=\&quot;#dont-just-trie\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>A <a href=\&quot;https://en.wikipedia.org/wiki/Trie\&quot;><u>trie</u></a> (pronounced like “try” or “tree”) is a type of <a href=\&quot;https://en.wikipedia.org/wiki/Tree_(data_structure)\&quot;><u>tree data structure</u></a> normally used for prefix searches or auto-complete systems over a known set of strings. The structure of the trie lends itself to this because each node in the trie represents a substring of characters found in the initial set. The connections between the nodes represent the characters that can follow a prefix. Here is a small example of a trie built from the words: “and”, “ant”, “dad”, “do”, &amp;amp; “dot”.&nbsp;</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5wy48j3XNs9awxRNvjLljC/4e2a05b4e1802eba26f9e10e95bd843f/2442-4.png\&quot; alt=\&quot;2442-4\&quot; class=\&quot;kg-image\&quot; width=\&quot;519\&quot; height=\&quot;291\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p>The root node represents an empty string prefix, so the two lettered edges directed out of it are the only letters that can appear as the first letter in the list of strings, “a” and “d”. Subsequent nodes have increasingly longer prefixes until the final valid words are reached. This layout should make it easy to see how a trie could be useful for quickly identifying strings that are not contained. Even at the root node, we can eliminate any strings that are presented that do not start with “a” or “d”. This paring down of the search space on every step gives reading from a trie the <b>O(log(L))</b> we were looking for … but only for misses. Hits within a trie are still <b>O(L)</b>, but that’s okay, because we are getting misses over 90% of the time.</p><p>Benchmarking a few trie implementations from <a href=\&quot;https://crates.io/search?q=trie\&quot;><u>crates.io</u></a> was disheartening. Remember, most tries are used in response to keyboard events, so optimizing them to run in the hot path of tens of millions of requests per second is not a priority. The fastest existing implementation we found was <a href=\&quot;https://crates.io/crates/radix_trie\&quot;><u>radix_trie</u></a>, but it still clocked in at a full microsecond slower than hashmap. The only thing left to do was write our own implementation of a trie that was optimized for our use case.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;trie-hard\&quot;>Trie Hard</h2>\n            <a href=\&quot;#trie-hard\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>And we did! Today we are announcing <a href=\&quot;https://github.com/cloudflare/trie-hard\&quot;><u>trie-hard</u></a>. The repository gives a full description of how it works, but the big takeaway is that it gets its speed from storing node relationships in the bits of unsigned integers and keeping the entire tree in a contiguous chunk of memory. In our benchmarks, we found that trie-hard reduced the average runtime for <code>clear_internal_headers</code> to under a microsecond (0.93µs). We can reuse the same formula from above to calculate the expected CPU utilization for trie-hard to be 1.71% * 3.65 / 0.93 = 0.43% That means we have finally achieved and surpassed our goal by reducing the compute utilization of pingora-origin by 1.71% - 0.43% =&nbsp; <b>1.28%</b>!&nbsp;</p><p>Up until now we have been working only in theory and local benchmarking. What really matters is whether our benchmarking reflects real-life behavior. Trie-hard has been running in production since July 2024, and over the course of this project we have been collecting performance metrics from the running production of pingora-origin using a statistical sampling of its stack trace over time. Using this technique, the CPU utilization percentage of a function is estimated by the percent of samples in which the function appears. If we compare the sampled performance of the different versions of <code>clear_internal_headers</code>, we can see that the results from the performance sampling closely match what our benchmarks predicted.</p><table><tr><th><p>Implementation</p></th><th><p>Stack trace samples containing <code>clear_internal_headers</code></p></th><th><p>Actual CPU Usage (%)</p></th><th><p>Predicted CPU Usage (%)</p></th></tr><tr><td><p>Original&nbsp;</p></td><td><p>19 / 1111</p></td><td><p>1.71</p></td><td><p>n/a</p></td></tr><tr><td><p>Hashmap</p></td><td><p>9 / 1103</p></td><td><p>0.82</p></td><td><p>0.72</p></td></tr><tr><td><p>trie-hard</p></td><td><p>4 / 1171</p></td><td><p>0.34</p></td><td><p>0.43</p></td></tr></table>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;conclusion\&quot;>Conclusion</h2>\n            <a href=\&quot;#conclusion\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>Optimizing functions and writing new data structures is cool, but the real conclusion for this post is that knowing where your code is slow and by how much is more important than how you go about optimizing it. Take a moment to thank your observability team (if you&amp;#39;re lucky enough to have one), and make use of flame graphs or any other profiling and benchmarking tool you can. Optimizing operations that are already measured in microseconds may seem a little silly, but these small improvements add up.</p>&quot;],&quot;published_at&quot;:[0,&quot;2024-09-10T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-09T23:05:23.370Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5uwVNobeSBws457ad5SoNY/080de413142fc98caffc3c0108912fe4/2442-1-hero.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;x8ZMj9p778dTDn2pFIaGP&quot;],&quot;name&quot;:[0,&quot;Internet Performance&quot;],&quot;slug&quot;:[0,&quot;internet-performance&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}],[0,{&quot;id&quot;:[0,&quot;3txfsA7N73yBL9g3VPBLL0&quot;],&quot;name&quot;:[0,&quot;Open Source&quot;],&quot;slug&quot;:[0,&quot;open-source&quot;]}],[0,{&quot;id&quot;:[0,&quot;2kPXcZlQ7I9S1hKI5tRYxl&quot;],&quot;name&quot;:[0,&quot;Optimization&quot;],&quot;slug&quot;:[0,&quot;optimization&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Kevin Guthrie&quot;],&quot;slug&quot;:[0,&quot;kevin-guthrie&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/61WQLEZaZz6iuYFaIyXVqi/ed69550880128eeade8c7d75d97e555f/-W1A6801.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0,&quot;johnhurt&quot;],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;Pingora handles 35M+ requests per second, so saving a few microseconds per request can translate to thousands of dollars saved on computing costs. In this post, we share how we freed up over 500 CPU cores by optimizing one function and announce trie-hard, the open source crate that we created to do it.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/pingora-saving-compute-1-percent-at-a-time&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;A good day to trie-hard: saving compute 1% at a time&quot;],&quot;description&quot;:[0,&quot;Pingora handles 35M+ requests per second, so saving a few microseconds per request can translate to thousands of dollars saved on computing costs. In this post, we share how we freed up over 500 CPU cores by optimizing one function and announce trie-hard, the open source crate that we created to do it.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7sPe2ORh9vzsbG6owWUicC/0add1e7522aad2861699ec02672f071a/-2024-_Blog_Template__1200x628_.png&quot;]}]}],[0,{&quot;id&quot;:[0,&quot;1NVmSxeyTXrlaivG80ZNzS&quot;],&quot;title&quot;:[0,&quot;Go wild: Wildcard support in Rules and a new open-source wildcard crate&quot;],&quot;slug&quot;:[0,&quot;wildcard-rules&quot;],&quot;excerpt&quot;:[0,&quot;We’re excited to announce wildcard support across our Ruleset Engine-based products and our open-source wildcard crate in Rust. Configuring rules has never been easier, with powerful pattern matching enabling simple and flexible URL redirects and beyond for users on all plans.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5SVubtrh9iaqDDQSnA60Me/b511db040441d802b147cb838448ab26/2478-1-hero.png\&quot; alt=\&quot;2478-1-hero\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;1125\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p>Back in 2012, we <a href=\&quot;https://blog.cloudflare.com/introducing-pagerules-fine-grained-feature-co\&quot;><u>introduced</u></a> <a href=\&quot;https://developers.cloudflare.com/rules/page-rules/\&quot;><u>Page Rules</u></a>, a pioneering feature that gave Cloudflare users unprecedented control over how their web traffic was managed. At the time, this was a significant leap forward, enabling users to define <a href=\&quot;https://developers.cloudflare.com/rules/page-rules/reference/wildcard-matching/\&quot;><u>patterns</u></a> for specific URLs and adjust Cloudflare <a href=\&quot;https://developers.cloudflare.com/rules/page-rules/reference/settings/\&quot;><u>features</u></a> on a page-by-page basis. The ability to apply such precise configurations through a simple, user-friendly interface was a major advancement, establishing Page Rules as a cornerstone of our platform.</p><p>Page Rules allowed users to implement a variety of actions, including <a href=\&quot;https://developers.cloudflare.com/rules/url-forwarding/#redirects\&quot;><u>redirects</u></a>, which automatically send visitors from one URL to another. Redirects are crucial for maintaining a seamless user experience on the Internet, whether it&amp;#39;s guiding users <a href=\&quot;https://developers.cloudflare.com/rules/url-forwarding/examples/redirect-new-url/\&quot;><u>from outdated links to new content</u></a> or managing traffic during <a href=\&quot;https://developers.cloudflare.com/rules/url-forwarding/examples/redirect-all-different-hostname/\&quot;><u>site migrations</u></a>.</p><p>As the Internet has evolved, so too have the needs of our users. The demand for greater flexibility, higher performance, and more advanced capabilities led to the development of the <a href=\&quot;https://developers.cloudflare.com/ruleset-engine/\&quot;><u>Ruleset Engine</u></a>, a powerful framework designed to handle complex rule evaluations with unmatched speed and precision.</p><p>In September 2022, we announced and released <a href=\&quot;https://blog.cloudflare.com/dynamic-redirect-rules\&quot;><u>Single Redirects</u></a> as a modern replacement for the <a href=\&quot;https://developers.cloudflare.com/rules/page-rules/how-to/url-forwarding/\&quot;><u>URL Forwarding</u></a> feature of Page Rules. Built on top of the Ruleset Engine, this new product offered a powerful syntax and enhanced performance.</p><p>Despite the <a href=\&quot;https://blog.cloudflare.com/future-of-page-rules\&quot;><u>enhancements</u></a>, one of the most consistent pieces of feedback from our users was the need for wildcard matching and expansion, also known as <a href=\&quot;https://github.com/begin/globbing\&quot;><u>globbing</u></a>. This feature is essential for creating dynamic and flexible URL patterns, allowing users to manage a broader range of scenarios with ease.</p><p>Today we are excited to announce that wildcard support is now available across our Ruleset Engine-based products, including <a href=\&quot;https://developers.cloudflare.com/cache/how-to/cache-rules/\&quot;><u>Cache Rules</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/compression-rules/\&quot;><u>Compression Rules</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/configuration-rules/\&quot;><u>Configuration Rules</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/custom-error-responses/\&quot;><u>Custom Errors</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/origin-rules/\&quot;><u>Origin Rules</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/url-forwarding/\&quot;><u>Redirect Rules</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/snippets/\&quot;><u>Snippets</u></a>, <a href=\&quot;https://developers.cloudflare.com/rules/transform/\&quot;><u>Transform Rules</u></a>, <a href=\&quot;https://developers.cloudflare.com/waf/\&quot;><u>Web Application Firewall (WAF)</u></a>, <a href=\&quot;https://developers.cloudflare.com/waiting-room/\&quot;><u>Waiting Room</u></a>, and more.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;understanding-wildcards\&quot;>Understanding wildcards</h3>\n            <a href=\&quot;#understanding-wildcards\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>Wildcard pattern matching allows users to employ an asterisk <code>(*)</code> in a string to match certain patterns. For example, a single pattern like <code>https://example.com/*/t*st</code> can cover multiple URLs such as <code>https://example.com/en/test</code>, <code>https://example.com/images/toast</code>, and <code>https://example.com/blog/trust</code>.</p><p>Once a segment is captured, it can be used in another expression by referencing the matched wildcard with the <code>${&amp;lt;X&amp;gt;}</code> syntax, where <code>&amp;lt;X&amp;gt;</code> indicates the index of a matched pattern. This is particularly useful in URL forwarding. For instance, the URL pattern <code>https://example.com/*/t*st</code> can redirect to <code>https://${1}.example.com/t${2}st</code>, allowing dynamic and flexible URL redirection. This setup ensures that <code>https://example.com/uk/test</code> is forwarded to <code>https://uk.example.com/test</code>, <code>https://example.com/images/toast</code> to <code>https://images.example.com/toast</code>, and so on.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;challenges-with-single-redirects\&quot;>Challenges with Single Redirects</h3>\n            <a href=\&quot;#challenges-with-single-redirects\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>In Page Rules, redirecting from an old URI path to a new one looked like this:</p><ul><li><p><b>Source URL:</b> <code>https://example.com/old-path/*</code></p></li><li><p><b>Target URL:</b> <code>https://example.com/new-path/$1</code></p></li></ul><p>In comparison, replicating this behaviour in Single Redirects without wildcards required a more complex approach:</p><ul><li><p><b>Filter:</b> <code>(http.host eq &amp;quot;example.com&amp;quot; and starts_with(http.request.uri.path, &amp;quot;/old-path/&amp;quot;))</code></p></li><li><p><b>Expression:</b> <code>concat(&amp;quot;/new-path/&amp;quot;, substring(http.request.uri.path, 10)) (where 10 is the length of /old-path/)</code></p></li></ul><p>This complexity created unnecessary overhead and difficulty, especially for users without access to regular expressions (regex) or the technical expertise to come up with expressions that use nested functions.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;wildcard-support-in-ruleset-engine\&quot;>Wildcard support in Ruleset Engine</h3>\n            <a href=\&quot;#wildcard-support-in-ruleset-engine\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>With the introduction of wildcard support across our Ruleset Engine-based products, users can now take advantage of the power and flexibility of the Ruleset Engine through simpler and more intuitive configurations. This enhancement ensures high performance while making it easier to create dynamic and flexible URL patterns and beyond.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;whats-new\&quot;>What’s new?</h3>\n            <a href=\&quot;#whats-new\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <h4>1) Operators &amp;quot;wildcard&amp;quot; and &amp;quot;strict wildcard&amp;quot; in Ruleset Engine:</h4><ul><li><p>&amp;quot;<b>wildcard</b>&amp;quot; (case insensitive): Matches patterns regardless of case (e.g., &amp;quot;test&amp;quot; and &amp;quot;TesT&amp;quot; are treated the same, similar to <a href=\&quot;https://developers.cloudflare.com/rules/page-rules/reference/wildcard-matching/\&quot;><u>Page Rules</u></a>).</p></li><li><p>&amp;quot;<b>strict wildcard</b>&amp;quot; (case sensitive): Matches patterns exactly, respecting case differences (e.g., &amp;quot;test&amp;quot; won&amp;#39;t match &amp;quot;TesT&amp;quot;).</p></li></ul><p>Both operators <a href=\&quot;https://developers.cloudflare.com/ruleset-engine/rules-language/operators/#wildcard-matching\&quot;><u>can be applied</u></a> to any string field available in the Ruleset Engine, including full URI, host, headers, cookies, user-agent, country, and more.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/46A6KAfGTCGykWIGiSLItF/c2b0743622244de48369da29fc7c4093/2478-2.png\&quot; alt=\&quot;2478-2\&quot; class=\&quot;kg-image\&quot; width=\&quot;1068\&quot; height=\&quot;632\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p><p>This example demonstrates the use of the &amp;quot;wildcard&amp;quot; operator in a <a href=\&quot;https://developers.cloudflare.com/waf/\&quot;><u>Web Application Firewall (WAF)</u></a> rule applied to the User Agent field. This rule matches any incoming request where the User Agent string contains patterns starting with &amp;quot;Mozilla/&amp;quot; and includes specific elements like &amp;quot;Macintosh; Intel Mac OS &amp;quot;, &amp;quot;Gecko/&amp;quot;, and &amp;quot;Firefox/&amp;quot;. Importantly, the wildcard operator is case insensitive, so it captures variations like &amp;quot;mozilla&amp;quot; and &amp;quot;Mozilla&amp;quot; without requiring exact matches.</p><h4>2) Function <code>wildcard_replace()</code> in Single Redirects:</h4><p>In <a href=\&quot;https://developers.cloudflare.com/rules/url-forwarding/single-redirects/\&quot;><u>Single Redirects</u></a>, the <code>wildcard_replace()</code> <a href=\&quot;https://developers.cloudflare.com/ruleset-engine/rules-language/functions/#wildcard_replace\&quot;><u>function</u></a> allows you to use matched segments in redirect URL targets.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5s2Y9zPgK4AqzD24DNSGU1/e8c456882160ad62b339888d05545f0d/2478-3.png\&quot; alt=\&quot;2478-3\&quot; class=\&quot;kg-image\&quot; width=\&quot;1176\&quot; height=\&quot;726\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p><p>Consider the URL pattern <code>https://example.com/*/t*st</code> mentioned earlier. Using <code>wildcard_replace()</code>, you can now set the target URL to <code>https://${1}.example.com/t${2}st</code> and dynamically redirect URLs like <code>https://example.com/uk/test</code> to <code>https://uk.example.com/test</code> and <code>https://example.com/images/toast</code> to <code>https://images.example.com/toast</code>.</p><h4>3) Simplified UI in Single Redirects:</h4><p>We understand that not everyone wants to use advanced Ruleset Engine <a href=\&quot;https://developers.cloudflare.com/ruleset-engine/rules-language/functions/\&quot;><u>functions</u></a>, especially for simple URL patterns. That’s why we’ve introduced an easy and intuitive UI for <a href=\&quot;https://developers.cloudflare.com/rules/url-forwarding/single-redirects/\&quot;><u>Single Redirects</u></a> called “wildcard pattern”. This new interface, available under the Rules &amp;gt; Redirect Rules tab of the zone dashboard, lets you specify request and target URL wildcard patterns in seconds without needing to delve into complex functions, much like Page Rules.</p>\n          <figure class=\&quot;kg-card kg-image-card\&quot;>\n          <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1y72vKTVFZjDUglnTpC2Nl/3da615997c9e245858356e79dfbbd3ec/2478-4.png\&quot; alt=\&quot;2478-4\&quot; class=\&quot;kg-image\&quot; width=\&quot;1060\&quot; height=\&quot;932\&quot; loading=\&quot;lazy\&quot;/>\n          </figure><p></p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;how-we-built-it\&quot;>How we built it</h3>\n            <a href=\&quot;#how-we-built-it\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>The Ruleset Engine powering Cloudflare Rules products is written in <a href=\&quot;https://www.rust-lang.org/\&quot;><u>Rust</u></a>. When adding wildcard support, we first explored existing <a href=\&quot;https://doc.rust-lang.org/book/ch07-01-packages-and-crates.html\&quot;><u>Rust crates</u></a> for wildcard matching.</p><p>We considered using the popular <a href=\&quot;https://crates.io/crates/regex\&quot;><code><u>regex</u></code></a> crate, known for its robustness. However, it requires converting wildcard patterns into regular expressions (e.g., <code>*</code> to <code>.*</code>, and <code>?</code> to <code>.</code>) and escaping other characters that are special in regex patterns, which adds complexity.</p><p>We also looked at the <a href=\&quot;https://crates.io/crates/wildmatch\&quot;><code><u>wildmatch</u></code></a> crate, which is designed specifically for wildcard matching and has a couple of advantages over <code>regex</code>. The most obvious one is that there is no need to convert wildcard patterns to regular expressions. More importantly, wildmatch can handle complex patterns efficiently: wildcard matching takes quadratic time – in the worst case the time is proportional to the length of the pattern multiplied by the length of the input string. To be more specific, the time complexity is <i>O(p + ℓ + s ⋅ ℓ)</i>, where <i>p</i> is the length of the wildcard pattern, <i>ℓ</i> the length of the input string, and <i>s</i> the number of asterisk metacharacters in the pattern. (If you are not familiar with <a href=\&quot;https://www.khanacademy.org/computing/computer-science/algorithms/asymptotic-notation/a/big-o-notation\&quot;><u>big O notation</u></a>, it is a way to express how an algorithm consumes a resource, in this case time, as the input size changes.) In the Ruleset Engine, we limit the number of asterisk metacharacters in the pattern to a maximum of 8. This ensures we will have good performance and limits the impact of a bad actor trying to consume too much CPU time by targeting extremely complicated patterns and input strings.</p><p>Unfortunately, <code>wildmatch</code> did not meet all our requirements. Ruleset Engine uses byte-oriented matching, and <code>wildmatch</code> works only on UTF-8 strings. We also have to support escape sequences –&nbsp; for example, you should be able to represent a literal * in the pattern with <code>\\*</code>.</p><p>Last but not least, to implement the <a href=\&quot;https://developers.cloudflare.com/ruleset-engine/rules-language/functions/#wildcard_replace\&quot;><code><u>wildcard_replace() function</u></code></a> we needed not only to be able to match, but also to be able to replace parts of strings with captured segments. This is necessary to dynamically create HTTP redirects based on the source URL. For example, to redirect a request from <code>https://example.com/*/page/*</code> to <code>https://example.com/products/${1}?page=${2}</code>, you should be able to define the target URL using an expression like this:</p>\n            <pre class=\&quot;language-undefined\&quot;><code class=\&quot;language-undefined\&quot;>wildcard_replace(\nhttp.request.full_uri, \n&amp;amp;quot;https://example.com/*/page/*&amp;amp;quot;, \n&amp;amp;quot;https://example.com/products/${1}?page=${2}&amp;amp;quot;\n)</pre></code>\n            <p></p><p>This means that in order to implement this function in the Ruleset Engine, we also need our wildcard matching implementation to capture the input substrings that match the wildcard’s metacharacters.</p><p>Given these requirements, we decided to build our own wildcard matching crate. The implementation is based on <a href=\&quot;http://dodobyte.com/wildcard.html\&quot;><u>Kurt&amp;#39;s 2016 iterative algorithm</u></a>, with optimizations from <a href=\&quot;http://developforperformance.com/MatchingWildcards_AnImprovedAlgorithmForBigData.html\&quot;><u>Krauss’ 2014 algorithm</u></a>. (You can find more information about the algorithm <a href=\&quot;https://github.com/cloudflare/wildcard/blob/v0.2.0/src/lib.rs#L555-L569\&quot;><u>here</u></a>). Our implementation supports byte-oriented matching, escape sequences, and capturing matched segments for further processing.</p><p>Cloudflare’s <a href=\&quot;https://crates.io/crates/wildcard\&quot;><code><u>wildcard crate</u></code></a> is now available and is open-source. You can find the source repository <a href=\&quot;https://github.com/cloudflare/wildcard\&quot;><u>here</u></a>. Contributions are welcome!</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;faqs-and-resources\&quot;>FAQs and resources</h3>\n            <a href=\&quot;#faqs-and-resources\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>For more details on using wildcards in Rules products, please refer to our updated Ruleset Engine documentation:</p><ul><li><p><a href=\&quot;https://developers.cloudflare.com/ruleset-engine/rules-language/operators/#wildcard-matching\&quot;><u>Ruleset Engine Operators</u></a></p></li><li><p><a href=\&quot;https://developers.cloudflare.com/ruleset-engine/rules-language/functions/#wildcard_replace\&quot;><u>Ruleset Engine Functions</u></a></p></li></ul><p>We value your feedback and invite you to share your thoughts in our <a href=\&quot;https://community.cloudflare.com/t/wildcard-support-in-ruleset-engine-products/692658\&quot;><u>community forums</u></a>. Your input directly influences our product and design decisions, helping us make Rules products even better.</p><p>Additionally, check out our <a href=\&quot;https://crates.io/crates/wildcard\&quot;><code><u>wildcard crate</u></code></a> implementation and <a href=\&quot;https://github.com/cloudflare/wildcard\&quot;><u>contribute to its development</u></a>.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;conclusion\&quot;>Conclusion</h3>\n            <a href=\&quot;#conclusion\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>The new wildcard functionality in Rules is available to all plans and is completely free. This feature is rolling out immediately, and no beta access registration required.&nbsp;</p><p>We are thrilled to offer this much-requested feature and look forward to seeing how you leverage wildcards in your Rules configurations. Try it now and experience the enhanced flexibility and performance. Your feedback is invaluable to us, so please let us know in <a href=\&quot;https://community.cloudflare.com/t/wildcard-support-in-ruleset-engine-products/692658\&quot;><u>community</u></a> how this new feature works for you!</p>&quot;],&quot;published_at&quot;:[0,&quot;2024-08-22T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-09T23:05:24.311Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5SVubtrh9iaqDDQSnA60Me/b511db040441d802b147cb838448ab26/2478-1-hero.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;3aRZvV7ApVpkYKGhnNQH4w&quot;],&quot;name&quot;:[0,&quot;CDN&quot;],&quot;slug&quot;:[0,&quot;cdn&quot;]}],[0,{&quot;id&quot;:[0,&quot;4Hr4XSACbfTmrYAA7iESxH&quot;],&quot;name&quot;:[0,&quot;Edge Rules&quot;],&quot;slug&quot;:[0,&quot;edge-rules&quot;]}],[0,{&quot;id&quot;:[0,&quot;3txfsA7N73yBL9g3VPBLL0&quot;],&quot;name&quot;:[0,&quot;Open Source&quot;],&quot;slug&quot;:[0,&quot;open-source&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}],[0,{&quot;id&quot;:[0,&quot;4HIPcb68qM0e26fIxyfzwQ&quot;],&quot;name&quot;:[0,&quot;Developers&quot;],&quot;slug&quot;:[0,&quot;developers&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Nikita Cano&quot;],&quot;slug&quot;:[0,&quot;nikita&quot;],&quot;bio&quot;:[0,&quot;Product Manager, Rules and Insights (Configuration Rules, Compression Rules, Page Rules, Redirect Rules, Origin Rules, Snippets, Trace, Traffic Sequence, Transform Rules, URL Normalization, etc.)&quot;],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6hGB1W3bIJaibV4F7Qe0L8/56f554eeae28828297135a54eacc3065/nikita.jpeg&quot;],&quot;location&quot;:[0,&quot;London, United Kingdom&quot;],&quot;website&quot;:[0,&quot;https://nikitacano.com&quot;],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}],[0,{&quot;name&quot;:[0,&quot;Diogo Sousa&quot;],&quot;slug&quot;:[0,&quot;diogo-sousa&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/CIkwYPr6o1fayekQOuYTk/cb2a91fdf53d4a3c68bb53723537e524/_tmp_mini_magick20230901-2-16mh0ld.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;We’re excited to announce wildcard support across our Ruleset Engine-based products and our open-source wildcard crate in Rust. Configuring rules has never been easier, with powerful pattern matching enabling simple and flexible URL redirects and beyond for users on all plans.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/wildcard-rules&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0],&quot;description&quot;:[0],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3jJGB4rvNAUowp0jvP3jIM/28bc0aa9543ce35a135e879a1fca0c9d/2478-OG.png&quot;]}]}],[0,{&quot;id&quot;:[0,&quot;6y0Im81Uj2lKntznfYHfUY&quot;],&quot;title&quot;:[0,&quot;Making WAF ML models go brrr: saving decades of processing time&quot;],&quot;slug&quot;:[0,&quot;making-waf-ai-models-go-brr&quot;],&quot;excerpt&quot;:[0,&quot;In this post, we discuss the performance optimizations we've implemented for our WAF ML product. We'll guide you through specific code examples and benchmark numbers, and we'll share the impressive latency reduction numbers observed after the rollout&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/qzexTuQeCIbe7wdbb9oyI/364aa6e688c079d0666998777c92eb4a/image1-22.png\&quot; alt=\&quot;Making WAF ML models go brrr: saving decades of processing time\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;901\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>We made our WAF Machine Learning models <b>5.5x</b> faster, reducing execution time by approximately <b>82%</b>, from <b>1519</b> to <b>275</b> microseconds! Read on to find out how we achieved this remarkable improvement.</p><p><a href=\&quot;https://developers.cloudflare.com/waf/about/waf-attack-score/\&quot;>WAF Attack Score</a> is Cloudflare&amp;#39;s machine learning (ML)-powered layer built on top of our <a href=\&quot;https://developers.cloudflare.com/waf/\&quot;>Web Application Firewall (WAF)</a>. Its goal is to complement the WAF and detect attack bypasses that we haven&amp;#39;t encountered before. This has proven invaluable in <a href=\&quot;/detecting-zero-days-before-zero-day\&quot;>catching zero-day vulnerabilities</a>, like the one detected in <a href=\&quot;/how-cloudflares-ai-waf-proactively-detected-ivanti-connect-secure-critical-zero-day-vulnerability\&quot;>Ivanti Connect Secure</a>, before they are publicly disclosed and enhancing our customers&amp;#39; protection against emerging and unknown threats.</p><p>Since its <a href=\&quot;/waf-ml\&quot;>launch in 2022</a>, WAF attack score adoption has grown exponentially, now protecting millions of Internet properties and running real-time inference on tens of millions of requests per second. The feature&amp;#39;s popularity has driven us to seek performance improvements, enabling even broader customer use and enhancing Internet security.</p><p>In this post, we will discuss the performance optimizations we&amp;#39;ve implemented for our WAF ML product. We&amp;#39;ll guide you through specific code examples and benchmark numbers, demonstrating how these enhancements have significantly improved our system&amp;#39;s efficiency. Additionally, we&amp;#39;ll share the impressive latency reduction numbers observed after the rollout.</p><p>Before diving into the optimizations, let&amp;#39;s take a moment to review the inner workings of the WAF Attack Score, which powers our WAF ML product.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;waf-attack-score-system-design\&quot;>WAF Attack Score system design</h2>\n            <a href=\&quot;#waf-attack-score-system-design\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          \n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3Bis9LE38A3aK4k7HEn7k9/44ae7b31096471a5256961715f8c7991/unnamed--4--6.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;343\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Cloudflare&amp;#39;s WAF attack score identifies various traffic types and attack vectors (<a href=\&quot;https://www.cloudflare.com/learning/security/threats/how-to-prevent-sql-injection/\&quot;>SQLi</a>, <a href=\&quot;https://www.cloudflare.com/learning/security/how-to-prevent-xss-attacks/\&quot;>XSS</a>, Command Injection, etc.) based on structural or statistical content properties. Here&amp;#39;s how it works during inference:</p><ol><li><p><b>HTTP Request Content</b>: Start with raw HTTP input.</p></li><li><p><b>Normalization &amp;amp; Transformation</b>: Standardize and clean the data, applying normalization, content substitutions, and de-duplication.</p></li><li><p><b>Feature Extraction</b>: Tokenize the transformed content to generate statistical and structural data.</p></li><li><p><b>Machine Learning Model Inference</b>: Analyze the extracted features with pre-trained models, mapping content representations to classes (e.g., XSS, SQLi or <a href=\&quot;https://www.cloudflare.com/learning/security/what-is-remote-code-execution/\&quot;>RCE</a>) or scores.</p></li><li><p><b>Classification Output in WAF</b>: Assign a score to the input, ranging from 1 (likely malicious) to 99 (likely clean), guiding security actions.</p></li></ol>\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/ZzHRYXU27VYB5F3F3QjXf/9e5248610a1e89ac8c73a446925abb69/cfce15fb-ce84-4489-a05a-6872b9e502b8.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;991\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Next, we will explore feature extraction and inference optimizations.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;feature-extraction-optimizations\&quot;>Feature extraction optimizations</h2>\n            <a href=\&quot;#feature-extraction-optimizations\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>In the context of the WAF Attack Score ML model, feature extraction or pre-processing is essentially a process of tokenizing the given input and producing a float tensor of 1 x m size:</p>\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7DIxHJ5zLkdeknndiNGbk0/e802888a2212ddfcae688f1c4201587f/8cc41311-3a09-4c39-b47c-9dc449760ee2.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1271\&quot; height=\&quot;805\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>In our initial pre-processing implementation, this is achieved via a sliding window of 3 bytes over the input with the help of Rust’s <a href=\&quot;https://doc.rust-lang.org/std/collections/struct.HashMap.html\&quot;>std::collections::HashMap</a> to look up the tensor index for a given ngram.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;initial-benchmarks\&quot;>Initial benchmarks</h3>\n            <a href=\&quot;#initial-benchmarks\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>To establish performance baselines, we&amp;#39;ve set up four benchmark cases representing example inputs of various lengths, ranging from 44 to 9482 bytes. Each case exemplifies typical input sizes, including those for a request body, user agent, and URI. We run benchmarks using the <a href=\&quot;https://bheisler.github.io/criterion.rs/book/getting_started.html\&quot;>Criterion.rs</a> statistics-driven micro-benchmarking tool:</p>\n            <pre class=\&quot;language-rust\&quot;><code class=\&quot;language-rust\&quot;>RUSTFLAGS=&amp;quot;-C opt-level=3 -C target-cpu=native&amp;quot; cargo criterion</pre></code>\n            <p>Here are initial numbers for these benchmarks executed on a Linux laptop with a 13th Gen Intel® Core™ i7-13800H processor:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Pre-processing time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Throughput, MiB/s</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/long-body-9482</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>248.46</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>36.40</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>28.19</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>33.83</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-url-44</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.45</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>28.94</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-ua-91</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>2.87</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>30.24</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>An important observation from these results is that pre-processing time correlates with the length of the input string, with throughput ranging from 28 MiB/s to 36 MiB/s. This suggests that considerable time is spent iterating over longer input strings. Optimizing this part of the process could significantly enhance performance. The dependency of processing time on input size highlights a key area for performance optimization. To validate this, we should examine where the processing time is spent by analyzing flamegraphs created from a 100-second profiling session visualized using <a href=\&quot;https://www.honeycomb.io/blog/golang-observability-using-the-new-pprof-web-ui-to-debug-memory-usage\&quot;>pprof</a>:</p>\n            <pre class=\&quot;language-rust\&quot;><code class=\&quot;language-rust\&quot;>RUSTFLAGS=&amp;quot;-C opt-level=3 -C target-cpu=native&amp;quot; cargo criterion -- --profile-time 100\n \ngo tool pprof -http=: target/criterion/profile/preprocessing/avg-body-1000/profile.pb</pre></code>\n            \n            <figure class=\&quot;kg-card kg-image-card kg-width-wide\&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/WGhFT3j6vn4QGFOmdyNGO/8dd1c6e4d171cd2c407af7bf4d9a9ac7/unnamed--5--6.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;729\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Looking at the pre-processing flamegraph above, it&amp;#39;s clear that most of the time was spent on the following two operations:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-ekg0{background-color:#EFEFEF;font-weight:bold;text-align:left;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Function name</span></th>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>% Time spent</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>std::collections::hash::map::HashMap&amp;lt;K,V,S&amp;gt;::get</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>61.8%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>regex::regex::bytes::Regex::replace_all</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>18.5%</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>Let&amp;#39;s tackle the HashMap lookups first. Lookups are happening inside the <i>tensor_populate_ngrams</i> function, where input is split into windows of 3 bytes representing ngram and then lookup inside two hash maps:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>fn tensor_populate_ngrams(tensor: &amp;amp;mut [f32], input: &amp;amp;[u8]) {   \n   // Populate the NORM ngrams\n   let mut unknown_norm_ngrams = 0;\n   let norm_offset = 1;\n \n   for s in input.windows(3) {\n       match NORM_VOCAB.get(s) {\n           Some(pos) =&amp;gt; {\n               tensor[*pos as usize + norm_offset] += 1.0f32;\n           }\n           None =&amp;gt; {\n               unknown_norm_ngrams += 1;\n           }\n       };\n   }\n \n   // Populate the SIG ngrams\n   let mut unknown_sig_ngrams = 0;\n   let sig_offset = norm_offset + NORM_VOCAB.len();\n \n   let res = SIG_REGEX.replace_all(&amp;amp;input, b&amp;quot;#&amp;quot;);\n \n   for s in res.windows(3) {\n       match SIG_VOCAB.get(s) {\n           Some(pos) =&amp;gt; {\n               // adding +1 here as the first position will be the unknown_sig_ngrams\n               tensor[*pos as usize + sig_offset + 1] += 1.0f32;\n           }\n           None =&amp;gt; {\n               unknown_sig_ngrams += 1;\n           }\n       }\n   }\n}</pre></code>\n            <p>So essentially the pre-processing function performs a ton of hash map lookups, the volume of which depends on the size of the input string, e.g. 1469 lookups for the given benchmark case <i>avg-body-1000</i>.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;optimization-attempt-1-hashmap-aho-corasick\&quot;>Optimization attempt #1: HashMap → Aho-Corasick</h3>\n            <a href=\&quot;#optimization-attempt-1-hashmap-aho-corasick\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>Rust hash maps are generally quite fast. However, when that many lookups are being performed, it&amp;#39;s not very cache friendly.</p><p>So can we do better than hash maps, and what should we try first? The answer is the <a href=\&quot;https://docs.rs/aho-corasick/latest/aho_corasick/\&quot;>Aho-Corasick library</a>.</p><p>This library provides multiple pattern search principally through an implementation of the <a href=\&quot;https://en.wikipedia.org/wiki/Aho%E2%80%93Corasick_algorithm\&quot;>Aho-Corasick algorithm</a>, which builds a fast finite state machine for executing searches in linear time.</p><p>We can also tune Aho-Corasick settings based on this recommendation:</p><blockquote><p><i>“You might want to use</i> <a href=\&quot;https://docs.rs/aho-corasick/1.1.3/aho_corasick/struct.AhoCorasickBuilder.html#method.kind\&quot;><i>AhoCorasickBuilder::kind</i></a> <i>to set your searcher to always use</i> <a href=\&quot;https://docs.rs/aho-corasick/1.1.3/aho_corasick/enum.AhoCorasickKind.html#variant.DFA\&quot;><i>AhoCorasickKind::DFA</i></a> <i>if search speed is critical and memory usage isn’t a concern.”</i></p></blockquote>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>static ref NORM_VOCAB_AC: AhoCorasick = AhoCorasick::builder().kind(Some(AhoCorasickKind::DFA)).build(&amp;amp;[    \n    &amp;quot;abc&amp;quot;,\n    &amp;quot;def&amp;quot;,\n    &amp;quot;wuq&amp;quot;,\n    &amp;quot;ijf&amp;quot;,\n    &amp;quot;iru&amp;quot;,\n    &amp;quot;piw&amp;quot;,\n    &amp;quot;mjw&amp;quot;,\n    &amp;quot;isn&amp;quot;,\n    &amp;quot;od &amp;quot;,\n    &amp;quot;pro&amp;quot;,\n    ...\n]).unwrap();</pre></code>\n            <p>Then we use the constructed AhoCorasick dictionary to lookup ngrams using its <a href=\&quot;https://docs.rs/aho-corasick/latest/aho_corasick/struct.AhoCorasick.html#method.find_overlapping_iter\&quot;>find_overlapping_iter</a> method:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>for mat in NORM_VOCAB_AC.find_overlapping_iter(&amp;amp;input) {\n    tensor_input_data[mat.pattern().as_usize() + 1] += 1.0;\n}</pre></code>\n            <p>We ran benchmarks and compared them against the baseline times shown above:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-gyuw{color:#38761D;font-weight:bold;text-align:right;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Baseline time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Aho-Corasick time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Optimization</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/long-body-9482</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>248.46</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>129.59</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-47.84% or 1.64x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>28.19</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>16.47</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-41.56% or 1.71x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-url-44</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.45</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.01</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-30.38% or 1.44x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-ua-91</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>2.87</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.90</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-33.60% or 1.51x</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>That&amp;#39;s substantially better – Aho-Corasick DFA does wonders.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;optimization-attempt-2-aho-corasick-match\&quot;>Optimization attempt #2: Aho-Corasick → match</h3>\n            <a href=\&quot;#optimization-attempt-2-aho-corasick-match\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>One would think optimization with Aho-Corasick DFA is enough and that it seems unlikely that anything else can beat it. Yet, we can throw Aho-Corasick away and simply use the Rust match statement and let the compiler do the optimization for us!</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>#[inline]\nconst fn norm_vocab_lookup(ngram: &amp;amp;[u8; 3]) -&amp;gt; usize {     \n    match ngram {\n        b&amp;quot;abc&amp;quot; =&amp;gt; 1,\n        b&amp;quot;def&amp;quot; =&amp;gt; 2,\n        b&amp;quot;wuq&amp;quot; =&amp;gt; 3,\n        b&amp;quot;ijf&amp;quot; =&amp;gt; 4,\n        b&amp;quot;iru&amp;quot; =&amp;gt; 5,\n        b&amp;quot;piw&amp;quot; =&amp;gt; 6,\n        b&amp;quot;mjw&amp;quot; =&amp;gt; 7,\n        b&amp;quot;isn&amp;quot; =&amp;gt; 8,\n        b&amp;quot;od &amp;quot; =&amp;gt; 9,\n        b&amp;quot;pro&amp;quot; =&amp;gt; 10,\n        ...\n        _ =&amp;gt; 0,\n    }\n}```</pre></code>\n            <p>Here&amp;#39;s how it performs in practice, based on the assembly generated by the <a href=\&quot;https://godbolt.org/z/dqTq5n5Y3\&quot;>Godbolt compiler explorer</a>. The corresponding assembly code efficiently implements this lookup by employing a jump table and byte-wise comparisons to determine the return value based on input sequences, optimizing for quick decisions and minimal branching. Although the example only includes ten ngrams, it&amp;#39;s important to note that in applications like our WAF Attack Score ML models, we deal with thousands of ngrams. This simple match-based approach outshines both HashMap lookups and the Aho-Corasick method.</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-gyuw{color:#38761D;font-weight:bold;text-align:right;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Baseline time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Match time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Optimization</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/long-body-9482</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>248.46</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>112.96</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-54.54% or 2.20x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>28.19</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>13.12</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-53.45% or 2.15x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-url-44</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.45</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>0.75</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-48.37% or 1.94x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-ua-91</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>2.87</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.4076</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-50.91% or 2.04x</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>Switching to match gave us another 7-18% drop in latency, depending on the case.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;optimization-attempt-3-regex-windowedreplacer\&quot;>Optimization attempt #3: Regex → WindowedReplacer</h3>\n            <a href=\&quot;#optimization-attempt-3-regex-windowedreplacer\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>So, what exactly is the purpose of <i>Regex::replace_all</i> in pre-processing? Regex is defined and used like this:</p>\n            <pre class=\&quot;language-regex\&quot;><code class=\&quot;language-regex\&quot;>pub static SIG_REGEX: Lazy&amp;lt;Regex&amp;gt; =\n    Lazy::new(|| RegexBuilder::new(&amp;quot;[a-z]+&amp;quot;).unicode(false).build().unwrap());\n    ... \n    let res = SIG_REGEX.replace_all(&amp;amp;input, b&amp;quot;#&amp;quot;);\n    for s in res.windows(3) {\n        tensor[sig_vocab_lookup(s.try_into().unwrap())] += 1.0;\n    }</pre></code>\n            <p>Essentially, all we need is to:</p><ol><li><p>Replace every sequence of lowercase letters in the input with a single byte &amp;quot;#&amp;quot;.</p></li><li><p>Iterate over replaced bytes in a windowed fashion with a step of 3 bytes representing an ngram.</p></li><li><p>Look up the ngram index and increment it in the tensor.</p></li></ol><p>This logic seems simple enough that we could implement it more efficiently with a single pass over the input and without any allocations:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>type Window = [u8; 3];\ntype Iter&amp;lt;&amp;#039;a&amp;gt; = Peekable&amp;lt;std::slice::Iter&amp;lt;&amp;#039;a, u8&amp;gt;&amp;gt;;\n\npub struct WindowedReplacer&amp;lt;&amp;#039;a&amp;gt; {\n    window: Window,\n    input_iter: Iter&amp;lt;&amp;#039;a&amp;gt;,\n}\n\n#[inline]\nfn is_replaceable(byte: u8) -&amp;gt; bool {\n    matches!(byte, b&amp;#039;a&amp;#039;..=b&amp;#039;z&amp;#039;)\n}\n\n#[inline]\nfn next_byte(iter: &amp;amp;mut Iter) -&amp;gt; Option&amp;lt;u8&amp;gt; {\n    let byte = iter.next().copied()?;\n    if is_replaceable(byte) {\n        while iter.next_if(|b| is_replaceable(**b)).is_some() {}\n        Some(b&amp;#039;#&amp;#039;)\n    } else {\n        Some(byte)\n    }\n}\n\nimpl&amp;lt;&amp;#039;a&amp;gt; WindowedReplacer&amp;lt;&amp;#039;a&amp;gt; {\n    pub fn new(input: &amp;amp;&amp;#039;a [u8]) -&amp;gt; Option&amp;lt;Self&amp;gt; {\n        let mut window: Window = Default::default();\n        let mut iter = input.iter().peekable();\n        for byte in window.iter_mut().skip(1) {\n            *byte = next_byte(&amp;amp;mut iter)?;\n        }\n        Some(WindowedReplacer {\n            window,\n            input_iter: iter,\n        })\n    }\n}\n\nimpl&amp;lt;&amp;#039;a&amp;gt; Iterator for WindowedReplacer&amp;lt;&amp;#039;a&amp;gt; {\n    type Item = Window;\n\n    #[inline]\n    fn next(&amp;amp;mut self) -&amp;gt; Option&amp;lt;Self::Item&amp;gt; {\n        for i in 0..2 {\n            self.window[i] = self.window[i + 1];\n        }\n        let byte = next_byte(&amp;amp;mut self.input_iter)?;\n        self.window[2] = byte;\n        Some(self.window)\n    }\n}</pre></code>\n            <p>By utilizing the <i>WindowedReplacer</i>, we simplify the replacement logic:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>if let Some(replacer) = WindowedReplacer::new(&amp;amp;input) {                \n    for ngram in replacer.windows(3) {\n        tensor[sig_vocab_lookup(ngram.try_into().unwrap())] += 1.0;\n    }\n}</pre></code>\n            <p>This new approach not only eliminates the need for allocating additional buffers to store replaced content, but also leverages Rust&amp;#39;s iterator optimizations, which the compiler can more effectively optimize. You can view an example of the assembly output for this new iterator at the provided <a href=\&quot;https://godbolt.org/z/fjaoP7z6Y\&quot;>Godbolt link</a>.</p><p>Now let&amp;#39;s benchmark this and compare against the original implementation:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-gyuw{color:#38761D;font-weight:bold;text-align:right;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Baseline time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Match time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Optimization</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/long-body-9482</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>248.46</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>51.00</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-79.47% or 4.87x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>28.19</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>5.53</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-80.36% or 5.09x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-url-44</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.45</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>0.40</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-72.11% or 3.59x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-ua-91</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>2.87</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>0.69</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-76.07% or 4.18x</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>The new letters replacement implementation has doubled the preprocessing speed compared to the previously optimized version using match statements, and it is four to five times faster than the original version!</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;optimization-attempt-4-going-nuclear-with-branchless-ngram-lookups\&quot;>Optimization attempt #4: Going nuclear with branchless ngram lookups</h3>\n            <a href=\&quot;#optimization-attempt-4-going-nuclear-with-branchless-ngram-lookups\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>At this point, 4-5x improvement might seem like a lot and there is no point pursuing any further optimizations. After all, using an ngram lookup with a match statement has beaten the following methods, with benchmarks omitted for brevity:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-ekg0{background-color:#EFEFEF;font-weight:bold;text-align:left;vertical-align:top}\n.tg .tg-zb5k{color:#15C;text-align:left;text-decoration:underline;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Lookup method</span></th>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Description</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-zb5k\&quot;><a href=\&quot;https://doc.rust-lang.org/std/collections/struct.HashMap.html\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>std::collections::HashMap</span></a></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Uses </span><a href=\&quot;https://github.com/rust-lang/hashbrown\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>Google’s SwissTable</span></a><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;> design with SIMD lookups to scan multiple hash entries in parallel. </span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-zb5k\&quot;><a href=\&quot;https://docs.rs/aho-corasick/latest/aho_corasick/#\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>Aho-Corasick</span></a><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;> matcher with and without </span><a href=\&quot;https://docs.rs/aho-corasick/latest/aho_corasick/dfa/struct.DFA.html\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>DFA</span></a></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Also utilizes SIMD instructions in some cases.</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-zb5k\&quot;><a href=\&quot;https://crates.io/crates/phf\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>phf crate</span></a><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;> </span></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>A library to generate efficient lookup tables at compile time using </span><a href=\&quot;https://en.wikipedia.org/wiki/Perfect_hash_function\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>perfect hash functions</span></a><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>.</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-zb5k\&quot;><a href=\&quot;https://crates.io/crates/ph\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>ph crate</span></a></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Another Rust library of data structures based on perfect hashing. </span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-zb5k\&quot;><a href=\&quot;https://crates.io/crates/quickphf\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>quickphf crate</span></a></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>A Rust crate that allows you to use static compile-time generated hash maps and hash sets using </span><a href=\&quot;https://arxiv.org/abs/2104.10402\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:underline;color:#15C;background-color:transparent\&quot;>PTHash perfect hash functions</span></a><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>.</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>However, if we look again at <a href=\&quot;https://godbolt.org/z/dqTq5n5Y3\&quot;>the assembly of the norm_vocab_lookup function</a>, it is clear that the execution flow has to perform a bunch of comparisons using <i>cmp</i> instructions. This creates many branches for the CPU to handle, which can lead to branch mispredictions. Branch mispredictions occur when the CPU incorrectly guesses the path of execution, causing delays as it discards partially completed instructions and fetches the correct ones. By reducing or eliminating these branches, we can avoid these mispredictions and improve the efficiency of the lookup process. How can we get rid of those branches when there is a need to look up thousands of unique ngrams?</p><p>Since there are only 3 bytes in each ngram, we can build two lookup tables of 256 x 256 x 256 size, storing the ngram tensor index. With this naive approach, our memory requirements will be: 256 x 256 x 256 x 2 x 2 = 64 MB, which seems like a lot.</p><p>However, given that we only care about ASCII bytes 0..127, then memory requirements can be lower: 128 x 128 x 128 x 2 x 2 = 8 MB, which is better. However, we will need to check for bytes &amp;gt;= 128, which will introduce a branch again.</p><p>So can we do better? Considering that the actual number of distinct byte values used in the ngrams is significantly less than the total possible 256 values, we can reduce memory requirements further by employing the following technique:</p><p>1. To avoid the branching caused by comparisons, we use precomputed offset lookup tables. This means instead of comparing each byte of the ngram during each lookup, we precompute the positions of each possible byte in a lookup table. This way, we replace the comparison operations with direct memory accesses, which are much faster and do not involve branching. We build an ngram bytes offsets lookup const array, storing each unique ngram byte offset position multiplied by the number of unique ngram bytes:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>const NGRAM_OFFSETS: [[u32; 256]; 3] = [\n    [\n        // offsets of first byte in ngram\n    ],\n    [\n        // offsets of second byte in ngram\n    ],\n    [\n        // offsets of third byte in ngram\n    ],\n];</pre></code>\n            <p>2. Then to obtain the ngram index, we can use this simple const function:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>#[inline]\nconst fn ngram_index(ngram: [u8; 3]) -&amp;gt; usize {\n    (NGRAM_OFFSETS[0][ngram[0] as usize]\n        + NGRAM_OFFSETS[1][ngram[1] as usize]\n        + NGRAM_OFFSETS[2][ngram[2] as usize]) as usize\n}</pre></code>\n            <p>3. To look up the tensor index based on the ngram index, we construct another const array at compile time using a list of all ngrams, where N is the number of unique ngram bytes:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>const NGRAM_TENSOR_IDX: [u16; N * N * N] = {\n    let mut arr = [0; N * N * N];\n    arr[ngram_index(*b&amp;quot;abc&amp;quot;)] = 1;\n    arr[ngram_index(*b&amp;quot;def&amp;quot;)] = 2;\n    arr[ngram_index(*b&amp;quot;wuq&amp;quot;)] = 3;\n    arr[ngram_index(*b&amp;quot;ijf&amp;quot;)] = 4;\n    arr[ngram_index(*b&amp;quot;iru&amp;quot;)] = 5;\n    arr[ngram_index(*b&amp;quot;piw&amp;quot;)] = 6;\n    arr[ngram_index(*b&amp;quot;mjw&amp;quot;)] = 7;\n    arr[ngram_index(*b&amp;quot;isn&amp;quot;)] = 8;\n    arr[ngram_index(*b&amp;quot;od &amp;quot;)] = 9;\n    ...\n    arr\n};</pre></code>\n            <p>4. Finally, to update the tensor based on given ngram, we lookup the ngram index, then the tensor index, and then increment it with help of <a href=\&quot;https://doc.rust-lang.org/std/primitive.slice.html#method.get_unchecked_mut\&quot;>get_unchecked_mut</a>, which avoids unnecessary (in this case) boundary checks and eliminates another source of branching:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>#[inline]\nfn update_tensor_with_ngram(tensor: &amp;amp;mut [f32], ngram: [u8; 3]) {\n    let ngram_idx = ngram_index(ngram);\n    debug_assert!(ngram_idx &amp;lt; NGRAM_TENSOR_IDX.len());\n    unsafe {\n        let tensor_idx = *NGRAM_TENSOR_IDX.get_unchecked(ngram_idx) as usize;\n        debug_assert!(tensor_idx &amp;lt; tensor.len());\n        *tensor.get_unchecked_mut(tensor_idx) += 1.0;\n    }\n}</pre></code>\n            <p>This logic works effectively, passes correctness tests, and most importantly, it&amp;#39;s completely branchless! Moreover, the memory footprint of used lookup arrays is tiny – just ~500 KiB of memory – which easily fits into modern CPU L2/L3 caches, ensuring that expensive cache misses are rare and performance is optimal.</p><p>The last trick we will employ is loop unrolling for ngrams processing. By taking 6 ngrams (corresponding to 8 bytes of the input array) at a time, the compiler can unroll the second loop and auto-vectorize it, leveraging parallel execution to improve performance:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>const CHUNK_SIZE: usize = 6;\n\nlet chunks_max_offset =\n    ((input.len().saturating_sub(2)) / CHUNK_SIZE) * CHUNK_SIZE;\nfor i in (0..chunks_max_offset).step_by(CHUNK_SIZE) {\n    for ngram in input[i..i + CHUNK_SIZE + 2].windows(3) {\n        update_tensor_with_ngram(tensor, ngram.try_into().unwrap());\n    }\n}</pre></code>\n            <p>Tying up everything together, our final pre-processing benchmarks show the following:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-gyuw{color:#38761D;font-weight:bold;text-align:right;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Baseline time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Branchless time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Optimization</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/long-body-9482</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>248.46</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>21.53</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-91.33% or 11.54x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>28.19</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>2.33</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-91.73% or 12.09x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-url-44</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>1.45</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>0.26</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-82.34% or 5.66x</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>preprocessing/avg-ua-91</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>2.87</span></td>\n    <td class=\&quot;tg-lqy6\&quot;>\t<span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>0.43</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-84.92% or 6.63x</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>The longer input is, the higher the latency drop will be due to branchless ngram lookups and loop unrolling, ranging from <b>six to twelve times faster</b> than baseline implementation.</p><p>After trying various optimizations, the final version of pre-processing retains optimization attempts 3 and 4, using branchless ngram lookup with offset tables and a single-pass non-allocating replacement iterator.</p><p>There are potentially more CPU cycles left on the table, and techniques like memory pre-fetching and manual SIMD intrinsics could speed this up a bit further. However, let&amp;#39;s now switch gears into looking at inference latency a bit closer.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;model-inference-optimizations\&quot;>Model inference optimizations</h2>\n            <a href=\&quot;#model-inference-optimizations\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          \n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;initial-benchmarks\&quot;>Initial benchmarks</h3>\n            <a href=\&quot;#initial-benchmarks\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>Let’s have a look at original performance numbers of the WAF Attack Score ML model, which uses <a href=\&quot;https://github.com/tensorflow/tensorflow/releases/tag/v2.6.0\&quot;>TensorFlow Lite 2.6.0</a>:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Inference time, μs</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>inference/long-body-9482</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>247.31</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>inference/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>246.31</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>inference/avg-url-44</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>246.40</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>inference/avg-ua-91</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>246.88</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>Model inference is actually independent of the original input length, as inputs are transformed into tensors of predetermined size during the pre-processing phase, which we optimized above. From now on, we will refer to a singular inference time when benchmarking our optimizations.</p><p>Digging deeper with profiler, we observed that most of the time is spent on the following operations:</p>\n            <figure class=\&quot;kg-card kg-image-card kg-width-wide\&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3uy64gatRk8PfdnpRz5Xm5/0d3da469c30e5941524289c1b13574c5/unnamed--6--6.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;137\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-ekg0{background-color:#EFEFEF;font-weight:bold;text-align:left;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Function name</span></th>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>% Time spent</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::tensor_utils::PortableMatrixBatchVectorMultiplyAccumulate</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>42.46%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::tensor_utils::PortableAsymmetricQuantizeFloats</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>30.59%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::optimized_ops::SoftmaxImpl</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>12.02%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::reference_ops::MaximumMinimumBroadcastSlow</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>5.35%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::ops::builtin::elementwise::LogEval</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>4.13%</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>The most expensive operation is matrix multiplication, which boils down to iteration within <a href=\&quot;https://github.com/tensorflow/tensorflow/blob/v2.6.0/tensorflow/lite/kernels/internal/reference/portable_tensor_utils.cc#L119-L136\&quot;>three nested loops</a>:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>void PortableMatrixBatchVectorMultiplyAccumulate(const float* matrix,\n                                                 int m_rows, int m_cols,\n                                                 const float* vector,\n                                                 int n_batch, float* result) {\n  float* result_in_batch = result;\n  for (int b = 0; b &amp;lt; n_batch; b++) {\n    const float* matrix_ptr = matrix;\n    for (int r = 0; r &amp;lt; m_rows; r++) {\n      float dot_prod = 0.0f;\n      const float* vector_in_batch = vector + b * m_cols;\n      for (int c = 0; c &amp;lt; m_cols; c++) {\n        dot_prod += *matrix_ptr++ * *vector_in_batch++;\n      }\n      *result_in_batch += dot_prod;\n     ++result_in_batch;\n    }\n  }\n}</pre></code>\n            <p>This doesn’t look very efficient and many <a href=\&quot;https://en.algorithmica.org/hpc/algorithms/matmul/\&quot;>blogs</a> and <a href=\&quot;https://www.cs.utexas.edu/~flame/pubs/GotoTOMS_revision.pdf\&quot;>research papers</a> have been written on how matrix multiplication can be optimized, which basically boils down to:</p><ul><li><p><b>Blocking</b>: Divide matrices into smaller blocks that fit into the cache, improving cache reuse and reducing memory access latency.</p></li><li><p><b>Vectorization</b>: Use SIMD instructions to process multiple data points in parallel, enhancing efficiency with vector registers.</p></li><li><p><b>Loop Unrolling</b>: Reduce loop control overhead and increase parallelism by executing multiple loop iterations simultaneously.</p></li></ul><p>To gain a better understanding of how these techniques work, we recommend watching this video, which brilliantly depicts the process of matrix multiplication:</p><!--kg-card-begin: html--><iframe width=\&quot;560\&quot; height=\&quot;315\&quot; src=\&quot;https://www.youtube.com/embed/aMvCEEBIBto?si=tbw1XsYwHFezUX98&amp;amp;controls=0\&quot; title=\&quot;YouTube video player\&quot; frameborder=\&quot;0\&quot; allow=\&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\&quot; referrerpolicy=\&quot;strict-origin-when-cross-origin\&quot; allowfullscreen></iframe>\n<p></p><!--kg-card-end: html-->\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;tensorflow-lite-with-avx2\&quot;>Tensorflow Lite with AVX2</h3>\n            <a href=\&quot;#tensorflow-lite-with-avx2\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>TensorFlow Lite does, in fact, support SIMD matrix multiplication – we just need to enable it and re-compile the TensorFlow Lite library:</p>\n            <pre class=\&quot;language-python\&quot;><code class=\&quot;language-python\&quot;>if [[ &amp;quot;$(uname -m)&amp;quot; == x86_64* ]]; then\n    # On x86_64 target x86-64-v3 CPU to enable AVX2 and FMA.\n    arguments+=(&amp;quot;--copt=-march=x86-64-v3&amp;quot;)\nfi</pre></code>\n            <p>After running profiler again using the SIMD-optimized TensorFlow Lite library:</p>\n            <figure class=\&quot;kg-card kg-image-card kg-width-wide\&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6NmJhJoYG42ZZhU41m0Uj5/1d9fce45d44f98b41375d6a56f1a7cac/unnamed--7--5.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;102\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Top operations as per profiler output:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-ekg0{background-color:#EFEFEF;font-weight:bold;text-align:left;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Function name</span></th>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>% Time spent</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::tensor_utils::SseMatrixBatchVectorMultiplyAccumulateImpl</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>43.01%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::tensor_utils::NeonAsymmetricQuantizeFloats</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>22.46%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::reference_ops::MaximumMinimumBroadcastSlow</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>7.82%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::optimized_ops::SoftmaxImpl</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>6.61%</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>tflite::ops::builtin::elementwise::LogEval</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>4.63%</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>Matrix multiplication now uses <a href=\&quot;https://github.com/tensorflow/tensorflow/blob/15ec568b5505727c940b651aeb2a9643b504086c/tensorflow/lite/kernels/internal/optimized/sse_tensor_utils.cc#L161-L199\&quot;>AVX2 instructions</a>, which uses blocks of 8x8 to multiply and accumulate the multiplication result.</p><p>Proportionally, matrix multiplication and quantization operations take a similar time share when compared to non-SIMD version, however in absolute numbers, it’s almost twice as fast when SIMD optimizations are enabled:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-gyuw{color:#38761D;font-weight:bold;text-align:right;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Baseline time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>SIMD time, μs</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Optimization</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>inference/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>246.31</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>130.07</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-47.19% or 1.89x</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>Quite a nice performance boost just from a few lines of build config change!</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h3 id=\&quot;tensorflow-lite-with-xnnpack\&quot;>Tensorflow Lite with XNNPACK</h3>\n            <a href=\&quot;#tensorflow-lite-with-xnnpack\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n        <p>Tensorflow Lite comes with a useful benchmarking tool called <a href=\&quot;https://github.com/tensorflow/tensorflow/tree/master/tensorflow/lite/tools/benchmark\&quot;>benchmark_model</a>, which also has a built-in profiler.</p><p>The tool can be built locally using the command:</p>\n            <pre class=\&quot;language-bash\&quot;><code class=\&quot;language-bash\&quot;>bazel build -j 4 --copt=-march=native -c opt tensorflow/lite/tools/benchmark:benchmark_model</pre></code>\n            <p>After building, benchmarks were run with different settings:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-ekg0{background-color:#EFEFEF;font-weight:bold;text-align:left;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark run</span></th>\n    <th class=\&quot;tg-ekg0\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Inference time, μs</span></th>\n  </tr></thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>benchmark_model --graph=model.tflite --num_runs=100000 --use_xnnpack=false</span></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>105.61</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>benchmark_model --graph=model.tflite --num_runs=100000 --use_xnnpack=true --xnnpack_force_fp16=true</span></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>111.95</span></td>\n  </tr>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>benchmark_model --graph=model.tflite --num_runs=100000 --use_xnnpack=true</span></td>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>49.05</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>Tensorflow Lite with XNNPACK enabled emerges as a leader, achieving ~50% latency reduction, when compared to the original Tensorflow Lite implementation.</p><p>More technical details about XNNPACK can be found in these blog posts:</p><ul><li><p><a href=\&quot;https://blog.tensorflow.org/2022/06/Profiling-XNNPACK-with-TFLite.html\&quot;>Profiling XNNPACK with TFLite</a></p></li><li><p><a href=\&quot;https://blog.tensorflow.org/2024/04/faster-dynamically-quantized-inference-with-xnnpack.html\&quot;>Faster Dynamically Quantized Inference with XNNPack</a></p></li></ul><p>Re-running benchmarks with XNNPack enabled, we get the following results:</p><!--kg-card-begin: html--><style type=\&quot;text/css\&quot;>\n.tg  {border-collapse:collapse;border-color:#ccc;border-spacing:0;}\n.tg td{background-color:#fff;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg th{background-color:#f0f0f0;border-color:#ccc;border-style:solid;border-width:1px;color:#333;\n  font-family:Arial, sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}\n.tg .tg-gyuw{color:#38761D;font-weight:bold;text-align:right;vertical-align:top}\n.tg .tg-lqy6{text-align:right;vertical-align:top}\n.tg .tg-kxn2{background-color:#EFEFEF;font-weight:bold;text-align:center;vertical-align:top}\n.tg .tg-0lax{text-align:left;vertical-align:top}\n</style>\n<table class=\&quot;tg\&quot; width=\&quot;100%\&quot;><thead>\n  <tr>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Benchmark case</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Baseline time, μs</span><br><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>TFLite 2.6.0</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>SIMD time, μs</span><br><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>TFLite 2.6.0</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>SIMD time, μs</span><br><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>TFLite 2.16.1</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>SIMD + XNNPack time, μs</span><br><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>TFLite 2.16.1</span></th>\n    <th class=\&quot;tg-kxn2\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>Optimization</span></th>\n  </tr>\n</thead>\n<tbody>\n  <tr>\n    <td class=\&quot;tg-0lax\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>inference/avg-body-1000</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>246.31</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>130.07</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>115.17</span></td>\n    <td class=\&quot;tg-lqy6\&quot;><span style=\&quot;font-weight:400;font-style:normal;text-decoration:none;color:#000;background-color:transparent\&quot;>56.22</span></td>\n    <td class=\&quot;tg-gyuw\&quot;><span style=\&quot;font-weight:700;font-style:normal;text-decoration:none;color:#38761D;background-color:transparent\&quot;>-77.17% or 4.38x</span></td>\n  </tr>\n</tbody></table><!--kg-card-end: html--><p>By upgrading TensorFlow Lite from 2.6.0 to 2.16.1 and enabling SIMD optimizations along with the XNNPack, we were able to decrease WAF ML model inference time more than <b>four-fold</b>, achieving a <b>77.17%</b> reduction.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;caching-inference-result\&quot;>Caching inference result</h2>\n            <a href=\&quot;#caching-inference-result\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>While making code faster through pre-processing and inference optimizations is great, it&amp;#39;s even better when code doesn&amp;#39;t need to run at all. This is where caching comes in. <a href=\&quot;https://en.wikipedia.org/wiki/Amdahl%27s_law\&quot;>Amdahl&amp;#39;s Law</a> suggests that optimizing only parts of a program has diminishing returns. By avoiding redundant executions with caching, we can achieve significant performance gains beyond the limitations of traditional code optimization.</p><p>A simple key-value cache would quickly occupy all available memory on the server due to the high cardinality of URLs, HTTP headers, and HTTP bodies. However, because &amp;quot;everything on the Internet has an L-shape&amp;quot; or more specifically, follows a <a href=\&quot;https://en.wikipedia.org/wiki/Zipf%27s_law\&quot;>Zipf&amp;#39;s law</a> distribution, we can optimize our caching strategy.</p><p><a href=\&quot;https://en.wikipedia.org/wiki/Zipf%27s_law\&quot;>Zipf</a>&amp;#39;<a href=\&quot;https://en.wikipedia.org/wiki/Zipf%27s_law\&quot;>s law</a> states that in many natural datasets, the frequency of any item is inversely proportional to its rank in the frequency table. In other words, a few items are extremely common, while the majority are rare. By analyzing our request data, we found that URLs, HTTP headers, and even HTTP bodies follow this distribution. For example, here is the user agent header frequency distribution against its rank:</p>\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/50OWcB7Buza1Jp77ePY75X/e25e66e7665fccc454df026e5ca37729/unnamed--8--3.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1277\&quot; height=\&quot;800\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>By caching the top-N most frequently occurring inputs and their corresponding inference results, we can ensure that both pre-processing and inference are skipped for the majority of requests. This is where the <a href=\&quot;https://en.wikipedia.org/wiki/Cache_replacement_policies#LRU\&quot;>Least Recently Used (LRU)</a> cache comes in – frequently used items stay hot in the cache, while the least recently used ones are evicted.</p><p>We use <a href=\&quot;https://github.com/openresty/lua-resty-lrucache\&quot;>lua-resty-mlcache</a> as our caching solution, allowing us to share cached inference results between different Nginx workers via a shared memory dictionary. The LRU cache effectively exploits the <a href=\&quot;https://en.wikipedia.org/wiki/Space%E2%80%93time_tradeoff\&quot;>space-time trade-off</a>, where we trade a small amount of memory for significant CPU time savings.</p><p>This approach enables us to achieve a <b>~70%</b> cache hit ratio, significantly reducing latency further, as we will analyze in the final section below.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;optimization-results\&quot;>Optimization results</h2>\n            <a href=\&quot;#optimization-results\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>The optimizations discussed in this post were rolled out in several phases to ensure system correctness and stability.</p><p>First, we enabled SIMD optimizations for TensorFlow Lite, which reduced WAF ML total execution time by approximately <b>41.80%,</b> decreasing from <b>1519</b> ➔ <b>884 μs</b> on average.</p>\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/15SMdamloYpjyUy5ZwH9o0/ab4ec787f870d27a45ff513db1f696c8/unnamed--9--3.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;470\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Next, we upgraded TensorFlow Lite from version 2.6.0 to 2.16.1, enabled XNNPack, and implemented pre-processing optimizations. This further reduced WAF ML total execution time by <b>~40.77%</b>, bringing it down from <b>932</b> ➔ <b>552 μs</b> on average. The initial average time of 932 μs was slightly higher than the previous 884 μs due to the increased number of customers using this feature and the months that passed between changes.</p>\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/01EuBB1eVopVjUjWsVvwrK/0d908285bd4296d75f5c98918cf1a561/unnamed--10--3.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;472\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Lastly, we introduced LRU caching, which led to an additional reduction in WAF ML total execution time by <b>~50.18%</b>, from <b>552</b> ➔ <b>275 μs</b> on average.</p>\n            <figure class=\&quot;kg-card kg-image-card \&quot;>\n            \n            <Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6epSwp5jz4ZMaVfdwahZnN/8c23c1b6a90bf301f9e7f6566d4f3295/unnamed--11--3.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1600\&quot; height=\&quot;482\&quot; loading=\&quot;lazy\&quot;/>\n            \n            </figure><p>Overall, we cut WAF ML execution time by <b>~81.90%</b>, decreasing from <b>1519</b> ➔ <b>275 μs</b>, or <b>5.5x</b> faster!</p><p>To illustrate the significance of this: with Cloudflare’s average rate of 9.5 million requests per second passing through WAF ML, saving <b>1244 microseconds</b> per request equates to saving ~<b>32 years</b> of processing time every single day! That’s in addition to the savings of <b>523 microseconds</b> per request or <b>65 years</b> of processing time per day demonstrated last year in our <a href=\&quot;/scalable-machine-learning-at-cloudflare\&quot;>Every request, every microsecond: scalable machine learning at Cloudflare</a> post about our Bot Management product.</p>\n          <div class=\&quot;flex anchor relative\&quot;>\n            <h2 id=\&quot;conclusion\&quot;>Conclusion</h2>\n            <a href=\&quot;#conclusion\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;>\n              <svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;><path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;></path></svg>\n            </a>\n          </div>\n          <p>We hope you enjoyed reading about how we made our WAF ML models go brrr, just as much as we enjoyed implementing these optimizations to bring scalable WAF ML to more customers on a truly global scale.</p><p>Looking ahead, we are developing even more sophisticated ML security models. These advancements aim to bring our <a href=\&quot;https://www.cloudflare.com/application-services/products/waf/\&quot;>WAF</a> and <a href=\&quot;https://www.cloudflare.com/application-services/products/bot-management/\&quot;>Bot Management</a> products to the next level, making them even more useful and effective for our customers.</p>&quot;],&quot;published_at&quot;:[0,&quot;2024-07-25T14:00:46.000+01:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-09T23:28:48.616Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7bMxXOoK4JfZ8vOSQMEEze/6771fb2a713d450e0cfbe9e72f8f18a9/making-waf-ai-models-go-brr.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;1HAYmR545ufVxM2rQzz0SE&quot;],&quot;name&quot;:[0,&quot;Machine Learning&quot;],&quot;slug&quot;:[0,&quot;machine-learning&quot;]}],[0,{&quot;id&quot;:[0,&quot;lGCLqAT2SMojMzw5b6aio&quot;],&quot;name&quot;:[0,&quot;WAF&quot;],&quot;slug&quot;:[0,&quot;waf&quot;]}],[0,{&quot;id&quot;:[0,&quot;4gN0ARax0fHxjtZL07THOe&quot;],&quot;name&quot;:[0,&quot;Performance&quot;],&quot;slug&quot;:[0,&quot;performance&quot;]}],[0,{&quot;id&quot;:[0,&quot;2kPXcZlQ7I9S1hKI5tRYxl&quot;],&quot;name&quot;:[0,&quot;Optimization&quot;],&quot;slug&quot;:[0,&quot;optimization&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}],[0,{&quot;id&quot;:[0,&quot;6h3TE7YtADO10hSjeJXH3l&quot;],&quot;name&quot;:[0,&quot;AI WAF&quot;],&quot;slug&quot;:[0,&quot;ai-waf&quot;]}],[0,{&quot;id&quot;:[0,&quot;5FlK9VPj1XH1161dsPRkec&quot;],&quot;name&quot;:[0,&quot;WAF Attack Score&quot;],&quot;slug&quot;:[0,&quot;waf-attack-score&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Alex Bocharov&quot;],&quot;slug&quot;:[0,&quot;alex-bocharov&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/24CoetZHxm1WOEU1EkIiqZ/88f2bb545544b066dcc3d2e4f09b5b46/alex-bocharov.jpg&quot;],&quot;location&quot;:[0,null],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}]]],&quot;meta_description&quot;:[0,&quot;In this post, we discuss the performance optimizations we've implemented for our WAF ML product. We'll guide you through specific code examples and benchmark numbers, and we'll share the impressive latency reduction numbers observed after the rollout.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;Making WAF ML models go brrr: saving decades of processing time Config&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/making-waf-ai-models-go-brr&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Making WAF ML models go brrr: saving decades of processing time&quot;],&quot;description&quot;:[0,&quot;In this post, we discuss the performance optimizations we've implemented for our WAF ML product. We'll guide you through specific code examples and benchmark numbers, and we'll share the impressive latency reduction numbers observed after the rollout.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5Ijau4iyJxDe09hKuKiscN/3d9634c2059a30baed6f71de91dff3b6/making-waf-ai-models-go-brr-ib407s.png&quot;]}]}]]],&quot;locale&quot;:[0,&quot;en-us&quot;],&quot;translations&quot;:[0,{&quot;posts.by&quot;:[0,&quot;By&quot;],&quot;footer.gdpr&quot;:[0,&quot;GDPR&quot;],&quot;lang_blurb1&quot;:[0,&quot;This post is also available in {lang1}.&quot;],&quot;lang_blurb2&quot;:[0,&quot;This post is also available in {lang1} and {lang2}.&quot;],&quot;lang_blurb3&quot;:[0,&quot;This post is also available in {lang1}, {lang2} and {lang3}.&quot;],&quot;footer.press&quot;:[0,&quot;Press&quot;],&quot;header.title&quot;:[0,&quot;The Cloudflare Blog&quot;],&quot;search.clear&quot;:[0,&quot;Clear&quot;],&quot;search.filter&quot;:[0,&quot;Filter&quot;],&quot;search.source&quot;:[0,&quot;Source&quot;],&quot;footer.careers&quot;:[0,&quot;Careers&quot;],&quot;footer.company&quot;:[0,&quot;Company&quot;],&quot;footer.support&quot;:[0,&quot;Support&quot;],&quot;footer.the_net&quot;:[0,&quot;theNet&quot;],&quot;search.filters&quot;:[0,&quot;Filters&quot;],&quot;footer.our_team&quot;:[0,&quot;Our team&quot;],&quot;footer.webinars&quot;:[0,&quot;Webinars&quot;],&quot;page.more_posts&quot;:[0,&quot;More posts&quot;],&quot;posts.time_read&quot;:[0,&quot;{time} min read&quot;],&quot;search.language&quot;:[0,&quot;Language&quot;],&quot;footer.community&quot;:[0,&quot;Community&quot;],&quot;footer.resources&quot;:[0,&quot;Resources&quot;],&quot;footer.solutions&quot;:[0,&quot;Solutions&quot;],&quot;footer.trademark&quot;:[0,&quot;Trademark&quot;],&quot;header.subscribe&quot;:[0,&quot;Subscribe&quot;],&quot;footer.compliance&quot;:[0,&quot;Compliance&quot;],&quot;footer.free_plans&quot;:[0,&quot;Free plans&quot;],&quot;footer.impact_ESG&quot;:[0,&quot;Impact/ESG&quot;],&quot;posts.follow_on_X&quot;:[0,&quot;Follow on X&quot;],&quot;footer.help_center&quot;:[0,&quot;Help center&quot;],&quot;footer.network_map&quot;:[0,&quot;Network Map&quot;],&quot;header.please_wait&quot;:[0,&quot;Please Wait&quot;],&quot;page.related_posts&quot;:[0,&quot;Related posts&quot;],&quot;search.result_stat&quot;:[0,&quot;Results <strong>{search_range}</strong> of <strong>{search_total}</strong> for <strong>{search_keyword}</strong>&quot;],&quot;footer.case_studies&quot;:[0,&quot;Case Studies&quot;],&quot;footer.connect_2024&quot;:[0,&quot;Connect 2024&quot;],&quot;footer.terms_of_use&quot;:[0,&quot;Terms of Use&quot;],&quot;footer.white_papers&quot;:[0,&quot;White Papers&quot;],&quot;footer.cloudflare_tv&quot;:[0,&quot;Cloudflare TV&quot;],&quot;footer.community_hub&quot;:[0,&quot;Community Hub&quot;],&quot;footer.compare_plans&quot;:[0,&quot;Compare plans&quot;],&quot;footer.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.email_address&quot;:[0,&quot;Email Address&quot;],&quot;page.error.not_found&quot;:[0,&quot;Page not found&quot;],&quot;footer.developer_docs&quot;:[0,&quot;Developer docs&quot;],&quot;footer.privacy_policy&quot;:[0,&quot;Privacy Policy&quot;],&quot;footer.request_a_demo&quot;:[0,&quot;Request a demo&quot;],&quot;page.continue_reading&quot;:[0,&quot;Continue reading&quot;],&quot;footer.analysts_report&quot;:[0,&quot;Analyst reports&quot;],&quot;footer.for_enterprises&quot;:[0,&quot;For enterprises&quot;],&quot;footer.getting_started&quot;:[0,&quot;Getting Started&quot;],&quot;footer.learning_center&quot;:[0,&quot;Learning Center&quot;],&quot;footer.project_galileo&quot;:[0,&quot;Project Galileo&quot;],&quot;pagination.newer_posts&quot;:[0,&quot;Newer Posts&quot;],&quot;pagination.older_posts&quot;:[0,&quot;Older Posts&quot;],&quot;posts.social_buttons.x&quot;:[0,&quot;Discuss on X&quot;],&quot;search.source_location&quot;:[0,&quot;Source/Location&quot;],&quot;footer.about_cloudflare&quot;:[0,&quot;About Cloudflare&quot;],&quot;footer.athenian_project&quot;:[0,&quot;Athenian Project&quot;],&quot;footer.become_a_partner&quot;:[0,&quot;Become a partner&quot;],&quot;footer.cloudflare_radar&quot;:[0,&quot;Cloudflare Radar&quot;],&quot;footer.network_services&quot;:[0,&quot;Network services&quot;],&quot;footer.trust_and_safety&quot;:[0,&quot;Trust &amp; Safety&quot;],&quot;header.get_started_free&quot;:[0,&quot;Get Started Free&quot;],&quot;page.search.placeholder&quot;:[0,&quot;Search Cloudflare&quot;],&quot;footer.cloudflare_status&quot;:[0,&quot;Cloudflare Status&quot;],&quot;footer.cookie_preference&quot;:[0,&quot;Cookie Preferences&quot;],&quot;header.valid_email_error&quot;:[0,&quot;Must be valid email.&quot;],&quot;footer.connectivity_cloud&quot;:[0,&quot;Connectivity cloud&quot;],&quot;footer.developer_services&quot;:[0,&quot;Developer services&quot;],&quot;footer.investor_relations&quot;:[0,&quot;Investor relations&quot;],&quot;page.not_found.error_code&quot;:[0,&quot;Error Code: 404&quot;],&quot;footer.logos_and_press_kit&quot;:[0,&quot;Logos &amp; press kit&quot;],&quot;footer.application_services&quot;:[0,&quot;Application services&quot;],&quot;footer.get_a_recommendation&quot;:[0,&quot;Get a recommendation&quot;],&quot;posts.social_buttons.reddit&quot;:[0,&quot;Discuss on Reddit&quot;],&quot;footer.sse_and_sase_services&quot;:[0,&quot;SSE and SASE services&quot;],&quot;page.not_found.outdated_link&quot;:[0,&quot;You may have used an outdated link, or you may have typed the address incorrectly.&quot;],&quot;footer.report_security_issues&quot;:[0,&quot;Report Security Issues&quot;],&quot;page.error.error_message_page&quot;:[0,&quot;Sorry, we can't find the page you are looking for.&quot;],&quot;header.subscribe_notifications&quot;:[0,&quot;Subscribe to receive notifications of new posts:&quot;],&quot;footer.cloudflare_for_campaigns&quot;:[0,&quot;Cloudflare for Campaigns&quot;],&quot;header.subscription_confimation&quot;:[0,&quot;Subscription confirmed. Thank you for subscribing!&quot;],&quot;posts.social_buttons.hackernews&quot;:[0,&quot;Discuss on Hacker News&quot;],&quot;footer.diversity_equity_inclusion&quot;:[0,&quot;Diversity, equity &amp; inclusion&quot;],&quot;footer.critical_infrastructure_defense_project&quot;:[0,&quot;Critical Infrastructure Defense Project&quot;]}],&quot;localesAvailable&quot;:[1,[]],&quot;footerBlurb&quot;:[0,&quot;Cloudflare's connectivity cloud protects <a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'>entire corporate networks</a>, helps customers build <a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'>Internet-scale applications efficiently</a>, accelerates any <a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'>website or Internet application</a>, <a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'>wards off DDoS attacks</a>, keeps <a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'>hackers at bay</a>, and can help you on <a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'>your journey to Zero Trust</a>.<br/><br/>Visit <a target='_blank' href='https://one.one.one.one/' rel='noreferrer'>1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br/><br/>To learn more about our mission to help build a better Internet, <a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'>start here</a>. If you&amp;apos;re looking for a new career direction, check out <a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'>our open positions</a>.&quot;]}" client="load" opts="{&quot;name&quot;:&quot;Post&quot;,&quot;value&quot;:true}" await-children=""><main id="post" class="flex flex-row flex-wrap items-center justify-center pt2 pt4-l"><article class="post-full mw-100 ph3 ph0-l fs-20px"><h1 class="f6 f7-l fw4 gray1 pt1 pt3-l mb1">Open sourcing h3i: a command line tool and library for low-level HTTP/3 testing and debugging</h1><p class="f3 fw5 gray5 db di-l mt2">2024-12-30</p><ul class="author-lists flex pl0 mt4"><li class="list flex items-center pr2 mb1-ns"><a href="/author/lucas/" class="static-avatar pr1"><img class="author-profile-image br-100 mr2" src="https://blog.cloudflare.com/cdn-cgi/image/format=auto,dpr=3,width=64,height=64,gravity=face,fit=crop,zoom=0.5/https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1k0fbniT2p2wjRfMognV4V/dca8d2e3a3e7fa4e24d7ddd9832eff1d/lucas.jpg" alt="Lucas Pardue" width="62" height="62"></a><div class="author-name-tooltip"><a href="/author/lucas/" class="fw4 f3 no-underline black mr3">Lucas Pardue</a></div></li><li class="list flex items-center pr2 mb1-ns"><a href="/author/evan-rittenhouse/" class="static-avatar pr1"><img class="author-profile-image br-100 mr2" src="https://blog.cloudflare.com/cdn-cgi/image/format=auto,dpr=3,width=64,height=64,gravity=face,fit=crop,zoom=0.5/https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6TRFlHnVIfXX2cQhjt7wuc/86f2173516450dfa1e035b04cd4671c6/Screenshot_2024-12-21_at_17.56.35.png" alt="Evan Rittenhouse" width="62" height="62"></a><div class="author-name-tooltip"><a href="/author/evan-rittenhouse/" class="fw4 f3 no-underline black mr3">Evan Rittenhouse</a></div></li></ul><section class="post-full-content"><div class="mb2 gray5">16 min read</div><img class="mr2" src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/260wIGiNfe3xebQgH4ihCO/974a2495b393d6f632479c394e5a938d/image5.png" alt=""><div class="post-content lh-copy gray1"><p>Have you ever built a piece of IKEA furniture, or put together a LEGO set, by following the instructions closely and only at the end realized at some point you didn't <i>quite</i> follow them correctly? The final result might be close to what was intended, but there's a nagging thought that maybe, just maybe, it's not as rock steady or functional as it could have been.</p><p>Internet protocol specifications are instructions designed for engineers to build things. Protocol designers take great care to ensure the documents they produce are clear. The standardization process gathers consensus and review from experts in the field, to further ensure document quality. Any reasonably skilled engineer should be able to take a specification and produce a performant, reliable, and secure implementation. The Internet is central to everyone's lives, and we depend on these implementations. Any deviations from the specification can put us at risk. For example, mishandling of malformed requests can allow attacks such as <a href="https://en.wikipedia.org/wiki/HTTP_request_smuggling"><u>request smuggling</u></a>.</p><p>h3i is a binary command line tool and Rust library designed for low-level testing and debugging of HTTP/3, which runs over QUIC. <a href="https://crates.io/crates/h3i"><u>h3i</u></a> is free and open source as part of Cloudflare's <a href="https://github.com/cloudflare/quiche"><u>quiche</u></a> project. In this post we'll explain the motivation behind developing h3i, how we use it to help develop robust and safe standards-compliant software and production systems, and how you can similarly use it to test your own software or services. If you just want to jump into how to use h3i, go to the <a href="#the-h3i-command-line-tool"><u>h3i command line tool</u></a> section.</p>
          <div class="flex anchor relative">
            <h2 id="a-recap-of-quic-and-http-3">A recap of QUIC and HTTP/3</h2>
            <a href="#a-recap-of-quic-and-http-3" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p><a href="https://blog.cloudflare.com/http3-the-past-present-and-future/"><u>QUIC</u></a> is a secure-by-default transport protocol that provides performance advantages compared to TCP and TLS via a more efficient handshake, along with stream multiplexing that provides <a href="https://en.wikipedia.org/wiki/Head-of-line_blocking"><u>head-of-line blocking</u></a> avoidance. <a href="https://www.cloudflare.com/en-gb/learning/performance/what-is-http3/"><u>HTTP/3</u></a> is an application protocol that maps HTTP semantics to QUIC, such as defining how HTTP requests and responses are assigned to individual QUIC streams.</p><p>Cloudflare has supported QUIC on our global network in some shape or form <a href="https://blog.cloudflare.com/http3-the-past-present-and-future/"><u>since 2018</u></a>. We started while the <a href="https://ietf.org/"><u>Internet Engineering Task Force (IETF)</u></a> was earnestly standardizing the protocol, working through early iterations and using interoperability testing and experience to help provide feedback for the standards process. We <a href="https://blog.cloudflare.com/quic-version-1-is-live-on-cloudflare/"><u>launched support</u></a> for QUIC version 1 and HTTP/3 as soon as <a href="https://datatracker.ietf.org/doc/html/rfc9000"><u>RFC 9000</u></a> (and its accompanying specifications) were published in 2021.</p><p>We work on the Protocols team, who own the ingress proxy into the Cloudflare network. This is essentially Cloudflare’s “front door” — HTTP requests that come to Cloudflare from the Internet pass through us first. The majority of requests are passed onwards to things like rulesets, workers, caches, or a customer origin. However, you might be surprised that many requests don't ever make it that far because they are, in some way, invalid or malformed. Servers listening on the Internet have to be robust to traffic that is not RFC compliant, whether caused by accident or malicious intent.</p><p>The Protocols team actively participates in IETF standardization work and has also helped build and maintain other Cloudflare services that leverage quiche for QUIC and HTTP/3, from the proxies that help <a href="https://blog.cloudflare.com/icloud-private-relay/"><u>iCloud Private Relay</u></a> via <a href="https://blog.cloudflare.com/unlocking-quic-proxying-potential/"><u>MASQUE proxying</u></a>, to replacing <a href="https://blog.cloudflare.com/zero-trust-warp-with-a-masque/"><u>WARP's use of Wireguard with MASQUE</u></a>, and beyond.</p><p>Throughout all of these different use cases, it is important for us to extensively test all aspects of the protocols. A deep dive into protocol details is a blog post (or three) in its own right. So let's take a thin slice across HTTP to help illustrate the concepts.</p><p><a href="https://www.rfc-editor.org/rfc/rfc9110.html"><u>HTTP Semantics</u></a> are common to all versions of HTTP — the overall architecture, terminology, and protocol aspects such as request and response messages, methods, status codes, header and trailer fields, message content, and much more. Each individual HTTP version defines how semantics are transformed into a "wire format" for exchange over the Internet. You can read more about HTTP/1.1 and HTTP/2 in some of our previous <a href="https://blog.cloudflare.com/a-primer-on-proxies/"><u>blog</u></a> <a href="https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/"><u>posts</u></a>.</p><p>With HTTP/3, HTTP request and response messages are split into a series of binary frames. <a href="https://datatracker.ietf.org/doc/html/rfc9114#section-7.2.2"><u>HEADERS</u></a> frames carry a representation of HTTP metadata (method, path, status code, field lines). The payload of the frame is the encoded <a href="https://datatracker.ietf.org/doc/html/rfc9204"><u>QPACK</u></a> compression output. <a href="https://datatracker.ietf.org/doc/html/rfc9114#section-7.2.1"><u>DATA</u></a> frames carry <a href="https://datatracker.ietf.org/doc/html/rfc9110#section-6.4.1"><u>HTTP content</u></a> (aka "message body"). In order to exchange these frames, HTTP/3 relies on QUIC <a href="https://datatracker.ietf.org/doc/html/rfc9000#section-2"><u>streams</u></a>. These provide an ordered and reliable byte stream and each have an identifier (ID) that is unique within the scope of a connection. There are <a href="https://datatracker.ietf.org/doc/html/rfc9000#section-2.1"><u>four different stream types</u></a>, denominated by the two least significant bits of the ID.</p><p>As a simple example, assuming a QUIC connection has already been established, a client can make a GET request and receive a 200 OK response with an HTML body using the follow sequence:</p>
          <figure class="kg-card kg-image-card">
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7vVfQ5CYaaVPVmGloRUnkI/88bd727c3526e540bd493bc15fbe904a/unnamed.png" alt="" class="kg-image" width="1222" height="1392" loading="lazy">
          </figure><ol><li><p>Client allocates the first available client-initiated bidirectional QUIC stream. (The IDs start at 0, then 4, 8, 12 and so on)</p></li><li><p>Client sends the request HEADERS frame on the stream and sets the stream's <a href="https://datatracker.ietf.org/doc/html/rfc9000#section-19.8"><u>FIN bit</u></a> to mark the end of stream.</p></li><li><p>Server receives the request HEADERS frame and validates it against <a href="https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2"><u>RFC 9114 rules</u></a>. If accepted, it processes the request and prepares the response.</p></li><li><p>Server sends the response HEADERS frame on the same stream.</p></li><li><p>Server sends the response DATA frame on the same stream and sets the FIN bit.</p></li><li><p>Client receives the response frames and validates them. If accepted, the content is presented to the user.</p></li></ol><p>At the QUIC layer, stream data is split into STREAM frames, which are sent in QUIC packets over UDP. QUIC deals with any loss detection and recovery, helping to ensure stream data is reliable. The layer cake diagram below provides a handy comparison of how HTTP/1.1, HTTP/2 and HTTP/3 use TCP, UDP and IP.</p>
          <figure class="kg-card kg-image-card">
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4049UpKGn4BJcYcEXSFgWz/32143a5ba3672786639908ad96851225/image2.png" alt="" class="kg-image" width="1590" height="1130" loading="lazy">
          </figure>
          <div class="flex anchor relative">
            <h2 id="background-on-testing-quic-and-http-3-at-cloudflare">Background on testing QUIC and HTTP/3 at Cloudflare</h2>
            <a href="#background-on-testing-quic-and-http-3-at-cloudflare" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>The Protocols team has a diverse set of automated test tools that exercise our ingress proxy software in order to ensure it can stand up to the deluge that the Internet can throw at it. Just like a bouncer at a nightclub front door, we need to prevent as much bad traffic as possible before it gets inside and potentially causes damage.</p><p>HTTP/2 and HTTP/3 share several concepts. When we started developing early HTTP/3 support, we'd already learned a lot from production experience with HTTP/2. While HTTP/2 addressed many issues with HTTP/1.1 (especially problems like <a href="https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf"><u>request smuggling</u></a>, caused by its ASCII-based message delineation), HTTP/2 also added complexity and new avenues for attack. Security is an ongoing process, and the Protocols team continually hardens our software and systems to threats. For example, mitigating the range of <a href="https://blog.cloudflare.com/on-the-recent-http-2-dos-attacks/"><u>denial-of-service attacks</u></a> identified by Netflix in 2019, or the <a href="https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/"><u>HTTP/2 Rapid Reset</u></a> attacks of 2023.</p><p>For testing HTTP/2, we rely on the Python <a href="https://pypi.org/project/requests/"><u>Requests</u></a> library for testing conventional HTTP exchanges. However, that mostly only exercises HEADERS and DATA frames. There are eight other frame types and a plethora of ways that they can interact (hence the new attack vectors mentioned above). In order to get full testing coverage, we have to break down into the lower layer <a href="https://pypi.org/project/h2/"><u>h2</u></a> library, which allows exact frame-by-frame control. However, even that is not always enough. Libraries tend to want to follow the RFC rules and prevent their users from doing "the wrong thing". This is entirely logical for most purposes. For our needs though, we need to take off the safety guards just like any potential attackers might do. We have a few cases where the best way to exercise certain traffic patterns is to handcraft HTTP/2 frames in a hex editor, store that as binary, and replay it with a tool such as <a href="https://docs.openssl.org/1.0.2/man1/s_client/"><u>OpenSSL s_client</u></a>.</p><p>We knew we'd need similar testing approaches for HTTP/3. However, when we started in 2018, there weren't many other suitable client implementations. The rate of iteration on the specifications also meant it was hard to always keep in sync. So we built tests on quiche, using a mix of our <a href="https://github.com/cloudflare/quiche/blob/master/apps/src/client.rs"><u>quiche-client</u></a> and <a href="https://github.com/cloudflare/quiche/tree/master/tools/http3_test"><u>http3_test</u></a>. Over time, the python library <a href="https://github.com/aiortc/aioquic"><u>aioquic</u></a> has matured, and we have used it to add a range of lower-layer tests that break or bend HTTP/3 rules, in order to prove our proxies are robust.</p><p>Finally, we would be remiss not to mention that all the tests in our ingress proxy are <b>in addition to </b>the suite of over 500 integration tests that run on the quiche project itself.</p>
          <div class="flex anchor relative">
            <h2 id="making-http-3-testing-more-accessible-and-maintainable-with-h3i">Making HTTP/3 testing more accessible and maintainable with h3i</h2>
            <a href="#making-http-3-testing-more-accessible-and-maintainable-with-h3i" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>While we are happy with the coverage of our current tests, the smorgasbord of test tools makes it hard to know what to reach for when adding new tests. For example, we've had cases where aioquic's safety guards prevent us from doing something, and it has needed a patch or workaround. This sort of thing requires a time investment just to debug/develop the tests.</p><p>We believe it shouldn't take a protocol or code expert to develop what are often very simple to describe tests. While it is important to provide guide rails for the majority of conventional use cases, it is also important to provide accessible methods for taking them off.</p><p>Let's consider a simple example. In HTTP/3 there is something called the control stream. It's used to exchange frames such as SETTINGS, which affect the HTTP/3 connection. RFC 9114 <a href="https://datatracker.ietf.org/doc/html/rfc9114#section-6.2.1"><u>Section 6.2.1</u></a> states:</p><blockquote><p><i>Each side MUST initiate a single control stream at the beginning of the connection and send its SETTINGS frame as the first frame on this stream. If the first frame of the control stream is any other frame type, this MUST be treated as a connection error of type H3_MISSING_SETTINGS. Only one control stream per peer is permitted; receipt of a second stream claiming to be a control stream MUST be treated as a connection error of type H3_STREAM_CREATION_ERROR. The sender MUST NOT close the control stream, and the receiver MUST NOT request that the sender close the control stream. If either control stream is closed at any point, this MUST be treated as a connection error of type H3_CLOSED_CRITICAL_STREAM. Connection errors are described in Section 8.</i></p></blockquote><p>There are many tests we can conjure up just from that paragraph:</p><ol><li><p>Send a non-SETTINGS frame as the first frame on the control stream.</p></li><li><p>Open two control streams.</p></li><li><p>Open a control stream and then close it with a FIN bit.</p></li><li><p>Open a control stream and then reset it with a RESET_STREAM QUIC frame.</p></li><li><p>Wait for the peer to open a control stream and then ask for it to be reset with a STOP_SENDING QUIC frame.</p></li></ol><p>All of the above actions should cause a remote peer that has implemented the RFC properly to close the connection. Therefore, it is not in the interest of the local client or server applications to ever do these actions.</p><p>Many QUIC and HTTP/3 implementations are developed as libraries that are integrated into client or server applications. There may be an extensive set of unit or integration tests of the library checking RFC rules. However, it is also important to run the same tests on the integrated assembly of library and application, since it's all too common that an unhandled/mishandled library error can cascade to cause issues in upper layers. For instance, the HTTP/2 Rapid Reset attacks affected Cloudflare due to their <a href="https://blog.cloudflare.com/technical-breakdown-http2-rapid-reset-ddos-attack/#impact-on-customers"><u>impact on how one service spoke to another</u></a>.</p><p>We've developed h3i, a command line tool and library, to make testing more accessible and maintainable for all. We started with a client that can exercise servers, since that's what our focus has been. Future developments could support the opposite, a server that behaves in unusual ways in order to exercise clients.</p><p><b>Note: </b>h3i is <i>not</i> intended to be a production client! Its flexibility may cause issues that are not observed in other production-oriented clients. It is also not intended to be used for any type of performance testing and measurement.</p>
          <div class="flex anchor relative">
            <h2 id="the-h3i-command-line-tool">The h3i command line tool</h2>
            <a href="#the-h3i-command-line-tool" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>The primary purpose of the h3i command line tool is quick low-level debugging and exploratory testing. Rather than worrying about writing code or a test script, users can quickly run an ad-hoc client test against a target, guided by interactive prompts.</p><p>In the simplest case, you can think of h3i a bit like <a href="https://curl.se/"><u>curl</u></a> but with access to some extra HTTP/3 parameters. In the example below, we issue a request to <a href="https://cloudflare-quic.com"><u>https://cloudflare-quic.com</u></a>/ and receive a response.</p><div style="position: relative; padding-top: 70.91172214182345%;">
  <iframe src="https://customer-eq7kiuol0tk9chox.cloudflarestream.com/b1dadea8189831a6220d318d688d0ef8/iframe?muted=true&amp;preload=true&amp;loop=true&amp;autoplay=true&amp;poster=https%3A%2F%2Fcustomer-eq7kiuol0tk9chox.cloudflarestream.com%2Fb1dadea8189831a6220d318d688d0ef8%2Fthumbnails%2Fthumbnail.jpg%3Ftime%3D%26height%3D600" loading="lazy" style="border: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%;" allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;" allowfullscreen="true"></iframe>
</div><p>Walking through a simple GET with h3i step-by-step:</p><ol><li><p>Grab a copy of the h3i binary either by running <code>cargo install h3i</code> or cloning the quiche source repo at <a href="https://github.com/cloudflare/quiche/"><u>https://github.com/cloudflare/quiche/</u></a>. Both methods assume you have some familiarity with Rust and Cargo. See the cargo <a href="https://doc.rust-lang.org/book/ch14-04-installing-binaries.html"><u>documentation</u></a> for more information.</p><ol><li><p><code>cargo install</code> will place the binary on your path, so you can then just run it by executing <code>h3i</code>.</p></li><li><p>If running from source, navigate to the quiche/h3i directory and then use <code>cargo run</code>.</p></li></ol></li><li><p>Run the binary and provide the name and port of the target server. If the port is omitted, the default value 443 is assumed. E.g, <code>cargo run cloudflare-quic.com</code></p></li><li><p>h3i then enters the action prompting phase. A series of one or more HTTP/3 actions can be queued up, such as sending frames, opening or terminating streams, or waiting on data from the server. The full set of options is documented in the <a href="https://github.com/cloudflare/quiche/blob/master/h3i/README.md#command-line-tool"><u>readme</u></a>.</p><ol><li><p>The prompting interface adapts to keyboard inputs and supports tab completion.</p></li><li><p>In the example above, the <code>headers</code> action is selected, which walks through populating the fields in a HEADERS frame. It includes <a href="https://datatracker.ietf.org/doc/html/rfc9114#section-4.3.1"><u>mandatory fields</u></a> from RFC 9114 for convenience. If a test requires omitting these, the <code>headers_no_pseudo</code> can be used instead.</p></li></ol></li><li><p>The <code>commit</code> prompt choice finalizes the action list and moves to the connection phase. h3i initiates a QUIC connection to the server identified in step 2. Once connected, actions are executed in order.</p></li><li><p>By default, h3i reports some limited information about the frames the server sent. To get more detailed information, the <code>RUST_LOG</code> environment can be set with either <code>debug</code> or <code>trace</code> levels.</p></li></ol>
          <div class="flex anchor relative">
            <h2 id="instant-record-and-replay-powered-by-qlog">Instant record and replay, powered by qlog</h2>
            <a href="#instant-record-and-replay-powered-by-qlog" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>It can be fun to play around with the h3i command line tool to see how different servers respond to different combinations or sequences of actions. Occasionally, you'll find a certain set that you want to run over and over again, or share with a friend or colleague. Having to manually enter the prompts repeatedly, or share screenshots of the h3i input can turn tedious. Fortunately, h3i records all the actions in a log file by default — the file path is printed immediately after h3i starts. The format of this file is based on <a href="https://datatracker.ietf.org/doc/html/draft-ietf-quic-qlog-main-schema"><u>qlog</u></a>, an in-progress standard in development at the IETF for network protocol logging. It’s a perfect fit for our low-level needs.</p><p>Here's an example h3i qlog file:</p>
            <pre class="language-RUST"><code class="language-RUST hljs" data-highlighted="yes">{<span class="hljs-string">"qlog_version"</span>:<span class="hljs-string">"0.3"</span>,<span class="hljs-string">"qlog_format"</span>:<span class="hljs-string">"JSON-SEQ"</span>,<span class="hljs-string">"title"</span>:<span class="hljs-string">"h3i"</span>,<span class="hljs-string">"description"</span>:<span class="hljs-string">"h3i"</span>,<span class="hljs-string">"trace"</span>:{<span class="hljs-string">"vantage_point"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"client"</span>},<span class="hljs-string">"title"</span>:<span class="hljs-string">"h3i"</span>,<span class="hljs-string">"description"</span>:<span class="hljs-string">"h3i"</span>,<span class="hljs-string">"configuration"</span>:{<span class="hljs-string">"time_offset"</span>:<span class="hljs-number">0.0</span>}}}
{
  <span class="hljs-string">"time"</span>: <span class="hljs-number">0.172783</span>,
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"http:frame_created"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"stream_id"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"frame"</span>: {
      <span class="hljs-string">"frame_type"</span>: <span class="hljs-string">"headers"</span>,
      <span class="hljs-string">"headers"</span>: [
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">":method"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"GET"</span>
        },
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">":authority"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"cloudflare-quic.com"</span>
        },
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">":path"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"/"</span>
        },
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">":scheme"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"https"</span>
        },
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"user-agent"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"h3i"</span>
        }
      ]
    }
  },
  <span class="hljs-string">"fin_stream"</span>: <span class="hljs-literal">true</span>
}</code></pre>
            <p>h3i logs can be replayed using the <code>--qlog-input</code> option. You can change the target server host and port, and keep all the same actions. However, most servers will validate the :authority pseudo-header or Host header contained in a HEADERS frame. The --replay-host-override option allows changing these fields without needing to modify the file by hand.</p><p>And yes, qlog files are human-readable text in the JSON-SEQ format. So you can also just write these by hand in the first place if you like! However, if you're going to start writing things, maybe Rust is your preferred option…</p>
          <div class="flex anchor relative">
            <h2 id="using-the-h3i-library-to-send-a-malformed-request-with-rust">Using the h3i library to send a malformed request with Rust</h2>
            <a href="#using-the-h3i-library-to-send-a-malformed-request-with-rust" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>In our previous example, we just sent a valid request so there wasn't anything interesting to observe. Where h3i really shines is in generating traffic that isn't RFC compliant, such as malformed HTTP messages, invalid frame sequences, or other actions on streams. This helps determine if a server is acting robustly and defensively.</p><p>Let's explore this more with an example of HTTP content-length mismatch. RFC 9114 <a href="https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2"><u>section 4.1.2</u></a> specifies:</p><blockquote><p><i>A request or response that is defined as having content when it contains a Content-Length header field (Section 8.6 of [HTTP]) is malformed if the value of the Content-Length header field does not equal the sum of the DATA frame lengths received. A response that is defined as never having content, even when a Content-Length is present, can have a non-zero Content-Length header field even though no content is included in DATA frames.</i></p><p><i>Intermediaries that process HTTP requests or responses (i.e., any intermediary not acting as a tunnel) MUST NOT forward a malformed request or response. Malformed requests or responses that are detected MUST be treated as a stream error of type H3_MESSAGE_ERROR.</i></p><p><i>For malformed requests, a server MAY send an HTTP response indicating the error prior to closing or resetting the stream.</i></p></blockquote><p>There are good reasons that the RFC is so strict about handling mismatched content lengths. They can be a vector for <a href="https://portswigger.net/research/http2"><u>desynchronization attacks</u></a> (similar to request smuggling), especially when a proxy is converting inbound HTTP/3 to outbound HTTP/1.1.</p><p>We've provided an <a href="https://github.com/cloudflare/quiche/blob/master/h3i/examples/content_length_mismatch.rs"><u>example</u></a> of how to use the h3i Rust library to write a tailor-made test client that sends a mismatched content length request. It sends a Content-Length header of 5, but its body payload is “test”, which is only 4 bytes. It then waits for the server to respond, after which it explicitly closes the connection by sending a QUIC CONNECTION_CLOSE frame.</p><p>When running low-level tests, it can be interesting to also take a packet capture (<a href="https://en.wikipedia.org/wiki/Pcap"><u>pcap</u></a>) and observe what is happening on the wire. Since QUIC is an encrypted transport, we'll need to use the SSLKEYLOG environment variable to capture the session keys so that tools like Wireshark can <a href="https://wiki.wireshark.org/TLS#using-the-pre-master-secret"><u>decrypt and dissect</u></a>.</p><p>To follow along at home, clone a copy of the quiche repository, start a packet capture on the appropriate network interface and then run:</p>
            <pre class="language-RUST"><code class="language-RUST hljs" data-highlighted="yes">cd quiche/h3i
SSLKEYLOGFILE=<span class="hljs-string">"h3i-example.keys"</span> cargo run --example content_length_mismatch</code></pre>
            <p>In our decrypted capture, we see the expected sequence of handshake, request, response, and then closure.</p>
          <figure class="kg-card kg-image-card">
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6Qkdd3h0x826tH95S61u92/5de829e018b9d3ef409a2452362fa81e/image1.png" alt="" class="kg-image" width="1999" height="1096" loading="lazy">
          </figure>
          <div class="flex anchor relative">
            <h2 id="surveying-the-example-code">Surveying the example code</h2>
            <a href="#surveying-the-example-code" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>The <a href="https://github.com/cloudflare/quiche/blob/master/h3i/examples/content_length_mismatch.rs"><u>example</u></a> is a simple binary app with a <code>main()</code> entry point. Let's survey the key elements.</p><p>First, we set up an h3i configuration to a target server:</p>
            <pre class="language-RUST"><code class="language-RUST hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-variable">config</span> = Config::<span class="hljs-title function_ invoke__">new</span>()
        .<span class="hljs-title function_ invoke__">with_host_port</span>(<span class="hljs-string">"cloudflare-quic.com"</span>.<span class="hljs-title function_ invoke__">to_string</span>())
        .<span class="hljs-title function_ invoke__">with_idle_timeout</span>(<span class="hljs-number">2000</span>)
        .<span class="hljs-title function_ invoke__">build</span>()
        .<span class="hljs-title function_ invoke__">unwrap</span>();</code></pre>
            <p>The idle timeout is a QUIC concept which tells each endpoint when it should close the connection if the connection has been idle. This prevents endpoints from spinning idly if the peer hasn’t closed the connection. h3i’s default is 30 seconds, which can be too long for tests, so we set ours to 2 seconds here.</p><p>Next, we define a set of request headers and encode them with QPACK compression, ready to put in a HEADERS frame. Note that h3i does provide a <a href="https://docs.rs/h3i/latest/h3i/actions/h3/fn.send_headers_frame.html"><u>send_headers_frame</u></a> helper method which does this for you, but the example does it manually for clarity:</p>
            <pre class="language-Rust"><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-variable">headers</span> = <span class="hljs-built_in">vec!</span>[
        Header::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">b":method"</span>, <span class="hljs-string">b"POST"</span>),
        Header::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">b":scheme"</span>, <span class="hljs-string">b"https"</span>),
        Header::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">b":authority"</span>, <span class="hljs-string">b"cloudflare-quic.com"</span>),
        Header::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">b":path"</span>, <span class="hljs-string">b"/"</span>),
        <span class="hljs-comment">// We say that we're going to send a body with 5 bytes...</span>
        Header::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">b"content-length"</span>, <span class="hljs-string">b"5"</span>),
    ];

    <span class="hljs-keyword">let</span> <span class="hljs-variable">header_block</span> = <span class="hljs-title function_ invoke__">encode_header_block</span>(&amp;headers).<span class="hljs-title function_ invoke__">unwrap</span>();</code></pre>
            <p>Then, we define the set of h3i actions that we want to execute in order: send HEADERS, send a too-short DATA frame, wait for the server's HEADERS, then close the connection.</p>
            <pre class="language-Rust"><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-variable">actions</span> = <span class="hljs-built_in">vec!</span>[
        Action::SendHeadersFrame {
            stream_id: STREAM_ID,
            fin_stream: <span class="hljs-literal">false</span>,
            headers,
            frame: Frame::Headers { header_block },
        },
        Action::SendFrame {
            stream_id: STREAM_ID,
            fin_stream: <span class="hljs-literal">true</span>,
            frame: Frame::Data {
                <span class="hljs-comment">// ...but, in actuality, we only send 4 bytes. This should yield a</span>
                <span class="hljs-comment">// 400 Bad Request response from an RFC-compliant</span>
                <span class="hljs-comment">// server: https://datatracker.ietf.org/doc/html/rfc9114#section-4.1.2-3</span>
                payload: <span class="hljs-string">b"test"</span>.<span class="hljs-title function_ invoke__">to_vec</span>(),
            },
        },
        Action::Wait {
            wait_type: WaitType::<span class="hljs-title function_ invoke__">StreamEvent</span>(StreamEvent {
                stream_id: STREAM_ID,
                event_type: StreamEventType::Headers,
            }),
        },
        Action::ConnectionClose {
            error: quiche::ConnectionError {
                is_app: <span class="hljs-literal">true</span>,
                error_code: quiche::h3::WireErrorCode::NoError <span class="hljs-keyword">as</span> <span class="hljs-type">u64</span>,
                reason: <span class="hljs-built_in">vec!</span>[],
            },
        },
    ];</code></pre>
            <p>Finally, we'll set things in motion with <code>connect()</code>, which sets up the QUIC connection, executes the actions list and collects the summary.</p>
            <pre class="language-Rust"><code class="language-Rust hljs" data-highlighted="yes"><span class="hljs-keyword">let</span> <span class="hljs-variable">summary</span> =
        sync_client::<span class="hljs-title function_ invoke__">connect</span>(config, &amp;actions).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">"connection failed"</span>);

    <span class="hljs-built_in">println!</span>(
        <span class="hljs-string">"=== received connection summary! ===\n\n{}"</span>,
        serde_json::<span class="hljs-title function_ invoke__">to_string_pretty</span>(&amp;summary).<span class="hljs-title function_ invoke__">unwrap_or_else</span>(|e| e.<span class="hljs-title function_ invoke__">to_string</span>())
    );</code></pre>
            <p><a href="https://docs.rs/h3i/latest/h3i/client/connection_summary/struct.ConnectionSummary.html"><u>ConnectionSummary</u></a>&nbsp; provides data about the connection, including the frames h3i received, details about why the connection closed, and connection statistics. The example prints the summary out. However, you can programmatically check it. We do this to write our own internal automation tests.</p><p>If you're running the example, it should print something like the following:</p>
            <pre class="language-Rust"><code class="language-Rust hljs" data-highlighted="yes">=== received connection summary! ===

{
  <span class="hljs-string">"stream_map"</span>: {
    <span class="hljs-string">"0"</span>: [
      {
        <span class="hljs-string">"UNKNOWN"</span>: {
          <span class="hljs-string">"raw_type"</span>: <span class="hljs-number">2471591231244749708</span>,
          <span class="hljs-string">"payload"</span>: <span class="hljs-string">""</span>
        }
      },
      {
        <span class="hljs-string">"UNKNOWN"</span>: {
          <span class="hljs-string">"raw_type"</span>: <span class="hljs-number">2031803309763646295</span>,
          <span class="hljs-string">"payload"</span>: <span class="hljs-string">"4752454153452069732074686520776f7264"</span>
        }
      },
      {
        <span class="hljs-string">"enriched_headers"</span>: {
          <span class="hljs-string">"header_block_len"</span>: <span class="hljs-number">75</span>,
          <span class="hljs-string">"headers"</span>: [
            {
              <span class="hljs-string">"name"</span>: <span class="hljs-string">":status"</span>,
              <span class="hljs-string">"value"</span>: <span class="hljs-string">"400"</span>
            },
            {
              <span class="hljs-string">"name"</span>: <span class="hljs-string">"server"</span>,
              <span class="hljs-string">"value"</span>: <span class="hljs-string">"cloudflare"</span>
            },
            {
              <span class="hljs-string">"name"</span>: <span class="hljs-string">"date"</span>,
              <span class="hljs-string">"value"</span>: <span class="hljs-string">"Sat, 07 Dec 2024 00:34:12 GMT"</span>
            },
            {
              <span class="hljs-string">"name"</span>: <span class="hljs-string">"content-type"</span>,
              <span class="hljs-string">"value"</span>: <span class="hljs-string">"text/html"</span>
            },
            {
              <span class="hljs-string">"name"</span>: <span class="hljs-string">"content-length"</span>,
              <span class="hljs-string">"value"</span>: <span class="hljs-string">"155"</span>
            },
            {
              <span class="hljs-string">"name"</span>: <span class="hljs-string">"cf-ray"</span>,
              <span class="hljs-string">"value"</span>: <span class="hljs-string">"8ee06dbe2923fa17-ORD"</span>
            }
          ]
        }
      },
      {
        <span class="hljs-string">"DATA"</span>: {
          <span class="hljs-string">"payload_len"</span>: <span class="hljs-number">104</span>
        }
      },
      {
        <span class="hljs-string">"DATA"</span>: {
          <span class="hljs-string">"payload_len"</span>: <span class="hljs-number">51</span>
        }
      }
    ]
  },
  <span class="hljs-string">"stats"</span>: {
    <span class="hljs-string">"recv"</span>: <span class="hljs-number">10</span>,
    <span class="hljs-string">"sent"</span>: <span class="hljs-number">5</span>,
    <span class="hljs-string">"lost"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"retrans"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"sent_bytes"</span>: <span class="hljs-number">1712</span>,
    <span class="hljs-string">"recv_bytes"</span>: <span class="hljs-number">4178</span>,
    <span class="hljs-string">"lost_bytes"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"stream_retrans_bytes"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"paths_count"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"reset_stream_count_local"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"stopped_stream_count_local"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"reset_stream_count_remote"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"stopped_stream_count_remote"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"path_challenge_rx_count"</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-string">"path_stats"</span>: [
    {
      <span class="hljs-string">"local_addr"</span>: <span class="hljs-string">"0.0.0.0:64418"</span>,
      <span class="hljs-string">"peer_addr"</span>: <span class="hljs-string">"104.18.29.7:443"</span>,
      <span class="hljs-string">"active"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-string">"recv"</span>: <span class="hljs-number">10</span>,
      <span class="hljs-string">"sent"</span>: <span class="hljs-number">5</span>,
      <span class="hljs-string">"lost"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"retrans"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"rtt"</span>: <span class="hljs-number">0.008140072</span>,
      <span class="hljs-string">"min_rtt"</span>: <span class="hljs-number">0.004645536</span>,
      <span class="hljs-string">"rttvar"</span>: <span class="hljs-number">0.004238173</span>,
      <span class="hljs-string">"cwnd"</span>: <span class="hljs-number">13500</span>,
      <span class="hljs-string">"sent_bytes"</span>: <span class="hljs-number">1712</span>,
      <span class="hljs-string">"recv_bytes"</span>: <span class="hljs-number">4178</span>,
      <span class="hljs-string">"lost_bytes"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"stream_retrans_bytes"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"pmtu"</span>: <span class="hljs-number">1350</span>,
      <span class="hljs-string">"delivery_rate"</span>: <span class="hljs-number">247720</span>
    }
  ],
  <span class="hljs-string">"error"</span>: {
    <span class="hljs-string">"local_error"</span>: {
      <span class="hljs-string">"is_app"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-string">"error_code"</span>: <span class="hljs-number">256</span>,
      <span class="hljs-string">"reason"</span>: <span class="hljs-string">""</span>
    },
    <span class="hljs-string">"timed_out"</span>: <span class="hljs-literal">false</span>
  }
}
</code></pre>
            <p>Let’s walk through the output. Up first is the <a href="https://docs.rs/h3i/latest/h3i/client/connection_summary/struct.StreamMap.html"><u>StreamMap</u></a>, which is a record of all frames received on each stream. We can see that we received 5 frames on stream 0: 2 UNKNOWNs, one <a href="https://docs.rs/h3i/latest/h3i/frame/struct.EnrichedHeaders.html"><u>EnrichedHeaders</u></a> frame, and two DATA frames.</p><p>The UNKNOWN frames are extension frames that are unknown to h3i; the server under test is sending what are known as <a href="https://datatracker.ietf.org/doc/draft-edm-protocol-greasing/"><u>GREASE</u></a> frames to help exercise the protocol and ensure clients are not erroring when they receive something unexpected per <a href="https://datatracker.ietf.org/doc/html/rfc9114#extensions"><u>RFC 9114 requirements</u></a>.</p><p>The EnrichedHeaders frame is essentially an HTTP/3 HEADERS frame, but with some small helpers, like one to get the response status code. The server under test sent a 400 as expected.</p><p>The DATA frames carry response body bytes. In this case, the body is the HTML required to render the Cloudflare Bad Request page (you can peek at the HTML yourself in Wireshark). We chose to omit the raw bytes from the ConnectionSummary since they may not be representable safely as text. A future improvement could be to encode the bytes in base64 or hex, in order to support tests that need to check response content.</p>
          <div class="flex anchor relative">
            <h2 id="h3i-for-test-automation">h3i for test automation</h2>
            <a href="#h3i-for-test-automation" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>We believe h3i is a great library for building automated tests on. You can take the above example and modify it to fit within various types of (continuous) integration tests.</p><p>We outlined earlier how the Protocols team HTTP/3 testing has organically grown to use three different frameworks. Even within those, we still didn't have much flexibility and ease of use. Over the last year we've been building h3i itself and reimplementing our suite of ingress proxy test cases using the Rust library. This has helped us improve test coverage with a range of new tests not previously possible. It also surprisingly identified some problems with the old tests, particularly for some edge cases where it wasn't clear how the old test code implementation was running under the hood.</p>
          <div class="flex anchor relative">
            <h2 id="bake-offs-interop-and-wider-testing-of-http">Bake offs, interop, and wider testing of HTTP</h2>
            <a href="#bake-offs-interop-and-wider-testing-of-http" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p><a href="https://datatracker.ietf.org/doc/html/rfc1025"><u>RFC 1025</u></a> was published in 1987. Authored by <a href="https://icannwiki.org/Jon_Postel"><u>Jon Postel</u></a>, it discusses bake offs:</p><blockquote><p><i>In the early days of the development of TCP and IP, when there were very few implementations and the specifications were still evolving, the only way to determine if an implementation was "correct" was to test it against other implementations and argue that the results showed your own implementation to have done the right thing.&nbsp; These tests and discussions could, in those early days, as likely change the specification as change the implementation.</i></p><p><i>There were a few times when this testing was focused, bringing together all known implementations and running through a set of tests in hopes of demonstrating the N squared connectivity and correct implementation of the various tricky cases.&nbsp; These events were called "Bake Offs".</i></p></blockquote><p>While nearly 4 decades old, the concept of exercising Internet protocol implementations and seeing how they compare to the specification still holds true. The QUIC WG made heavy use of interoperability testing through its standardization process. We started off sitting in a room and running tests manually by hand (or with some help from scripts). Then <a href="https://seemann.io/"><u>Marten Seemann</u></a> developed the <a href="https://interop.seemann.io/"><u>QUIC Interop Runner</u></a>, which runs regular automated testing and collects and renders all the results. This has proven to be incredibly useful.</p>
          <figure class="kg-card kg-image-card">
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2OGnVUbatoX8Ya2IO5RdCl/754316e004a8e658ac089e10e70b72ca/image6.png" alt="" class="kg-image" width="1797" height="780" loading="lazy">
          </figure><p>The state of HTTP/3 interoperability testing is not quite as mature. Although there are tools such as <a href="https://kazu-yamamoto.hatenablog.jp/"><u>Kazu Yamamoto's</u></a> excellent <a href="https://github.com/kazu-yamamoto/h3spec"><u>h3spec</u></a> (in Haskell) for testing conformance, there isn't a similar continuous integration process of collection and rendering of results. While h3i shares similarities with h3spec, we felt it important to focus on the framework capabilities rather than creating a corpus of tests and assertions. Cloudflare is a big fan of Rust and as several teams move to Rust-based proxies, having a consistent ecosystem provides advantages (such as developer velocity).</p><p>We certainly feel there is a great opportunity for continued collaboration and cross-pollination between projects in the QUIC and HTTP space. For example, h3i might provide a suitable basis to build another tool (or set of scripts) to run bake offs or interop tests. Perhaps it even makes sense to have a common collection of test cases owned by the community, that can be specialized to the most appropriate or preferred tooling. This topic was recently presented at the <a href="https://github.com/HTTPWorkshop/workshop2024/blob/main/talks/5.%20Testing/testing.pdf"><u>HTTP Workshop 2024</u></a> by Mohammed Al-Sahaf, and it excites us to see <a href="https://www.caffeinatedwonders.com/2024/12/18/towards-validated-http-implementation/"><u>new potential directions</u></a> of testing improvements.</p><p>When using any tools or methods for protocol testing, we encourage responsible handling of security-related matters. If you believe you may have identified a vulnerability in an IETF Internet protocol itself, please follow the IETF's <a href="https://www.ietf.org/standards/rfcs/vulnerabilities/"><u>reporting guidance</u></a>. If you believe you may have discovered an implementation vulnerability in a product, open source project, or service using QUIC or HTTP, then you should report these directly to the responsible party. Implementers or operators often provide their own publicly-available guidance and contact details to send reports. For example, the Cloudflare quiche <a href="https://github.com/cloudflare/quiche/security/policy"><u>security policy</u></a> is available in the Security tab of the GitHub repository.</p>
          <div class="flex anchor relative">
            <h2 id="summary-and-outlook">Summary and outlook</h2>
            <a href="#summary-and-outlook" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>Cloudflare takes testing very seriously. While h3i has a limited feature set as a test HTTP/3 client, we believe it provides a strong framework that can be extended to a wider range of different cases and different protocols. For example, we'd like to add support for low-level HTTP/2.</p><p>We've designed h3i to integrate into a wide range of testing methodologies, from manual ad-hoc testing, to native Rust tests, to conformance testbenches built with scripting languages. We've had great success migrating our existing zoo of test tools to a single one that is more accessible and easier to maintain.</p><p>Now that you've read about h3i's capabilities, it's left as an exercise to the reader to go back to the example of HTTP/3 control streams and consider how you could write tests to exercise a server.</p><p>We encourage the community to experiment with h3i and provide feedback, and propose ideas or contributions to the <a href="https://github.com/cloudflare/quiche"><u>GitHub repository</u></a> as issues or Pull Requests.</p>
          <figure class="kg-card kg-image-card">
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5rp4YDTbXm37OxK7dtjiKF/816c0eed08926b7d34842f4769808277/image4.png" alt="" class="kg-image" width="1200" height="304" loading="lazy">
          </figure><p></p></div></section><section class="post-full-content flex flex-row flex-wrap mw7 center mb4"><div class="post-content lh-copy w-100 gray1 bt b--gray8 pt4">Cloudflare's connectivity cloud protects <a target="_blank" href="https://www.cloudflare.com/network-services/" rel="noreferrer">entire corporate networks</a>, helps customers build <a target="_blank" href="https://workers.cloudflare.com/" rel="noreferrer">Internet-scale applications efficiently</a>, accelerates any <a target="_blank" href="https://www.cloudflare.com/performance/accelerate-internet-applications/" rel="noreferrer">website or Internet application</a>, <a target="_blank" href="https://www.cloudflare.com/ddos/" rel="noreferrer">wards off DDoS attacks</a>, keeps <a target="_blank" href="https://www.cloudflare.com/application-security/" rel="noreferrer">hackers at bay</a>, and can help you on <a target="_blank" href="https://www.cloudflare.com/products/zero-trust/" rel="noreferrer">your journey to Zero Trust</a>.<br><br>Visit <a target="_blank" href="https://one.one.one.one/" rel="noreferrer">1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br><br>To learn more about our mission to help build a better Internet, <a target="_blank" href="https://www.cloudflare.com/learning/what-is-cloudflare/" rel="noreferrer">start here</a>. If you're looking for a new career direction, check out <a target="_blank" href="https://www.cloudflare.com/careers" rel="noreferrer">our open positions</a>.</div></section><div class="pv2 ph0-l mw7 center" id="social-buttons"><div class="mt5-l mt2 mb4 f2 flex flex-row-ns flex-column flex-wrap"><a id="social-button-hn" title="Discuss on Hacker News" href="https://news.ycombinator.com/submitlink?u=https://blog.cloudflare.com/h3i" target="_blank" rel="noreferrer" class="mr2-ns mb0-l white link b pv3 ph3 mb3 " style="background-color:#0055DC"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 512 512" class="mr2"><g><path d="M31,31v450h450V31H31z M270.1,287.6v94.9h-28.1v-94.9L165,143.5h31.9L256,254.3l59.1-110.8H347
C347,143.5,270.1,287.6,270.1,287.6z"></path></g></svg><span class="v-mid">Discuss on Hacker News</span></a></div></div><iframe sandbox="allow-scripts allow-popups" title="cloudflare-tv-live-link" id="cloudflare-tv-embed" src="https://cloudflare.tv/embed/live.html" loading="lazy"></iframe><a href="/tag/quic/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">QUIC</a><a href="/tag/http3/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">HTTP3</a><a href="/tag/testing/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">Testing</a><a href="/tag/protocols/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">Protocols</a><a href="/tag/rust/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">Rust</a></article></main><div class="ph3 pv3"><div class=" flex flex-row flex-wrap mw7 center"><div class="w-100 bt b--gray8"><p class="black fw5 f4 mt4">Follow on X</p></div><div class="w-100 pb2"><span>Lucas Pardue</span><span class="ph1">|</span><a href="https://x.com/@SimmerVigor" class="no-underline">@SimmerVigor</a></div><div class="w-100 pb2"><span>Cloudflare</span><span class="ph2">|</span><a href="https://x.com/@cloudflare" class="no-underline">@cloudflare</a></div></div></div><div data-testid="related-posts-section" class="pv4 ph3 ph0-l flex flex-row flex-wrap mw7 center"><div class="w-100 bt b--gray8"><p class="orange fw5 f4 mt4 ttu">Related posts</p></div><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2024-10-25T14:00+01:00">October 25, 2024  1:00 PM</p><a data-testid="related-posts-article-title" href="/elephants-in-tunnels-how-hyperdrive-connects-to-databases-inside-your-vpc-networks/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Elephants in tunnels: how Hyperdrive connects to databases inside your VPC networks</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.<!-- -->...</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By<!-- -->&nbsp;</span><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/andrew-repp/" class="fw5 f2 black no-underline">Andrew Repp</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/emilio-assuncao/" class="fw5 f2 black no-underline">Emilio Assunção</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/abhishek-chanda/" class="fw5 f2 black no-underline">Abhishek Chanda</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="/tag/developer-platform/" class="no-underline f1 fw2 blue3 underline-hover">Developer Platform<!-- -->,</a>&nbsp;</span><span><a href="/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive<!-- -->,</a>&nbsp;</span><span><a href="/tag/workers/" class="no-underline f1 fw2 blue3 underline-hover">Cloudflare Workers<!-- -->,</a>&nbsp;</span><span><a href="/tag/hyperdrive/" class="no-underline f1 fw2 blue3 underline-hover">Hyperdrive<!-- -->,</a>&nbsp;</span><span><a href="/tag/postgres/" class="no-underline f1 fw2 blue3 underline-hover">Postgres<!-- -->,</a>&nbsp;</span><span><a href="/tag/sql/" class="no-underline f1 fw2 blue3 underline-hover">SQL<!-- -->,</a>&nbsp;</span><span><a href="/tag/rust/" class="no-underline f1 fw2 blue3 underline-hover">Rust<!-- -->,</a>&nbsp;</span><span><a href="/tag/websockets/" class="no-underline f1 fw2 blue3 underline-hover">WebSockets</a>&nbsp;</span></div></article><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2024-09-10T14:00+00:00">September 10, 2024  2:00 PM</p><a data-testid="related-posts-article-title" href="/pingora-saving-compute-1-percent-at-a-time/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">A good day to trie-hard: saving compute 1% at a time</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">Pingora handles 35M+ requests per second, so saving a few microseconds per request can translate to thousands of dollars saved on computing costs. In this post, we share how we freed up over 500 CPU cores by optimizing one function and announce trie-hard, the open source crate that we created to do it.<!-- -->...</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By<!-- -->&nbsp;</span><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/kevin-guthrie/" class="fw5 f2 black no-underline">Kevin Guthrie</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="/tag/internet-performance/" class="no-underline f1 fw2 blue3 underline-hover">Internet Performance<!-- -->,</a>&nbsp;</span><span><a href="/tag/rust/" class="no-underline f1 fw2 blue3 underline-hover">Rust<!-- -->,</a>&nbsp;</span><span><a href="/tag/open-source/" class="no-underline f1 fw2 blue3 underline-hover">Open Source<!-- -->,</a>&nbsp;</span><span><a href="/tag/optimization/" class="no-underline f1 fw2 blue3 underline-hover">Optimization</a>&nbsp;</span></div></article><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2024-08-22T14:00+00:00">August 22, 2024  2:00 PM</p><a data-testid="related-posts-article-title" href="/wildcard-rules/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Go wild: Wildcard support in Rules and a new open-source wildcard crate</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">We’re excited to announce wildcard support across our Ruleset Engine-based products and our open-source wildcard crate in Rust. Configuring rules has never been easier, with powerful pattern matching enabling simple and flexible URL redirects and beyond for users on all plans.<!-- -->...</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By<!-- -->&nbsp;</span><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/nikita/" class="fw5 f2 black no-underline">Nikita Cano</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/diogo-sousa/" class="fw5 f2 black no-underline">Diogo Sousa</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="/tag/cdn/" class="no-underline f1 fw2 blue3 underline-hover">CDN<!-- -->,</a>&nbsp;</span><span><a href="/tag/edge-rules/" class="no-underline f1 fw2 blue3 underline-hover">Edge Rules<!-- -->,</a>&nbsp;</span><span><a href="/tag/open-source/" class="no-underline f1 fw2 blue3 underline-hover">Open Source<!-- -->,</a>&nbsp;</span><span><a href="/tag/rust/" class="no-underline f1 fw2 blue3 underline-hover">Rust<!-- -->,</a>&nbsp;</span><span><a href="/tag/developers/" class="no-underline f1 fw2 blue3 underline-hover">Developers</a>&nbsp;</span></div></article><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2024-07-25T14:00:46.000+01:00">July 25, 2024  1:00 PM</p><a data-testid="related-posts-article-title" href="/making-waf-ai-models-go-brr/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Making WAF ML models go brrr: saving decades of processing time</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">In this post, we discuss the performance optimizations we've implemented for our WAF ML product. We'll guide you through specific code examples and benchmark numbers, and we'll share the impressive latency reduction numbers observed after the rollout<!-- -->...</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By<!-- -->&nbsp;</span><li class="list flex items-center" style="white-space:nowrap"><div class="author-name-tooltip"><a href="/author/alex-bocharov/" class="fw5 f2 black no-underline">Alex Bocharov</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="/tag/machine-learning/" class="no-underline f1 fw2 blue3 underline-hover">Machine Learning<!-- -->,</a>&nbsp;</span><span><a href="/tag/waf/" class="no-underline f1 fw2 blue3 underline-hover">WAF<!-- -->,</a>&nbsp;</span><span><a href="/tag/performance/" class="no-underline f1 fw2 blue3 underline-hover">Performance<!-- -->,</a>&nbsp;</span><span><a href="/tag/optimization/" class="no-underline f1 fw2 blue3 underline-hover">Optimization<!-- -->,</a>&nbsp;</span><span><a href="/tag/rust/" class="no-underline f1 fw2 blue3 underline-hover">Rust<!-- -->,</a>&nbsp;</span><span><a href="/tag/ai-waf/" class="no-underline f1 fw2 blue3 underline-hover">AI WAF<!-- -->,</a>&nbsp;</span><span><a href="/tag/waf-attack-score/" class="no-underline f1 fw2 blue3 underline-hover">WAF Attack Score</a>&nbsp;</span></div></article></div></astro-island><footer class="pt4 pb4 pl1 pr1 main-footer"><div class="mw8 center dn db-l ph3"><div class="flex flex-row justify-between"><div class="main-footer__menu-group"><ul id="getting-started-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="getting-started-menu">Getting Started<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/free/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="free-plans" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Free plans</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/enterprise/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="enterprise" class="f1 blue3 no-underline underline-hover" rel="noreferrer">For enterprises</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="compare-plans" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Compare plans</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/about-your-website/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="get-a-recommendation" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Get a recommendation</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/enterprise/demo/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="request-a-demo" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Request a demo</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/enterprise/contact/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="contact-sales" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Contact Sales</a></li></ul></div><div class="main-footer__menu-group"><ul id="company-menu" class="list pl0"><li class="pt1 pb1 f1" data-submenu="company-menu">Resources<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/learning/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="learning-center" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Learning Center</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/analysts/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="analysts-report" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Analyst reports</a></li><li class="pt1 pb1"><a href="https://radar.cloudflare.com/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare Radar</a></li><li class="pt1 pb1"><a href="https://cloudflare.tv/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="tv" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare TV</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/case-studies/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="case-studies" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Case Studies</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/resource-hub/?resourcetype=Webinar" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="webinars" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Webinars</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/resource-hub/?resourcetype=Whitepaper" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="white-papers" class="f1 blue3 no-underline underline-hover" rel="noreferrer">White Papers</a></li><li class="pt1 pb1"><a href="https://developers.cloudflare.com" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="developer-docs" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Developer docs</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/the-net/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="theNet" class="f1 blue3 no-underline underline-hover" rel="noreferrer">theNet</a></li></ul></div><div class="main-footer__menu-group"><ul id="sales-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="sales-menu">Solutions<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/connectivity-cloud/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="connectivity-cloud" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Connectivity cloud</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/zero-trust/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="zero-trust" class="f1 blue3 no-underline underline-hover" rel="noreferrer">SSE and SASE services</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/application-services/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="application-services" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Application services</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/network-services/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="network-services" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Network services</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/developer-platform/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="developer-services" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Developer services</a></li></ul></div><div class="main-footer__menu-group"><ul id="community-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="community-menu">Community<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://community.cloudflare.com" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="community_hub" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Community Hub</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/galileo/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="galileo" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Project Galileo</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/athenian/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="athenian" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Athenian Project</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/campaigns/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="cloudflare-for-campaigns" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare for Campaigns</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/partners/technology-partners/cidp/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="critical-infrastructure-defense-project" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Critical Infrastructure Defense Project</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/connect2024/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="connect-2024" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Connect 2024</a></li></ul></div><div class="main-footer__menu-group"><ul id="support-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="support-menu">Support<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://support.cloudflare.com" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="help-center" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Help center</a></li><li class="pt1 pb1"><a href="https://www.cloudflarestatus.com" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="status" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare Status</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/compliance/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="compliance" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Compliance</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/gdpr/introduction/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="gdpr" class="f1 blue3 no-underline underline-hover" rel="noreferrer">GDPR</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/trust-hub/abuse-approach/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="trust-and-safety" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Trust &amp; Safety</a></li></ul></div><div class="main-footer__menu-group"><ul id="company-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="company-menu">Company<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/about-overview/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover" rel="noreferrer">About Cloudflare</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/people/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="our_team" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Our team</a></li><li class="pt1 pb1"><a href="https://cloudflare.net/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="investor-relations" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Investor relations</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/press/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="press" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Press</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/careers/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="careers" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Careers</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/diversity-equity-and-inclusion/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="diversity-equity-inclusion" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Diversity, equity &amp; inclusion</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/impact/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="impact-ESG" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Impact/ESG</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/network/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="network_map" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Network Map</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/press-kit/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="press-kit" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Logos &amp; press kit</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/partners/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="partners" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Become a partner</a></li></ul></div></div></div><div class="mw8 center ph3"><div class="flex flex-row flex-wrap justify-center md:justify-between items-center pt4"><div class="flex flex-row space-x-4 items-start w-25-l pb4 pb0-l"><a target="_blank" rel="noreferrer" href="https://www.facebook.com/Cloudflare/" class="w-8"><img class="w-8" src="https://www.cloudflare.com/img/footer/facebook.svg" alt="facebook"></a><a target=" _blank" rel="noreferrer" href="https://x.com/Cloudflare" class="w-8"><img class="w-8" src="https://www.cloudflare.com/img/footer/twitter.svg" alt="X"></a><a target="_blank" rel="noreferrer" href="https://www.linkedin.com/company/cloudflare" class="w-8"><img class="w-8" src="https://www.cloudflare.com/img/footer/linkedin.svg" alt="linkedin"></a><a target="_blank" rel="noreferrer" href="https://www.youtube.com/cloudflare" class="w-8"><img class="w-8" src="https://www.cloudflare.com/img/footer/youtube.svg" alt="youtube"></a><a target="_blank" rel="noreferrer" href="https://www.instagram.com/cloudflare" class="w-8"><img class="w-8" src="https://www.cloudflare.com/img/footer/instagram.svg" alt="instagram"></a></div><div class="w-70-l tr-l tl-ns"><div><span class="main-footer__copyright f1">© <!-- -->2024<!-- --> Cloudflare, Inc.<!-- --> </span><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/privacypolicy/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Privacy Policy<!-- --> </a><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/website-terms/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Terms of Use<!-- --> </a><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/disclosure/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Report Security Issues<!-- --> </a><span class="main-footer__copyright f1">|</span><img class="mw2 ph1" src="/images/privacy-options.svg" alt="Privacy Options"><a href="#cookie-settings" id="ot-sdk-btn" class="ot-sdk-show-settings main-footer__copyright f1 no-underline underline-hover">Your Privacy Choices</a><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/trademark/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Trademark<!-- --> </a></div></div></div></div></footer><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;rayId&quot;:&quot;8fa2fae939297e27&quot;,&quot;serverTiming&quot;:{&quot;name&quot;:{&quot;cfExtPri&quot;:true,&quot;cfL4&quot;:true,&quot;cfSpeedBrain&quot;:true,&quot;cfCacheStatus&quot;:true}},&quot;version&quot;:&quot;2024.10.5&quot;,&quot;token&quot;:&quot;2bc156e5f250476cb274d269511ffb57&quot;}" crossorigin="anonymous"></script>
<div></div><div></div><div></div><div><noscript>
<img height="1" width="1" style="display:none;" alt="" src="https://px.ads.linkedin.com/collect/?pid=28851&fmt=gif" />
</noscript></div><div></div><iframe height="0" width="0" style="display: none; visibility: hidden;"></iframe><div id="onetrust-consent-sdk"><div class="onetrust-pc-dark-filter ot-hide ot-fade-in"></div></div></body></html>