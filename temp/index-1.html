<<<<<<< Updated upstream
<<<<<<< Updated upstream
<!DOCTYPE html><html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-strategies/per-space-version" data-theme="light" data-rh="lang,dir,class"><head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title>Per-Space Version Strategy | Replicache Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.replicache.dev/strategies/per-space-version"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Per-Space Version Strategy | Replicache Docs"><meta data-rh="true" name="description" content="The Per-Space Version Strategy is the same as the The Global Version Strategy except it has more than one space."><meta data-rh="true" property="og:description" content="The Per-Space Version Strategy is the same as the The Global Version Strategy except it has more than one space."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://doc.replicache.dev/strategies/per-space-version"><link data-rh="true" rel="alternate" href="https://doc.replicache.dev/strategies/per-space-version" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.replicache.dev/strategies/per-space-version" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Y3T1SV2WRD-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Replicache Docs" href="/opensearch.xml">
=======
<!DOCTYPE html><html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-strategies/row-version" data-theme="light" data-rh="lang,dir,class"><head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title>Row Version Strategy | Replicache Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.replicache.dev/strategies/row-version"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Row Version Strategy | Replicache Docs"><meta data-rh="true" name="description" content="This strategy has a few big advantages over the other strategies:"><meta data-rh="true" property="og:description" content="This strategy has a few big advantages over the other strategies:"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://doc.replicache.dev/strategies/row-version"><link data-rh="true" rel="alternate" href="https://doc.replicache.dev/strategies/row-version" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.replicache.dev/strategies/row-version" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Y3T1SV2WRD-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Replicache Docs" href="/opensearch.xml">
>>>>>>> Stashed changes
=======
<!DOCTYPE html><html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-strategies/overview" data-theme="light" data-rh="lang,dir,class"><head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title>Overview | Replicache Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doc.replicache.dev/strategies/overview"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Overview | Replicache Docs"><meta data-rh="true" name="description" content="Replicache defines abstract push and pull endpoints that servers must implement to sync. There are a number of possible strategies to implement these endpoints with different tradeoffs."><meta data-rh="true" property="og:description" content="Replicache defines abstract push and pull endpoints that servers must implement to sync. There are a number of possible strategies to implement these endpoints with different tradeoffs."><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://doc.replicache.dev/strategies/overview"><link data-rh="true" rel="alternate" href="https://doc.replicache.dev/strategies/overview" hreflang="en"><link data-rh="true" rel="alternate" href="https://doc.replicache.dev/strategies/overview" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Y3T1SV2WRD-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Replicache Docs" href="/opensearch.xml">
>>>>>>> Stashed changes
<script type="text/javascript" async="" src="https://www.googletagmanager.com/gtag/js?id=G-GQBKRVPR1B&amp;l=dataLayer&amp;cx=c&amp;gtm=45He4cc1v865895793za200"></script><script async="" src="https://www.googletagmanager.com/gtm.js?id=GTM-PTN768T"></script><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-PTN768T",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>

<script src="/js/redirects.js"></script><link rel="stylesheet" href="/assets/css/styles.9185dd9b.css">
<link rel="preload" href="/assets/js/runtime~main.ca11e309.js" as="script">
<link rel="preload" href="/assets/js/main.6abc1f11.js" as="script">
<<<<<<< Updated upstream
<<<<<<< Updated upstream
<meta name="viewport" content="width=device-width, initial-scale=1.0" data-rh="true"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/5f2ffadc.666f1eaf.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3afd88c8.0a25afb5.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/0f3acd10.1deb4875.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/bbdd3825.dd815daa.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/cc85606c.18b7c252.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/4cb8c6ce.419915da.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3349748a.292d8b30.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3e42dbf6.96d57c57.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/481c9a43.53b9451c.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/5e8c322a.2cb272b4.js"></head>
<body class="navigation-with-keyboard" data-rh="class" style="overflow: visible;">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/replicache.svg" alt="Shiny Replicache Logo" class="themedImage_ToTc themedImage--light_HNdA"></div><b class="navbar__title text--truncate">Replicache Documentation</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/rocicorp/replicache" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Hello, Replicache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Examples</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Build Your Own Backend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true">Backend Strategies</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/reset">Reset Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/global-version">Global Version Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/strategies/per-space-version">Per-Space Version Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/row-version">Row Version Strategy</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Understand Replicache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">How To</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://replicache.notion.site/Replicache-Releases-f86ffef7f72f46ca9b597d5081e05b88" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Backend Strategies</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Per-Space Version Strategy</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>🛸 Per-Space Version Strategy</h1><p>The Per-Space Version Strategy is the same as the <a href="/strategies/global-version">The Global Version Strategy</a> except it has more than one space.</p><p>This increases throughput of the server. Instead of approximately 50 pushes per second across your entire server, you can get 50 pushes per space.</p><p>A common example of how people partition by space is along organizational boundaries in a SaaS application. Each customer org would be its own space and you'd thereby get 50 pushes per second per organization.</p><p>The tradeoffs to keep in mind is that you lose consistency guarantees across spaces. Replicache mutations are atomic: you can move data within a space, rename, copy, etc., and you have a guarantee that the entire change happens or none of it does. But this guarantee does not apply across spaces.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Example</div><div class="admonitionContent_S0QG"><p>Imagine moving data from one space to another. Because there is no transactional guarantees across spaces, during the move, the user might see the data exist in both spaces, or neither.</p><p>While this might just seem like a minor UI annoyance, keep in mind that it means that if you have IDs that refer to data across spaces, there is no guarantee that the data actually exists at the moment you render. You'll have to defensively guard against invalid pointers into other spaces.</p></div></div><p>This is why partitioning makes most sense at very high-level boundaries, like organizations, so that it will be uncommon in your application to want to have data from two spaces interact.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="schema">Schema<a href="#schema" class="hash-link" aria-label="Direct link to Schema" title="Direct link to Schema">​</a></h2><p>The schema generalizes the schema from the <a href="/strategies/reset">Global Version Strategy</a>:</p><div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">ReplicacheSpace</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Same as Global Version Strategy.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  version</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">ReplicacheClientGroup</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Same as Global Version Strategy.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">any</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  spaceID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">ReplicacheClient</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Same as Global Version Strategy.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  clientGroupID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastModifiedVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Each of your domain entities will have three additional fields.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">Todo</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// ... fields needed for your application (id, title, complete, etc)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Same as Global Version Strategy.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastModifiedVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  deleted</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">boolean</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  spaceID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="push">Push<a href="#push" class="hash-link" aria-label="Direct link to Push" title="Direct link to Push">​</a></h2><p>The push handler should receive the <code>spaceID</code> being operated on as an HTTP parameter. The logic is otherwise almost identical to the Global Version Strategy, with minor changes to deal with spaces. The changes from the Global Version Strategy are marked below <strong>in bold</strong>.</p><p>Replicache sends a <a href="/reference/server-push#http-request-body"><code>PushRequest</code></a> to the push endpoint. For each mutation described in the request body, the push endpoint should:</p><ol><li><code>let errorMode = false</code></li><li>Begin transaction</li><li><strong>Read the <code>ReplicacheClientGroup</code> for <code>body.clientGroupID</code> from the database, or default to:</strong></li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  spaceID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Verify the requesting user owns the specified client group.</li><li><strong>Verify the specified client group is part of the requesting space.</strong></li><li>Read the <code>ReplicacheClient</code> for <code>mutation.clientID</code> or default to:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> mutation.clientID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  clientGroupID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">0</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastModifiedVersion</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="7"><li>Verify the requesting client group owns the requested client.</li><li><code>let nextMutationID = client.lastMutationID + 1</code></li><li><strong>Read the <code>ReplicacheSpace</code> for <code>request.params.spaceID</code></strong></li><li><code>let nextVersion = replicacheSpace.version + 1</code></li><li>Rollback transaction and skip this mutation if already processed (<code>mutation.id &lt; nextMutationID</code>)</li><li>Rollback transaction and error if mutation from the future (<code>mutation.id &gt; nextMutationID</code>)</li><li>If <code>errorMode != true</code> then:<ol><li>Try to run business logic for mutation<ol><li>Set <code>lastModifiedVersion</code> for any modified rows to <code>nextVersion</code>.</li><li>Set <code>deleted = true</code> for any deleted entities.</li></ol></li><li>If error:<ol><li>Log error</li><li><code>set errorMode = true</code></li><li>Abort transaction</li><li>Repeat these steps at the beginning</li></ol></li></ol></li><li><strong>Write <code>ReplicacheSpace</code>:</strong></li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  spaceID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> request.params.spaceID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  version</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> nextVersion</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="15"><li><strong>Write <code>ReplicacheClientGroup</code>:</strong></li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  spaceId</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="16"><li>Write <code>ReplicacheClient</code>:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> mutation.clientID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  clientGroupID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> nextMutationID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastModifiedVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> nextVersion</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="17"><li>Commit transaction</li></ol><p>After the loop is complete, poke clients to cause them to pull.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pull">Pull<a href="#pull" class="hash-link" aria-label="Direct link to Pull" title="Direct link to Pull">​</a></h2><p>The pull handler is the same as in the Global Version Strategy, but with mionr changes to support multiple spaces. Changes from the Global Version Strategy are <strong>marked in bold</strong>.</p><p>Replicache sends a <a href="/reference/server-pull#http-request-body"><code>PullRequest</code></a> to the pull endpoint. The pull handler should also receive the <code>spaceID</code> being operated on as an HTTP parameter. The endpoint should:</p><ol><li>Begin transaction</li><li><code>let prevVersion = body.cookie ?? 0</code></li><li>Read the <code>ReplicacheClientGroup</code> for <code>body.clientGroupID</code> from the database, or default to:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Verify the requesting client group owns the requested client.</li><li>Verify the client group is part of the requesed space.</li><li><strong>Read the <code>ReplicacheSpace</code> entity for <code>request.params.spaceID</code></strong></li><li><strong>Read all domain entities from the database that have <code>spaceID == request.params.spaceID AND lastModifiedVersion &gt; prevVersion</code></strong></li><li>Read all <code>ReplicacheClient</code> records for the requested client group that have <code>lastModifiedVersion &gt; prevVersion</code>.</li><li>Create a <code>PullResponse</code> with:<ol><li><code>cookie</code> set to <code>space.version</code></li><li><code>lastMutationIDChanges</code> set to the <code>lastMutationID</code> for every client that has changed.</li><li><code>patch</code> set to:<ol><li><code>op:del</code> for all domain entities that have changed and are deleted</li><li><code>op:put</code> for all domain entities that have changed and aren't deleted</li></ol></li></ol></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h2><p><a href="https://github.com/rocicorp/todo-wc" target="_blank" rel="noopener noreferrer">Todo-WC</a> is a simple example of per-space versioning. <a href="/examples/repliear">Repliear</a> is a more involved example. Note that both examples also uses <a href="/howto/share-mutators">Shared Mutators</a> and <a href="#early-exit-batch-size">batch the mutations</a> into a single transaction. So the logic is a little different than described above, but equivalent.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenges">Challenges<a href="#challenges" class="hash-link" aria-label="Direct link to Challenges" title="Direct link to Challenges">​</a></h2><ul><li>Like the Global Version strategy, soft deletes can be annoying.</li><li>Also like the Global Version strategy, it is difficult to implement features like read authentication and partial sync.</li><li>It can be hard in some applications to find a way to partition spaces naturally.</li><li>50 pushes per second per space can still be insufficient for some applications.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="variations">Variations<a href="#variations" class="hash-link" aria-label="Direct link to Variations" title="Direct link to Variations">​</a></h2><p>The same variations available to <a href="/strategies/global-version#variations">The Global Version Strategy</a> apply here.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rocicorp/replicache/tree/main/doc/docs/strategies/per-space-version.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/strategies/global-version"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Global Version Strategy</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/strategies/row-version"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Row Version Strategy</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#schema" class="table-of-contents__link toc-highlight">Schema</a></li><li><a href="#push" class="table-of-contents__link toc-highlight">Push</a></li><li><a href="#pull" class="table-of-contents__link toc-highlight">Pull</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#challenges" class="table-of-contents__link toc-highlight">Challenges</a></li><li><a href="#variations" class="table-of-contents__link toc-highlight">Variations</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hello@replicache.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.replicache.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/replicache" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Rocicorp LLC.</div></div></div></footer></div>
=======
<meta name="viewport" content="width=device-width, initial-scale=1.0" data-rh="true"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3afd88c8.0a25afb5.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/481c9a43.53b9451c.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3e42dbf6.96d57c57.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/cc85606c.18b7c252.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/5e8c322a.2cb272b4.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/5f2ffadc.666f1eaf.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/bbdd3825.dd815daa.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/4cb8c6ce.419915da.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3349748a.292d8b30.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/0f3acd10.1deb4875.js"></head>
<body class="navigation-with-keyboard" data-rh="class" style="overflow: visible;">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/replicache.svg" alt="Shiny Replicache Logo" class="themedImage_ToTc themedImage--light_HNdA"></div><b class="navbar__title text--truncate">Replicache Documentation</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/rocicorp/replicache" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Hello, Replicache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Examples</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Build Your Own Backend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true">Backend Strategies</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/reset">Reset Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/global-version">Global Version Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/per-space-version">Per-Space Version Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/strategies/row-version">Row Version Strategy</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Understand Replicache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">How To</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://replicache.notion.site/Replicache-Releases-f86ffef7f72f46ca9b597d5081e05b88" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Backend Strategies</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Row Version Strategy</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>🚣 The Row Version Strategy</h1><p>This strategy has a few big advantages over the other strategies:</p><ul><li>The Client View can be <strong>computed</strong> dynamically — it can be any arbitrary query over the database, including filters, joins, windows, auth, etc. This <em>pull query</em> can even change per-user. If the user checks a box in the UI, the query might change from <em>“all active threads"</em> to <em>"all active threads, or first 20 inactive threads ordered by modified-date”</em>.</li><li>It does not require global locks or the concept of spaces.</li><li>It does not require a soft deletes. Entities can be fully deleted.</li></ul><p>The disadvantage is that it pays for this flexibility in increased implementation complexity and read cost. Pulls become more expensive because they require a few queries, and they aren’t a simple index scan. However because there are no global locks, the database should be easier to scale.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="client-view-records">Client View Records<a href="#client-view-records" class="hash-link" aria-label="Direct link to Client View Records" title="Direct link to Client View Records">​</a></h2><p>A <em>Client View Record</em> (CVR) is a minimal representation of a Client View snapshot. In other words, it captures what data a Client Group had at a particular moment in time.</p><p>In TypeScript, it might look like:</p><div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name constant" style="color: rgb(130, 170, 255);">CVR</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Map of clientID-&gt;lastMutationID pairs, one for each client in the</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// client group.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationIDs</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> Record</span><span class="token operator" style="color: rgb(137, 221, 255);">&lt;</span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Map of key-&gt;version pairs, one for each entity in the client view.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  entities</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> Record</span><span class="token operator" style="color: rgb(137, 221, 255);">&lt;</span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token operator" style="color: rgb(137, 221, 255);">&gt;</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>One CVR is generated for each pull response and stored in some ephemeral storage. The storage doesn’t need to be durable — if the CVR is lost, the server can just send a reset patch. And the storage doesn’t need to be transactional with the database. Redis is fine.</p><p>The CVRs are stored keyed under a random unique ID which becomes the cookie sent to Replicache.</p><p>During pull, the server uses the cookie to lookup the CVR associated with the previous pull response. It then computes a new CVR for the latest server state and diffs the two CVRs to compute the delta to send to the client.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="schema">Schema<a href="#schema" class="hash-link" aria-label="Direct link to Schema" title="Direct link to Schema">​</a></h2><div class="language-ts codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ts codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">ReplicacheClientGroup</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Same as the Reset Strategy.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">any</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Replicache requires that cookies are ordered within a client group.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// To establish this order we simply keep a counter.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  cvrVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">ReplicacheClient</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Same as the Reset Strategy.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  clientGroupID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">string</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Each of your domain entities will have one extra field.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token keyword" style="font-style: italic;">type</span><span class="token plain"> </span><span class="token class-name" style="color: rgb(255, 203, 107);">Todo</span><span class="token plain"> </span><span class="token operator" style="color: rgb(137, 221, 255);">=</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// ... fields needed for your application (id, title, complete, etc)</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain" style="display: inline-block;"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// Incremented each time this row is updated.</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// In Postgres, there is no need to declare this as Postgres tracks its</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// own per-row version 'xmin' which we can use for this purpose:</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token comment" style="color: rgb(105, 112, 152); font-style: italic;">// https://www.postgresql.org/docs/current/ddl-system-columns.html</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  version</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token builtin" style="color: rgb(130, 170, 255);">number</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="push">Push<a href="#push" class="hash-link" aria-label="Direct link to Push" title="Direct link to Push">​</a></h2><p>The push handler is similar to the Reset Strategy, except for with some modifications to track changes to clients and domain entities. The changes from the Reset Strategy are marked <strong>in bold</strong>.</p><p>Replicache sends a <a href="/reference/server-push#http-request-body"><code>PushRequest</code></a> to the push endpoint. For each mutation described in the request body, the push endpoint should:</p><ol><li><code>let errorMode = false</code></li><li>Begin transaction</li><li><strong><code>getClientGroup(body.clientGroupID)</code>, or default to:</strong></li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  cvrVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">0</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>Verify requesting user owns specified client group.</li><li><code>getClient(mutation.clientID)</code> or default to:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> mutation.clientID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  clientGroupID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">0</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="6"><li>Verify requesting client group owns requested client</li><li><code>let nextMutationID = client.lastMutationID + 1</code></li><li>Rollback transaction and skip mutation if already processed (<code>mutation.id &lt; nextMutationID</code>)</li><li>Rollback transaction and error if mutation from future (<code>mutation.id &gt; nextMutationID</code>)</li><li>If <code>errorMode != true</code> then:<ol><li>Try business logic for mutation<ol><li><strong>Increment <code>version</code> for modified rows</strong></li><li>Note: Soft-deletes <em>not</em> required – you can delete rows normally as part of mutations</li></ol></li><li>If error:<ol><li>Log error</li><li>Abort transaction</li><li>Retry this transaction with <code>errorMode = true</code></li></ol></li></ol></li><li><strong><code>putClientGroup()</code></strong>:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  cvrVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> clientGroup.cvrVersion</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="12"><li><code>putClient()</code>:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> mutation.clientID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  clientGroupID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> nextMutationID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="13"><li>Commit transaction</li></ol><p>After the loop is complete, poke clients to cause them to pull.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pull">Pull<a href="#pull" class="hash-link" aria-label="Direct link to Pull" title="Direct link to Pull">​</a></h2><p>The pull logic is more involved than other strategies because of the need to manage the CVRs.</p><p>Replicache sends a <a href="/reference/server-pull#http-request-body"><code>PullRequest</code></a> to the pull endpoint. The endpoint should:</p><ol><li><code>let prevCVR = getCVR(body.cookie.cvrID)</code></li><li><code>let baseCVR = prevCVR</code> or default to:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token property">"id"</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token string" style="color: rgb(195, 232, 141);">""</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  </span><span class="token property">"entries"</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>Begin transaction</li><li><code>getClientGroup(body.clientGroupID)</code>, or default to:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> body.clientGroupID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  cvrVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token number" style="color: rgb(247, 140, 108);">0</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="5"><li>Verify requesting client group owns requested client.</li><li>Read all id/version pairs from the database that should be in the client view. This query can be any arbitrary function of the DB, including read authorization, paging, etc.</li><li>Read all clients in the client group.</li><li>Build <code>nextCVR</code> from entities and clients.</li><li>Calculate the difference between <code>baseCVR</code> and <code>nextCVR</code></li><li>If prevCVR was found and two CVRs are identical then exit this transaction and return a no-op PullResopnse to client:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  cookie</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> prevCookie</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  lastMutationIDChanges</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  patch</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> </span><span class="token punctuation" style="color: rgb(199, 146, 234);">[</span><span class="token punctuation" style="color: rgb(199, 146, 234);">]</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="11"><li>Fetch all entities from database that are new or changed between <code>baseCVR</code> and <code>nextCVR</code></li><li><code>let clientChanges = clients that are new or changed since baseCVR</code></li><li><code>let nextCVRVersion = Math.max(pull.cookie?.order ?? 0, clientGroup.cvrVersion) + 1</code></li></ol><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_S0QG"><p>It's important to default to the incoming cookie's order because when
Replicache creates a new ClientGroup, it can fork from an existing one,
and we need the order to not go backward.</p></div></div><ol start="14"><li><code>putClientGroup()</code>:</li></ol><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color: #bfc7d5; --prism-background-color: #292d3e;"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token punctuation" style="color: rgb(199, 146, 234);">{</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  id</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> clientGroup.id</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  userID</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> clientGroup.userID</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain">  cvrVersion</span><span class="token operator" style="color: rgb(137, 221, 255);">:</span><span class="token plain"> nextCVRVersion</span><span class="token punctuation" style="color: rgb(199, 146, 234);">,</span><span class="token plain"></span><br></span><span class="token-line" style="color: rgb(191, 199, 213);"><span class="token plain"></span><span class="token punctuation" style="color: rgb(199, 146, 234);">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="15"><li>Commit</li><li><code>let nextCVRID = randomID()</code></li><li><code>putCVR(nextCVR)</code></li><li>Create a <code>PullResponse</code> with:<ol><li>A patch with:<ol><li><code>op:clear</code> if <code>prevCVR === undefined</code></li><li><code>op:put</code> for every created or changed entity</li><li><code>op:del</code> for every deleted entity</li></ol></li><li><code>{order: nextCVRVersion, cvrID}</code> as the cookie.</li><li><code>lastMutationIDChanges</code> with entries for every client that has changed.</li></ol></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h2><p>See <a href="https://github.com/rocicorp/todo-row-versioning" target="_blank" rel="noopener noreferrer">todo-row-versioning</a> for a complete example of this strategy, including sharing and dynamic authorization.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="queries-and-windowing">Queries and Windowing<a href="#queries-and-windowing" class="hash-link" aria-label="Direct link to Queries and Windowing" title="Direct link to Queries and Windowing">​</a></h2><p>The query that builds the client view can change at any time, and can even be per-user. However, slight care must be taken because of the way that Replicache data is shared between tabs. Changing the pull query in one tab changes it for other tabs that are sharing the same Replicache. Without coordination, this could result in two tabs “fighting” over the current query.</p><p>The solution is to sync the current query with Replicache (🤯). That way it will be automatically synced to all tabs.</p><ul><li>Add a new entity to the backend database to store the current query for a profile. Like other entities it should have a <code>version</code> field. Let’s say: <code>/control/&lt;userid&gt;/query</code>.</li><li>When computing the pull, first read this value. If not present, use the default query. Include this entity in the pull response as any other entity.</li><li>In the UI can use the query data in the client view to check and uncheck filter boxes, etc., just like other Replicache data!</li><li>Add mutations that modify this entity.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="variations">Variations<a href="#variations" class="hash-link" aria-label="Direct link to Variations" title="Direct link to Variations">​</a></h2><ul><li>The CVR can be passed into the database as an argument enabling the pull to be computed in a single DB round-trip.</li><li>The CVR can be <strong>stored</strong> in the primary database, allowing the patch to be computed with database joins and dramatically reducing amount of data read from DB.</li><li>The per-row version number can also be a hash over the row serialization, or even a random GUID. These approaches might perform better in some datastores since it eliminates a read of the existing row during write.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rocicorp/replicache/tree/main/doc/docs/strategies/row-version.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/strategies/per-space-version"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Per-Space Version Strategy</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/concepts/how-it-works"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How Replicache Works</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#client-view-records" class="table-of-contents__link toc-highlight">Client View Records</a></li><li><a href="#schema" class="table-of-contents__link toc-highlight">Schema</a></li><li><a href="#push" class="table-of-contents__link toc-highlight">Push</a></li><li><a href="#pull" class="table-of-contents__link toc-highlight">Pull</a></li><li><a href="#example" class="table-of-contents__link toc-highlight">Example</a></li><li><a href="#queries-and-windowing" class="table-of-contents__link toc-highlight">Queries and Windowing</a></li><li><a href="#variations" class="table-of-contents__link toc-highlight">Variations</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hello@replicache.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.replicache.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/replicache" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Rocicorp LLC.</div></div></div></footer></div>
>>>>>>> Stashed changes
=======
<meta name="viewport" content="width=device-width, initial-scale=1.0" data-rh="true"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/4cb8c6ce.419915da.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3e42dbf6.96d57c57.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3afd88c8.0a25afb5.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/99010c58.d24e32c0.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/1340eda5.39f90564.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/481c9a43.53b9451c.js"><link rel="prefetch" href="/assets/js/1be78505.2ff0b744.js"><link rel="prefetch" href="/assets/js/a4df073c.e9e4229e.js"><link rel="prefetch" href="/assets/js/935f2afb.dec4d439.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/59a64286.400d29cd.js"><link rel="prefetch" href="/assets/js/17896441.b90c7a0e.js"><link rel="prefetch" href="/assets/js/3349748a.292d8b30.js"></head>
<body class="navigation-with-keyboard" data-rh="class" style="overflow: visible;">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/replicache.svg" alt="Shiny Replicache Logo" class="themedImage_ToTc themedImage--light_HNdA"></div><b class="navbar__title text--truncate">Replicache Documentation</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/rocicorp/replicache" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Hello, Replicache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Examples</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Build Your Own Backend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true">Backend Strategies</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/strategies/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/reset">Reset Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/global-version">Global Version Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/per-space-version">Per-Space Version Strategy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/strategies/row-version">Row Version Strategy</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Understand Replicache</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a href="#" class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false">How To</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://replicache.notion.site/Replicache-Releases-f86ffef7f72f46ca9b597d5081e05b88" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK">Releases<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Backend Strategies</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Overview</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Backend Strategies</h1><p>Replicache defines abstract <a href="/reference/server-push">push</a> and <a href="/reference/server-pull">pull</a> endpoints that servers must implement to sync. There are a number of possible strategies to implement these endpoints with different tradeoffs.</p><p>The main difference between the strategies is how they calcuate the <code>patch</code> required by the pull endpoint. Different approaches require different state to be stored in the backend database, and different logic in the push and pull endpoints.</p><p>Also some use-cases are only supported well with some strategies. Notably:</p><ul><li><p><strong>Read Auth:</strong> When not all data is accessible to all users. In an application like Google Docs, read authorization is required to implement the fact that a private doc must be shared with you before you can access it.</p></li><li><p><strong>Partial Sync:</strong> When a user only syncs <em>some</em> of the data they have access to. In an application like GitHub, each user has access to many GB of data, but only a small subset of that should be synced to the client at any point in time.</p></li></ul><p>Here are the strategies in increasing order of implementation difficulty:</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-reset-strategy">🤪 Reset Strategy<a href="#-reset-strategy" class="hash-link" aria-label="Direct link to 🤪 Reset Strategy" title="Direct link to 🤪 Reset Strategy">​</a></h2><ul><li><strong>When to use:</strong> For apps with very small amounts of data, or where the data changes infrequently. Also useful for learning Replicache.</li><li><strong>Implementation:</strong> 👍🏼 Easy.</li><li><strong>Performance:</strong> 👎🏼 Each pull computes and retransmits the entire client view.</li><li><strong>Read Auth:</strong> 👍🏼 Easy.</li><li><strong>Partial sync:</strong> 👍🏼 Easy.</li></ul><p><strong><a href="/strategies/reset">Get started with the Reset Strategy →</a></strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-global-version-strategy">🌏 Global Version Strategy<a href="#-global-version-strategy" class="hash-link" aria-label="Direct link to 🌏 Global Version Strategy" title="Direct link to 🌏 Global Version Strategy">​</a></h2><ul><li><strong>When to use:</strong> Simple apps with low concurrency, and where all data is synced to all users.</li><li><strong>Performance:</strong> 👎🏼 Limited to about 50 pushes/second across entire app.</li><li><strong>Implementation:</strong> 👍🏼 Easy.</li><li><strong>Read Auth:</strong> 👎🏼 Difficult.</li><li><strong>Partial sync:</strong> 👎🏼 Difficult.</li></ul><p><strong><a href="/strategies/global-version">Get started with the Global Version Strategy →</a></strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-per-space-version-strategy">🛸 Per-Space Version Strategy<a href="#-per-space-version-strategy" class="hash-link" aria-label="Direct link to 🛸 Per-Space Version Strategy" title="Direct link to 🛸 Per-Space Version Strategy">​</a></h2><ul><li><strong>When to use:</strong> Apps where data can be naturally partitioned into <em>spaces</em>, where all users in a space sync that space in its entirety. For example, in an app like GitHub, each repository might be a space.</li><li><strong>Performance:</strong> 🤷‍♂️ Limited to about 50 pushes/second/space.</li><li><strong>Implementation:</strong> 👍🏼 Easy.</li><li><strong>Read Auth:</strong> 🤷‍♂️ You can restrict access to a space to certain users, but all users within a space see everything in that space.</li><li><strong>Partial sync:</strong> 🤷‍♂️ You can choose which spaces to sync to each client, but within a space all data is synced.</li></ul><p><strong><a href="/strategies/per-space-version">Get started with the Per-Space Version Strategy →</a></strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="️-row-version-strategy">🚣‍♀️ Row Version Strategy<a href="#️-row-version-strategy" class="hash-link" aria-label="Direct link to 🚣‍♀️ Row Version Strategy" title="Direct link to 🚣‍♀️ Row Version Strategy">​</a></h2><ul><li><strong>When to use:</strong> Apps that need greater performance, fine-grained read authorization, or partial sync that can't be served by per-space versioning. This is the most flexible and powerful strategy, but also the hardest to implement.</li><li><strong>Performance:</strong> 👍🏼 Close to traditional web app.</li><li><strong>Implementation:</strong> 👎🏼 Most difficult.</li><li><strong>Read Auth:</strong> 👍🏼 Fully supported. Each individual data item can be authorized based on arbitrary code.</li><li><strong>Partial sync:</strong> 👍🏼 Fully supported. Sync any arbitrary subset of the database based on any logic you like.</li></ul><p><strong><a href="/strategies/row-version">Get started with the Row Version Strategy →</a></strong></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rocicorp/replicache/tree/main/doc/docs/strategies/overview.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/byob/next"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Conclusion</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/strategies/reset"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Reset Strategy</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#-reset-strategy" class="table-of-contents__link toc-highlight">🤪 Reset Strategy</a></li><li><a href="#-global-version-strategy" class="table-of-contents__link toc-highlight">🌏 Global Version Strategy</a></li><li><a href="#-per-space-version-strategy" class="table-of-contents__link toc-highlight">🛸 Per-Space Version Strategy</a></li><li><a href="#️-row-version-strategy" class="table-of-contents__link toc-highlight">🚣‍♀️ Row Version Strategy</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hello@replicache.dev" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.replicache.dev/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/replicache" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Rocicorp LLC.</div></div></div></footer></div>
>>>>>>> Stashed changes
<script src="/assets/js/runtime~main.ca11e309.js"></script>
<script src="/assets/js/main.6abc1f11.js"></script>

</body></html>